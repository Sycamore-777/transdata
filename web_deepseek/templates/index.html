<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>目标检测与意图识别演示系统</title>
    <!-- 离线模式：使用本地资源 -->
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <script src="/static/js/chart.min.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <style>


        :root {
            --primary-color: #0f9d58; /* 科技绿 */
            --secondary-color: #4285f4; /* 科技蓝 */
            --accent-color: #f4b400; /* 科技黄 */
            --dark-bg: #0a1929; /* 深色背景 */
            --card-bg: #1a2a3a; /* 卡片背景 */
            --text-light: #e0f2fe; /* 浅色文本 */
            --text-gray: #a0aec0; /* 灰色文本 */
            --border-color: #2d3748; /* 边框颜色 */
        }

        /* 拖拽分隔条样式 */
        .resize-handle {
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s ease;
            width: 4px;
            min-width: 4px;
            max-width: 4px;
        }

        .resize-handle:hover {
            background: var(--primary-color);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: currentColor;
            border-radius: 1px;
            opacity: 0.6;
        }

        .resize-handle.resizing {
            background: var(--primary-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0c1a29 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            margin: 0;
        }
        
        /* 头部样式 */
        .header {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 15px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(15, 157, 88, 0.3);
            letter-spacing: 1px;
        }
        
        .header p {
            color: var(--text-gray);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* 主容器 */
        .container {
            display: flex;
            gap: 0; /* 移除gap，使用分隔条 */
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
            height: calc(100vh - 120px);
            min-height: 400px; /* 最小高度 */
            max-height: 200vh; /* 最大高度 */
            overflow: auto; /* 超出时显示滚动条 */
            transition: height 0.1s ease; /* 平滑过渡 */
            position: relative;
        }
        
        /* 左侧面板 - 问答区域 */
        .panel-left {
            flex: 1;
            min-width: 500px;
            background: rgba(26, 42, 58, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(66, 133, 244, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
            min-height: 500px;
        }
        
        /* 右侧面板 - 动态展示区 */
        .panel-right {
            width: 45%;
            min-width: min(300px, 30vw); /* 根据视口动态调整最小宽度 */
            max-width: calc(100vw - 320px); /* 确保不超出视口 */
            background: rgba(26, 42, 58, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(66, 133, 244, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: min(500px, 60vh); /* 根据视口动态调整最小高度 */
            z-index: 10;
            overflow: hidden; /* 防止内容溢出 */
        }
        
        /* 面板标题 */
        .panel-title {
            padding: 6px 8px; /* 大幅减小内边距 */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* 拖拽指针 */
            user-select: none; /* 防止文本选择 */
            flex-wrap: wrap;
            gap: 4px; /* 大幅减小间距 */
            position: sticky; /* 改为粘性定位 */
            top: 0; /* 粘在顶部 */
            z-index: 100; /* 确保标题栏在最上层 */
            background: rgba(26, 42, 58, 0.95); /* 增加背景透明度确保可见性 */
            backdrop-filter: blur(10px); /* 添加模糊效果 */
            flex-shrink: 0; /* 防止标题被压缩 */
            font-size: 0.75rem; /* 大幅减小字体 */
            min-height: 32px; /* 设置最小高度 */
        }
        
        .title-left, .title-center, .title-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 确保聊天模式切换按钮始终可见 */
        .chat-mode-switch {
            display: flex;
            gap: 5px;
            flex-shrink: 0; /* 防止按钮被压缩 */
        }

        .mode-btn {
            white-space: nowrap; /* 防止按钮文字换行 */
            min-width: 80px; /* 设置最小宽度 */
        }

        .title-left {
            flex: 1;
            flex-direction: column;
            align-items: flex-start;
        }

        .title-center {
            flex: 0 0 auto;
        }

        .title-right {
            flex: 0 0 auto;
        }

        .panel-title h2 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .panel-title h2 i {
            color: var(--secondary-color);
        }

        .model-info {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 5px;
        }
        
        /* 模型选择区域 */
        .model-selector {
            padding: 15px 20px;
            background: rgba(15, 157, 88, 0.1);
            border-bottom: 1px solid var(--border-color);
        }
        
        .model-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .model-controls select {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            min-width: 200px;
        }
        
        .model-controls input {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            min-width: 200px;
        }
        
        .model-controls button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .model-controls button:hover {
            background: #0d8a4d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(15, 157, 88, 0.3);
        }
        
        /* API 配置模态框 */
        .api-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .api-config-modal.active {
            display: flex;
        }

        .api-config {
            background: var(--dark-bg);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .api-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .api-config-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .api-config-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .api-config-close:hover {
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .api-input {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .api-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .api-input label {
            width: 150px;
            font-weight: 500;
            color: var(--text-gray);
        }
        
        .api-input input {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .api-input button {
            padding: 10px 20px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .api-input button:hover {
            background: #3b78e7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        .api-status {
            font-size: 0.9rem;
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(26, 42, 58, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .api-status i {
            color: #f44336; /* 默认红色 */
        }
        
        .api-status.valid i {
            color: var(--primary-color); /* 验证通过绿色 */
        }
        
        /* 聊天区域 */
        .chat-area {
            flex: 1;
            padding: 5px; /* 大幅减小内边距 */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px; /* 大幅减小间距 */
            position: relative;
            min-height: 150px; /* 大幅减小最小高度 */
            /* 改进滚动体验 */
            scroll-behavior: smooth; /* 平滑滚动 */
            scrollbar-width: thin; /* Firefox 细滚动条 */
            scrollbar-color: var(--primary-color) transparent; /* Firefox 滚动条颜色 */
        }

        /* Webkit 浏览器滚动条样式 */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* 自定义拖拽区域样式 */
        .chat-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(-45deg, transparent 0%, transparent 30%, var(--secondary-color) 30%, var(--secondary-color) 35%, transparent 35%, transparent 65%, var(--secondary-color) 65%, var(--secondary-color) 70%, transparent 70%);
            cursor: nw-resize;
            z-index: 10;
        }

        .chat-resize-handle:hover {
            background: linear-gradient(-45deg, transparent 0%, transparent 30%, var(--primary-color) 30%, var(--primary-color) 35%, transparent 35%, transparent 65%, var(--primary-color) 65%, var(--primary-color) 70%, transparent 70%);
        }

        /* 图片上传区域样式 */
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: var(--secondary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .image-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(15, 157, 88, 0.1);
        }

        /* 图片预览样式 */
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        /* 图片信息显示 */
        .image-info {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 5px;
        }

        /* 图片缩放控制 */
        .image-controls {
            display: flex;
            gap: 2px; /* 最小化按钮间距 */
            justify-content: center;
            margin: 1px 0; /* 最小化上下边距 */
            flex-shrink: 0; /* 防止按钮被压缩 */
            padding: 0; /* 移除内边距 */
            position: absolute; /* 绝对定位，不占用布局空间 */
            bottom: 5px; /* 距离底部5px */
            left: 50%; /* 水平居中 */
            transform: translateX(-50%); /* 完成居中 */
            z-index: 10; /* 确保在图片上方 */
            background: rgba(0, 0, 0, 0.7); /* 半透明背景 */
            border-radius: 15px; /* 圆角背景 */
            padding: 3px 8px; /* 背景内边距 */
        }

        .image-controls button {
            padding: 2px 4px; /* 最小化按钮内边距 */
            background: transparent; /* 透明背景 */
            color: white; /* 白色文字 */
            border: none;
            border-radius: 2px; /* 最小化圆角 */
            cursor: pointer;
            font-size: 0.6rem; /* 进一步减小字体 */
            min-height: 16px; /* 减小最小高度 */
            line-height: 1; /* 紧凑行高 */
        }

        .image-controls button:hover {
            background: rgba(255, 255, 255, 0.2); /* 悬停时的背景 */
        }



        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--accent-color);
        }

        /* 附件预览样式 */
        .attachment-preview {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-item i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .attachment-item .remove-attachment {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 2px;
        }

        .attachment-item .remove-attachment:hover {
            color: #f44336;
        }

        /* 附件按钮样式 */
        #attachment-btn {
            padding: 0 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #attachment-btn:hover {
            background: #e6a700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 180, 0, 0.3);
        }

        /* 聊天模式切换按钮样式 */
        .chat-mode-switch {
            display: flex;
            gap: 5px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            background: transparent;
            color: var(--text-gray);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: rgba(66, 133, 244, 0.2);
            color: var(--text-light);
        }

        .mode-btn.active {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        /* iframe容器样式 */
        .iframe-container {
            flex: 1;
            display: none;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 400px;
            /* 移除max-height限制，让它自然适应容器 */
        }
        
        .iframe-container.active {
            display: flex;
            flex-direction: column;
        }
        
        .iframe-container iframe {
            width: 100%;
            flex: 1;
            border: none;
            background: var(--card-bg);
            border-radius: 10px;
        }



        /* 本地聊天区域 */
        .local-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* 防止内容溢出 */
        }

        .local-chat-container.hidden {
            display: none;
        }
        
        .message {
            display: flex;
            gap: 6px; /* 大幅减小间距 */
            animation: fadeIn 0.3s ease;
            margin-bottom: 4px; /* 大幅减小消息间距 */
        }

        .message-avatar {
            width: 24px; /* 大幅减小头像尺寸 */
            height: 24px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.65rem; /* 大幅减小头像内图标尺寸 */
        }
        
        .user .message-avatar {
            background: var(--accent-color);
        }
        
        .message-content {
            flex: 1;
            padding: 6px 8px; /* 大幅减小内边距 */
            border-radius: 6px; /* 大幅减小圆角 */
            background: var(--card-bg);
            line-height: 1.3; /* 大幅减小行高 */
            font-size: 0.8rem; /* 大幅减小字体 */
        }
        
        .user .message-content {
            background: rgba(66, 133, 244, 0.15);
            border: 1px solid rgba(66, 133, 244, 0.3);
        }
        
        /* 输入区域 */
        .input-area {
            padding: 6px 8px; /* 大幅减小内边距 */
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            display: flex;
            gap: 6px; /* 大幅减小间距 */
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            padding: 6px 8px; /* 大幅减小内边距 */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px; /* 大幅减小圆角 */
            color: var(--text-light);
            font-size: 0.75rem; /* 大幅减小字体 */
            height: 28px; /* 设置固定高度 */
        }

        .input-container button {
            padding: 6px 12px; /* 大幅减小内边距 */
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px; /* 大幅减小圆角 */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.75rem; /* 大幅减小字体 */
            height: 28px; /* 设置固定高度 */
        }
        
        .input-container button:hover {
            background: #3b78e7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        /* 动态展示区控制 */
        .dashboard-controls {
            display: flex;
            gap: 6px; /* 大幅减小间距 */
            margin-bottom: 8px; /* 大幅减小外边距 */
        }

        .dashboard-controls button {
            flex: 1;
            padding: 6px 4px; /* 大幅减小内边距 */
            background: rgba(66, 133, 244, 0.2);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 4px; /* 减小圆角 */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* 减小间距 */
            font-size: 0.7rem; /* 大幅减小字体 */
            min-height: 28px; /* 设置最小高度 */
        }

        .dashboard-controls button:hover {
            background: rgba(66, 133, 244, 0.4);
            transform: translateY(-1px); /* 减小悬停效果 */
        }
        
        /* 卡片容器 */
        .cards-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* 增大最小宽度 */
            grid-auto-rows: minmax(300px, auto); /* 大幅增大最小高度 */
            gap: 10px; /* 增加间距防止重叠 */
            overflow-y: auto;
            overflow-x: hidden; /* 防止水平溢出 */
            padding: 8px; /* 增加容器内边距 */
            align-content: start;
            /* 防止卡片重叠的关键设置 */
            grid-auto-flow: row; /* 确保卡片按行排列 */
            align-items: start; /* 卡片顶部对齐 */
            /* 强制网格布局，防止重叠 */
            grid-template-rows: repeat(auto-fit, minmax(300px, auto));
        }
        
        /* 卡片样式 */
        .card {
            background: var(--card-bg);
            border-radius: 6px; /* 大幅减小圆角 */
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* 大幅减小阴影 */
            display: flex;
            flex-direction: column;
            resize: both; /* 允许拖拽调整大小 */
            min-width: 200px; /* 增大最小宽度 */
            min-height: 300px; /* 大幅增大最小高度 */
            /* 大幅增大最大尺寸限制 */
            max-width: min(1600px, 95vw); /* 增大到1600px或95%视口宽度 */
            max-height: min(1200px, 90vh); /* 增大到1200px或90%视口高度 */
            position: relative; /* 为拖拽手柄定位 */
            contain: layout; /* 防止内容溢出影响布局 */
            /* 防止重叠的关键设置 */
            z-index: 1; /* 确保卡片在正确的层级 */
            isolation: isolate; /* 创建新的堆叠上下文 */
            /* 强制网格对齐，防止重叠 */
            grid-column: auto;
            grid-row: auto;
            align-self: start;
            justify-self: start;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(15, 157, 88, 0.3);
            border-color: rgba(15, 157, 88, 0.5);
            z-index: 10; /* 悬停时提升层级 */
        }

        /* 卡片resize时的样式 */
        .card:active,
        .card:focus-within {
            z-index: 20; /* resize时提升到最高层级 */
        }

        /* 防止卡片resize时超出容器 */
        .cards-container .card {
            box-sizing: border-box;
            margin: 0; /* 确保没有额外的外边距 */
        }
        
        .card-header {
            padding: 2px 4px; /* 最小化内边距 */
            background: rgba(15, 157, 88, 0.1);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 18px; /* 进一步减小最小高度 */
            height: 18px; /* 固定高度 */
            flex-shrink: 0; /* 防止标题被压缩 */
            box-sizing: border-box;
        }

        .card-title {
            font-size: 0.75rem; /* 大幅减小字体 */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px; /* 大幅减小间距 */
            line-height: 1.2;
        }
        
        .card-actions button {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 2px; /* 减小按钮内边距 */
            font-size: 0.7rem; /* 减小按钮字体 */
            width: 20px; /* 设置固定宽度 */
            height: 20px; /* 设置固定高度 */
        }

        .card-actions button:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .card-content {
            flex: 1;
            height: 100%; /* 确保内容区域填充整个可用空间 */
            padding: 0; /* 完全移除内边距 */
            margin: 0; /* 完全移除外边距 */
            display: flex;
            flex-direction: column;
            font-size: 0.7rem; /* 大幅减小字体 */
            line-height: 1.2;
            overflow: hidden; /* 防止内容溢出 */
        }
        
        .chart-container {
            width: 100%;
            height: 180px;
        }
        
        .image-container {
            width: 100%;
            height: 100%; /* 确保容器填充整个可用空间 */
            flex: 1; /* 让图片容器占据卡片的大部分空间 */
            display: flex; /* 使用flex布局以便图片居中 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            overflow: hidden;
            margin: 0; /* 移除外边距 */
            padding: 0; /* 移除内边距 */
            position: relative; /* 为绝对定位的控制按钮提供定位上下文 */
            box-sizing: border-box; /* 确保边框不影响尺寸 */
            background: #f8f9fa; /* 添加浅色背景，便于看清图片边界 */
        }

        .image-container img {
            max-width: 100%; /* 最大宽度不超过容器 */
            max-height: 100%; /* 最大高度不超过容器 */
            width: auto; /* 自动宽度以保持比例 */
            height: auto; /* 自动高度以保持比例 */
            display: block; /* 确保图片为块级元素 */
            margin: 0 !important; /* 强制移除所有外边距 */
            padding: 0 !important; /* 强制移除所有内边距 */
            border: none !important; /* 移除边框 */
            border-radius: 4px; /* 恢复轻微圆角 */
            object-fit: contain; /* 显示完整图片 */
            object-position: center; /* 居中显示 */
            transition: transform 0.3s ease;
            box-sizing: border-box; /* 确保边框不影响尺寸 */
        }

        /* 图片悬停效果 */
        .image-container:hover img {
            transform: scale(1.05);
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-enter {
            animation: fadeIn 0.4s ease;
        }
        
        /* 响应式设计 - 增强版 */
        @media (max-width: 1600px) {
            .panel-right {
                width: 42%;
                min-width: min(280px, 25vw);
            }

            .card {
                max-width: min(1400px, 90vw);
                max-height: min(1000px, 85vh);
            }
        }

        @media (max-width: 1400px) {
            .container {
                padding: 0 5px;
            }

            .panel-right {
                width: 40%;
                min-width: min(250px, 22vw);
            }

            .card {
                max-width: min(1200px, 88vw);
                max-height: min(900px, 80vh);
            }
        }

        @media (max-width: 1200px) {
            .panel-right {
                width: 38%;
                min-width: min(220px, 20vw);
            }

            .card {
                max-width: min(1000px, 85vw);
                max-height: min(800px, 75vh);
            }
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
                gap: 10px;
            }

            .panel-left, .panel-right {
                width: 100%;
                min-width: auto;
                height: auto;
                min-height: 400px;
            }

            .panel-left {
                order: 1;
            }

            .panel-right {
                order: 2;
                max-height: 500px;
            }

            .api-input-row {
                flex-direction: column;
                align-items: stretch;
            }

            .api-input label {
                width: auto;
                margin-bottom: 5px;
            }

            .model-controls {
                flex-direction: column;
            }

            .chat-area {
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 10px 0;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .panel-title {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .title-left, .title-center, .title-right {
                justify-content: center;
            }

            .chat-mode-switch {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(26, 42, 58, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3b78e7;
        }
        
        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 图片更新通知动画 */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* 监控状态样式 */
        .monitoring-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .monitoring-status i {
            font-size: 8px;
        }

        /* 滚动指示器样式 */
        #chat-scroll-indicator {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* 图片容器悬停效果 */
        .image-container:hover .image-preview {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }

        /* 图片加载状态样式 */
        .image-loading, .image-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: var(--text-gray);
            gap: 10px;
        }

        .image-loading i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .image-error i {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .image-error button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .image-error button:hover {
            background: var(--secondary-color);
        }

        /* 文本预览样式 */
        .text-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .text-preview pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .text-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .text-controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .text-controls button:hover {
            background: var(--secondary-color);
        }

        /* 文件预览样式 */
        .file-preview {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .file-icon {
            margin-bottom: 15px;
        }

        /* 文本模态框样式 */
        .text-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .text-modal-content {
            background: var(--dark-bg);
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .text-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-modal-header h3 {
            margin: 0;
            color: var(--text-light);
        }

        .text-modal-header button {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .text-modal-header button:hover {
            color: var(--text-light);
        }

        .text-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .text-modal-body pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-light);
        }

        /* 通知样式 */
        .notification {
            font-size: 0.9rem;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .notification-header i {
            font-size: 1.1rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px;
            margin-left: auto;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-details {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-details div {
            margin: 2px 0;
        }
        
        /* 模型状态标签 */
        .model-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .model-status.connected {
            background: rgba(15, 157, 88, 0.2);
            color: var(--primary-color);
        }
        
        /* 设置按钮 */
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 6px; /* 减小内边距 */
            border-radius: 50%;
            margin-left: 3px; /* 按钮间距 */
            font-size: 0.9rem; /* 稍微减小图标大小 */
        }

        .settings-btn:hover {
            color: var(--secondary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .title-right {
            display: flex;
            align-items: center;
            gap: 2px; /* 按钮组间距 */
        }

        /* 高度调整指示器 */
        .height-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .height-indicator.show {
            opacity: 1;
        }
        
        /* 模型连接信息 */
        .model-connection-info {
            margin-top: 10px;
            padding: 15px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .model-connection-info h4 {
            margin-bottom: 10px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-model-input {
            display: none;
            margin-top: 10px;
        }
        
        .custom-model-input.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <div class="header">
        <h1><span class="icon">🤖</span> 目标检测与意图识别演示系统</h1>
    </div>
    
    <div class="container">
        <!-- 左侧面板：问答区域 -->
        <div class="panel-left" id="panel-left">
            <div class="panel-title">
                <div class="title-left">
                    <h2 id="panel-title-text"><i class="fas fa-comments"></i> 智能问答系统</h2>
                    <div class="model-info">当前模型: <span id="current-model">未配置</span> <span class="model-status" id="model-status">未连接</span></div>
                </div>
                <div class="title-center">
                    <div class="chat-mode-switch">
                        <button id="local-chat-btn" class="mode-btn active">本地问答</button>
                        <button id="iframe-chat-btn" class="mode-btn">外部聊天</button>
                    </div>
                </div>
                <div class="title-right">
                    <button class="settings-btn" id="clear-chat-btn" title="清空聊天记录"><i class="fas fa-broom"></i></button>
                    <button class="settings-btn" id="api-settings-btn" title="API设置"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            

            
            <!-- 本地聊天容器 -->
            <div class="local-chat-container" id="local-chat-container">
                <div class="model-selector">
                    <div class="model-controls">
                        <select id="model-select">
                            <option value="default">使用默认模型</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="custom">自定义模型</option>
                        </select>
                        
                        <div class="custom-model-input" id="custom-model-input">
                            <input type="text" id="custom-model-name" placeholder="输入模型名称（如：my-custom-model）">
                        </div>
                        
                        <button id="model-save"><i class="fas fa-sync-alt"></i> 应用模型</button>
                    </div>
                </div>
                
                <div class="chat-area" id="chat-area">
                    <!-- 消息将在这里动态添加 -->
                    <div class="message system">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <h3>欢迎使用目标检测与意图识别演示系统！</h3>
                            <p><strong>使用步骤：</strong></p>
                            <ol>
                                <li>点击右上角 <i class="fas fa-cog"></i> 图标配置API服务</li>
                                <li>输入API基础地址、密钥和默认模型名称</li>
                                <li>在下拉菜单中选择或输入要使用的模型</li>
                                <li>在下方输入问题开始对话</li>
                            </ol>
                            <p>右侧仪表盘可添加可视化卡片，展示检测结果和分析数据。</p>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <input type="text" id="user-input" placeholder="输入您的问题，例如：如何提高目标检测的准确率？">
                        <input type="file" id="attachment-input" accept="image/*,text/*,.pdf,.doc,.docx" style="display: none;" multiple>
                        <button id="attachment-btn" title="上传附件"><i class="fas fa-paperclip"></i></button>
                        <button id="send-btn"><i class="fas fa-paper-plane"></i> 发送</button>
                    </div>
                    <div id="attachment-preview" class="attachment-preview"></div>
                </div>
            </div>

            <!-- iframe聊天容器 -->
            <div class="iframe-container" id="iframe-container">
                <iframe
                    src="http://localhost/chatbot/40RIQ28SQ21P3Ync"
                    frameborder="0"
                    allow="microphone">
                </iframe>
            </div>
        </div>

        <!-- 拖拽分隔条 -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- 右侧面板：动态展示区 -->
        <div class="panel-right" id="panel-right">
            <div class="panel-title">
                <h2><i class="fas fa-chart-line"></i> 分析仪表盘</h2>
                <div class="card-count">卡片: <span id="card-count">3</span></div>
            </div>
            
            <div class="dashboard-controls">
                <button id="add-chart-btn"><i class="fas fa-chart-bar"></i> 添加图表</button>
                <button id="add-image-btn"><i class="fas fa-image"></i> 添加图片</button>
                <button id="test-image-btn"><i class="fas fa-vial"></i> 测试图片</button>
                <button id="test-monitor-btn"><i class="fas fa-eye"></i> 测试监控</button>
                <button id="test-upload-btn"><i class="fas fa-upload"></i> 测试上传</button>
                <button id="clear-cards-btn"><i class="fas fa-trash-alt"></i> 清空卡片</button>
            </div>
            
            <div class="cards-container" id="cards-container">
                <!-- 卡片将在这里动态添加 -->
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-microchip"></i> 模型分布</div>
                        <div class="card-actions">
                            <!-- 卡片移除功能 - 已恢复 -->
                            <button class="delete-card" title="删除卡片"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="modelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-camera"></i> 检测结果</div>
                        <div class="card-actions">
                            <!-- 卡片移除功能 - 已恢复 -->
                            <button class="delete-card" title="删除卡片"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="image-container">
                            <img src="https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80" alt="目标检测示例">
                        </div>
                    </div>
                </div>
                
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-bolt"></i> 性能对比</div>
                        <div class="card-actions">
                            <!-- 卡片移除功能 - 已恢复 -->
                            <button class="delete-card" title="删除卡片"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 配置模态框 -->
    <div class="api-config-modal" id="api-config-modal">
        <div class="api-config">
            <div class="api-config-header">
                <div class="api-config-title">
                    <i class="fas fa-cog"></i> API 配置
                </div>
                <button class="api-config-close" onclick="closeApiConfig()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="api-input">
                <div class="api-input-row">
                    <label for="api-base-input"><i class="fas fa-link"></i> API基础地址:</label>
                    <input type="text" id="api-base-input" placeholder="https://api.openai.com/v1">
                </div>

                <div class="api-input-row">
                    <label for="api-key-input"><i class="fas fa-key"></i> API密钥:</label>
                    <input type="password" id="api-key-input" placeholder="sk-xxxxxxxxxxxxxxxx">
                </div>

                <div class="api-input-row">
                    <label for="api-model-input"><i class="fas fa-microchip"></i> 默认模型:</label>
                    <input type="text" id="api-model-input" placeholder="gpt-3.5-turbo">
                </div>

                <button id="save-api-btn"><i class="fas fa-save"></i> 保存API配置</button>
            </div>

            <div class="api-status" id="api-status">
                <i class="fas fa-circle"></i> API配置未保存
            </div>

            <div class="model-connection-info">
                <h4><i class="fas fa-info-circle"></i> 配置说明</h4>
                <p>完整的OpenAI兼容接口配置需要以下信息：</p>
                <ul>
                    <li><strong>API基础地址</strong>：模型服务的端点URL（如：https://api.openai.com/v1）</li>
                    <li><strong>API密钥</strong>：访问API的认证密钥（如：sk-xxxxxxxx）</li>
                    <li><strong>模型名称</strong>：要使用的具体模型名称（如：gpt-4、gpt-3.5-turbo等）</li>
                </ul>
                <p>系统支持以下兼容服务：</p>
                <ul>
                    <li>OpenAI官方API</li>
                    <li>Azure OpenAI服务</li>
                    <li>本地部署的OpenAI兼容服务</li>
                    <li>其他兼容OpenAI接口的API服务</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 高度调整指示器 -->
    <div class="height-indicator" id="height-indicator">
        <div>页面高度调整</div>
        <div>按住 Ctrl + 滚轮调整</div>
        <div id="height-value">高度: 100%</div>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化面板拖拽功能
            setupPanelResize();

            // 初始化聊天框拖拽功能
            setupChatAreaResize();

            // 初始化聊天滚轮控制
            setupChatScrollControl();

            // 初始化卡片尺寸监控
            setupCardSizeMonitoring();

            // 初始化响应式布局
            setupResponsiveLayout();

            // 初始化页面高度调整
            setupPageHeightAdjustment();

            // 显示功能提示
            setTimeout(() => {
                showNotification('💡 提示: 按住 Ctrl + 滚轮可调整页面高度，Ctrl + 0 重置', 'info', {
                    autoHide: true,
                    duration: 4000
                });
            }, 2000);

            setTimeout(() => {
                showNotification('🖼️ 卡片现在支持更大尺寸！拖拽右下角可放大至1600x1200', 'success', {
                    autoHide: true,
                    duration: 4000
                });
            }, 6000);

            // 初始化图表
            initCharts();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 初始化卡片计数
            updateCardCount();
            
            // 检查本地存储中是否有API配置
            checkSavedApiConfig();
            
            // 检查保存的模型配置
            checkSavedModelConfig();
            
            // 启动图片监控
            setupImageMonitoring();
        });
        
        // 初始化图表
        function initCharts() {
            // 模型分布图表
            const distributionCtx = document.getElementById('modelDistributionChart').getContext('2d');
            new Chart(distributionCtx, {
                type: 'pie',
                data: {
                    labels: ['视觉模型', '语言模型', '多模态模型'],
                    datasets: [{
                        data: [45, 35, 20],
                        backgroundColor: [
                            'rgba(66, 133, 244, 0.8)',
                            'rgba(15, 157, 88, 0.8)',
                            'rgba(244, 180, 0, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0f2fe',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            // 性能对比图表
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['YOLOv8', 'Faster R-CNN', 'SSD', 'RetinaNet'],
                    datasets: [{
                        label: '准确率 (%)',
                        data: [85, 82, 79, 81],
                        backgroundColor: 'rgba(15, 157, 88, 0.7)',
                        borderColor: 'rgba(15, 157, 88, 1)',
                        borderWidth: 1
                    }, {
                        label: '速度 (FPS)',
                        data: [120, 45, 95, 60],
                        backgroundColor: 'rgba(66, 133, 244, 0.7)',
                        borderColor: 'rgba(66, 133, 244, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(45, 55, 72, 0.5)'
                            },
                            ticks: {
                                color: '#a0aec0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0aec0'
                            }
                        }
                    }
                }
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 发送消息按钮
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            // 输入框回车发送
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 模型保存按钮
            document.getElementById('model-save').addEventListener('click', saveModel);
            
            // 添加图表按钮
            document.getElementById('add-chart-btn').addEventListener('click', addChartCard);
            
            // 添加图片按钮
            document.getElementById('add-image-btn').addEventListener('click', addImageCard);

            // 测试图片按钮
            document.getElementById('test-image-btn').addEventListener('click', testImageLoad);

            // 测试监控按钮
            document.getElementById('test-monitor-btn').addEventListener('click', testImageMonitor);

            // 测试上传按钮
            document.getElementById('test-upload-btn').addEventListener('click', testImageUpload);

            // 清空卡片按钮
            document.getElementById('clear-cards-btn').addEventListener('click', clearCards);
            
            // 删除卡片事件委托 - 已恢复
            document.getElementById('cards-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-card') ||
                    e.target.parentElement.classList.contains('delete-card')) {
                    const card = e.target.closest('.card');

                    // 添加确认对话框
                    if (confirm('确定要删除这个卡片吗？')) {
                        card.classList.add('fade-out');
                        setTimeout(() => {
                            card.remove();
                            updateCardCount();
                            showNotification('卡片已删除', 'success');
                        }, 300);
                    }
                }
            });
            
            // API设置按钮
            const apiSettingsBtn = document.getElementById('api-settings-btn');
            if (apiSettingsBtn) {
                console.log('API设置按钮找到，绑定事件监听器');
                apiSettingsBtn.addEventListener('click', function(e) {
                    console.log('API设置按钮被点击');
                    e.preventDefault();
                    e.stopPropagation();
                    toggleApiConfig();
                });
            } else {
                console.error('找不到 API设置按钮');
            }
            
            // 保存API配置按钮
            document.getElementById('save-api-btn').addEventListener('click', saveApiConfig);
            
            // 模型选择变化事件
            document.getElementById('model-select').addEventListener('change', function() {
                const customModelInput = document.getElementById('custom-model-input');
                if (this.value === 'custom') {
                    customModelInput.classList.add('active');
                } else {
                    customModelInput.classList.remove('active');
                }
            });

            // API模型选择变化事件
            document.getElementById('api-model-input').addEventListener('change', function() {
                const customApiModelRow = document.getElementById('custom-api-model-row');
                if (this.value === 'custom') {
                    customApiModelRow.style.display = 'flex';
                } else {
                    customApiModelRow.style.display = 'none';
                }
            });

            // 附件上传按钮
            document.getElementById('attachment-btn').addEventListener('click', function() {
                document.getElementById('attachment-input').click();
            });

            // 附件选择事件
            document.getElementById('attachment-input').addEventListener('change', function(e) {
                handleAttachments(e.target.files);
            });
            
            // 聊天模式切换按钮事件
            document.getElementById('local-chat-btn').addEventListener('click', () => switchChatMode('local'));
            document.getElementById('iframe-chat-btn').addEventListener('click', () => switchChatMode('iframe'));

            // 清空聊天记录按钮事件
            document.getElementById('clear-chat-btn').addEventListener('click', clearChatHistory);

            // API配置模态框背景点击关闭
            document.getElementById('api-config-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApiConfig();
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('api-config-modal');
                    if (modal && modal.classList.contains('active')) {
                        closeApiConfig();
                    }
                }
            });
            

        }
        
        // 检查本地存储中是否有API配置
        function checkSavedApiConfig() {
            const savedApiBase = localStorage.getItem('api_base');
            const savedApiKey = localStorage.getItem('api_key');
            const savedApiModel = localStorage.getItem('api_model');
            
            if (savedApiBase) {
                document.getElementById('api-base-input').value = savedApiBase;
            }
            
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
            
            if (savedApiModel) {
                document.getElementById('api-model-input').value = savedApiModel;
            }
            
            if (savedApiBase || savedApiKey || savedApiModel) {
                validateApiConfig(savedApiBase, savedApiKey, savedApiModel);
            }
        }
        
        // 检查保存的模型配置
        function checkSavedModelConfig() {
            const savedModel = localStorage.getItem('current_model');
            if (savedModel) {
                document.getElementById('current-model').textContent = savedModel;
            }
        }
        
        // 打开API配置模态框
        function toggleApiConfig() {
            console.log('toggleApiConfig 被调用');
            const apiConfigModal = document.getElementById('api-config-modal');
            if (!apiConfigModal) {
                console.error('找不到 api-config-modal 元素');
                return;
            }

            console.log('打开API配置模态框');
            apiConfigModal.classList.add('active');

            // 聚焦到第一个输入框
            setTimeout(() => {
                const firstInput = apiConfigModal.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        // 关闭API配置模态框
        function closeApiConfig() {
            console.log('关闭API配置模态框');
            const apiConfigModal = document.getElementById('api-config-modal');
            if (apiConfigModal) {
                apiConfigModal.classList.remove('active');
            }
        }

        // 切换聊天模式
        function switchChatMode(mode) {
            const localContainer = document.getElementById('local-chat-container');
            const iframeContainer = document.getElementById('iframe-container');
            const localBtn = document.getElementById('local-chat-btn');
            const iframeBtn = document.getElementById('iframe-chat-btn');
            const panelTitle = document.getElementById('panel-title-text');

            if (mode === 'local') {
                localContainer.classList.remove('hidden');
                iframeContainer.classList.remove('active');
                localBtn.classList.add('active');
                iframeBtn.classList.remove('active');
                panelTitle.innerHTML = '<i class="fas fa-comments"></i> 智能问答系统';
            } else if (mode === 'iframe') {
                localContainer.classList.add('hidden');
                iframeContainer.classList.add('active');
                localBtn.classList.remove('active');
                iframeBtn.classList.add('active');
                panelTitle.innerHTML = '<i class="fas fa-external-link-alt"></i> 外部聊天机器人';
            }
        }

        // 清空聊天记录
        function clearChatHistory() {
            if (confirm('确定要清空所有聊天记录吗？此操作不可撤销。')) {
                const chatArea = document.getElementById('chat-area');

                // 保留欢迎消息，清除其他消息
                const welcomeMessage = chatArea.querySelector('.message.system');
                chatArea.innerHTML = '';

                if (welcomeMessage) {
                    chatArea.appendChild(welcomeMessage);
                }

                // 清空消息历史
                if (window.messageHistory) {
                    window.messageHistory = [];
                }

                showNotification('聊天记录已清空', 'success', {
                    autoHide: true,
                    duration: 2000
                });

                console.log('聊天记录已清空');
            }
        }

        // 保存API配置
        function saveApiConfig() {
            const apiBase = document.getElementById('api-base-input').value.trim();
            const apiKey = document.getElementById('api-key-input').value.trim();
            const apiModel = document.getElementById('api-model-input').value.trim();
            
            // 基本验证
            if (!apiBase) {
                alert('API基础地址不能为空');
                return;
            }
            
            if (!apiKey) {
                alert('API密钥不能为空');
                return;
            }
            
            if (!apiModel) {
                alert('默认模型名称不能为空');
                return;
            }
            
            // 显示保存中状态
            const apiStatus = document.getElementById('api-status');
            apiStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> 保存配置中...';
            
            // 发送配置到后端
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_base: apiBase,
                    api_key: apiKey,
                    default_model: apiModel
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // 保存到本地存储
                    localStorage.setItem('api_base', apiBase);
                    localStorage.setItem('api_key', apiKey);
                    localStorage.setItem('api_model', apiModel);
                    
                    // 验证配置
                    validateApiConfig(apiBase, apiKey, apiModel);
                } else {
                    apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || '保存配置失败'}`;
                }
            })
            .catch(error => {
                console.error('保存配置时出错:', error);
                let errorMsg = '保存配置时出错';
                if (error.message) {
                    errorMsg += `: ${error.message}`;
                }
                if (error.traceback) {
                    console.error('详细错误:', error.traceback);
                }
                apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
            });
        }
                
        // 验证API配置
        function validateApiConfig(apiBase, apiKey, apiModel) {
            const apiStatus = document.getElementById('api-status');
            
            // 显示验证中
            apiStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> 验证API配置中...';
            
            // 调用后端验证API
            fetch('/api/validate')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    apiStatus.innerHTML = '<i class="fas fa-check-circle"></i> API配置验证成功';
                    apiStatus.classList.add('valid');
                    
                    // 更新模型状态
                    document.getElementById('model-status').textContent = '已连接';
                    document.getElementById('model-status').classList.add('connected');
                    
                    // 显示成功提示弹窗
                    showNotification('API配置验证成功！', 'success', {
                        details: [
                            `API基础地址: ${apiBase || '未设置'}`,
                            `API密钥: ${apiKey ? apiKey.substring(0, 6) + '******' : '未设置'}`,
                            `默认模型: ${apiModel || '未设置'}`,
                            `可用模型: ${data.models.join(', ')}`
                        ]
                    });

                    // 关闭配置模态框
                    closeApiConfig();
                } else {
                    apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message}`;
                    apiStatus.classList.remove('valid');
                }
            })
            .catch(error => {
                console.error('验证配置时出错:', error);
                apiStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> 验证配置时出错';
                apiStatus.classList.remove('valid');
            });
        }
        
        // 保存模型设置
        function saveModel() {
            const modelSelect = document.getElementById('model-select');
            const selectedValue = modelSelect.value;
            let modelName = '';
            
            if (selectedValue === 'custom') {
                modelName = document.getElementById('custom-model-name').value.trim();
                if (!modelName) {
                    alert('请输入自定义模型名称');
                    return;
                }
            } else if (selectedValue === 'default') {
                const defaultModel = localStorage.getItem('api_model');
                if (!defaultModel) {
                    alert('请先配置默认模型');
                    toggleApiConfig();
                    return;
                }
                modelName = defaultModel;
            } else {
                modelName = selectedValue;
            }
            
            // 保存到本地存储
            localStorage.setItem('current_model', modelName);
            document.getElementById('current-model').textContent = modelName;
            
            // 显示成功消息
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="message-content">
                    模型已切换为: <strong>${modelName}</strong>
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // 发送消息函数
        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message === '') return;
            
            // 检查API配置
            const apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                alert('请先配置API服务');
                toggleApiConfig();
                return;
            }
            
            // 获取当前模型
            const currentModel = localStorage.getItem('current_model') || 
                                localStorage.getItem('api_model');
            
            if (!currentModel) {
                alert('请先选择或配置模型');
                return;
            }
            
            // 添加用户消息
            addMessage(message, 'user');
            
            // 清空输入框
            userInput.value = '';
            
            // 显示加载动画
            const loadingMessage = addMessage('连接模型中...', 'system', true);
            
            // 发送请求到后端
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    model: currentModel
                })
            })
            .then(response => {
                // 首先检查响应类型
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`服务器返回了非JSON响应: ${text.substring(0, 100)}...`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // 移除加载动画
                loadingMessage.remove();
                
                if (data.status === 'success') {
                    // 添加AI响应
                    addMessage(data.response, 'system');
                } else {
                    addMessage(`请求失败: ${data.message}`, 'system');
                }
            })
            .catch(error => {
                // 移除加载动画
                loadingMessage.remove();
                addMessage(`网络错误: ${error.message}`, 'system');
                
                // 在控制台打印完整错误
                console.error('API请求错误详情:', error);
            });
        }
        
        // 添加图表卡片
        function addChartCard() {
            // 调用后端API添加卡片
            fetch('/api/dashboard/card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'chart'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    createChartCard(data.card);
                }
            });
        }
        
        // 添加图片卡片
        function addImageCard() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // 处理图片文件 - 强制获取绝对路径
        function handleImageFile(file) {
            console.log('开始处理图片文件:', file.name);

            // 检查文件大小（限制100MB）
            if (file.size > 100 * 1024 * 1024) {
                alert(`图片文件 ${file.name} 超过100MB限制`);
                return;
            }

            // 尝试多种方法获取文件绝对路径
            let absolutePath = null;

            // 方法1: 直接获取path属性（Electron/Node.js环境）
            if (file.path) {
                absolutePath = file.path;
                console.log('方法1成功 - 直接获取path:', absolutePath);
            }
            // 方法2: webkitRelativePath（文件夹拖拽）
            else if (file.webkitRelativePath) {
                absolutePath = file.webkitRelativePath;
                console.log('方法2成功 - webkitRelativePath:', absolutePath);
            }
            // 方法3: 尝试通过File API获取更多信息
            else if (file.mozFullPath) {
                absolutePath = file.mozFullPath;
                console.log('方法3成功 - mozFullPath:', absolutePath);
            }
            // 方法4: 尝试通过FileSystemEntry API
            else if (file.webkitGetAsEntry && file.webkitGetAsEntry()) {
                const entry = file.webkitGetAsEntry();
                if (entry && entry.fullPath) {
                    absolutePath = entry.fullPath;
                    console.log('方法4成功 - webkitGetAsEntry:', absolutePath);
                }
            }
            // 方法5: 创建临时URL并尝试解析
            else {
                // 尝试从文件的临时URL中获取信息
                const tempUrl = URL.createObjectURL(file);
                console.log('临时URL:', tempUrl);

                // 尝试使用文件名作为路径（最后的备选方案）
                if (file.name && file.name.includes('.')) {
                    // 假设用户会将文件放在常见位置
                    const possiblePaths = [
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Desktop\\${file.name}`,
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Downloads\\${file.name}`,
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Pictures\\${file.name}`,
                        `/Users/user/Desktop/${file.name}`,
                        `/Users/user/Downloads/${file.name}`,
                        `/Users/user/Pictures/${file.name}`,
                        `/home/user/Desktop/${file.name}`,
                        `/home/user/Downloads/${file.name}`,
                        `/home/user/Pictures/${file.name}`
                    ];

                    // 让用户选择或输入正确的路径
                    showPathInputDialog(file, possiblePaths);
                    return;
                }
            }

            console.log('最终获取的路径:', absolutePath);

            if (!absolutePath) {
                // 如果所有方法都失败，要求用户手动输入路径
                showPathInputDialog(file, []);
                return;
            }

            // 继续处理文件
            processImageWithPath(file, absolutePath);
        }

        // 智能检测文件路径
        function detectFilePath(file) {
            const detectedPaths = [];

            // 尝试从文件对象获取路径信息
            if (file.path) {
                detectedPaths.push(file.path);
            }

            if (file.webkitRelativePath) {
                detectedPaths.push(file.webkitRelativePath);
            }

            // 尝试从文件名推测常见路径
            const fileName = file.name;
            const userProfile = navigator.userAgent.includes('Windows') ? 'User' : 'user';

            // Windows路径
            if (navigator.platform.includes('Win')) {
                detectedPaths.push(`C:\\Users\\${userProfile}\\Desktop\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Downloads\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Pictures\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Documents\\${fileName}`);
            }
            // Linux/Mac路径
            else {
                detectedPaths.push(`/home/${userProfile}/Desktop/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Downloads/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Pictures/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Documents/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Desktop/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Downloads/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Pictures/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Documents/${fileName}`);
            }

            // 去重
            return [...new Set(detectedPaths)];
        }

        // 显示路径输入对话框
        function showPathInputDialog(file, suggestedPaths) {
            // 智能检测路径
            const detectedPaths = detectFilePath(file);
            // 合并建议路径和检测路径
            const allPaths = [...new Set([...detectedPaths, ...suggestedPaths])];
            const modal = document.createElement('div');
            modal.className = 'path-input-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--dark-bg);
                border-radius: 12px;
                padding: 25px;
                width: 90%;
                max-width: 600px;
                max-height: 80%;
                overflow-y: auto;
                border: 1px solid var(--border-color);
            `;

            let suggestedPathsHtml = '';
            if (allPaths.length > 0) {
                // 分类显示路径
                const detectedPathsOnly = detectedPaths.slice(0, 3); // 只显示前3个检测路径
                const otherPaths = allPaths.slice(detectedPathsOnly.length);

                suggestedPathsHtml = `
                    <div style="margin: 15px 0;">
                        ${detectedPathsOnly.length > 0 ? `
                            <h4 style="color: var(--success-color); margin-bottom: 10px;">
                                <i class="fas fa-search"></i> 智能检测到的路径：
                            </h4>
                            ${detectedPathsOnly.map((path, index) => `
                                <button onclick="selectSuggestedPath('${path}')" style="
                                    display: block;
                                    width: 100%;
                                    margin: 5px 0;
                                    padding: 8px 12px;
                                    background: rgba(72, 187, 120, 0.2);
                                    border: 1px solid var(--success-color);
                                    border-radius: 6px;
                                    color: var(--text-light);
                                    cursor: pointer;
                                    text-align: left;
                                    font-size: 0.9rem;
                                    ${index === 0 ? 'font-weight: bold;' : ''}
                                ">
                                    ${index === 0 ? '🎯 ' : ''}${path}
                                    ${index === 0 ? ' (推荐)' : ''}
                                </button>
                            `).join('')}
                        ` : ''}

                        ${otherPaths.length > 0 ? `
                            <h4 style="color: var(--text-light); margin-bottom: 10px; margin-top: 15px;">
                                <i class="fas fa-folder"></i> 其他可能的路径：
                            </h4>
                            ${otherPaths.slice(0, 5).map(path => `
                                <button onclick="selectSuggestedPath('${path}')" style="
                                    display: block;
                                    width: 100%;
                                    margin: 5px 0;
                                    padding: 8px 12px;
                                    background: rgba(66, 133, 244, 0.2);
                                    border: 1px solid var(--border-color);
                                    border-radius: 6px;
                                    color: var(--text-light);
                                    cursor: pointer;
                                    text-align: left;
                                    font-size: 0.9rem;
                                ">${path}</button>
                            `).join('')}
                        ` : ''}
                    </div>
                `;
            }

            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-light); margin-bottom: 15px;">
                        <i class="fas fa-search"></i> 智能路径检测
                    </h3>
                    <p style="color: var(--text-gray); margin-bottom: 15px;">
                        文件名: <strong>${file.name}</strong><br>
                        系统已智能检测可能的文件路径，请选择正确的路径或手动输入。
                    </p>
                    ${suggestedPathsHtml}
                    <div style="margin: 15px 0;">
                        <label style="color: var(--text-light); display: block; margin-bottom: 8px;">
                            手动输入完整路径：
                        </label>
                        <input type="text" id="file-path-input"
                               value="${detectedPaths.length > 0 ? detectedPaths[0] : ''}"
                               placeholder="例如: C:\\Users\\用户名\\Desktop\\${file.name}" style="
                            width: 100%;
                            padding: 10px;
                            background: var(--card-bg);
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            color: var(--text-light);
                            font-size: 0.9rem;
                        ">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="cancelPathInput()" style="
                            padding: 8px 16px;
                            background: var(--text-gray);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">取消</button>
                        <button onclick="confirmPathInput()" style="
                            padding: 8px 16px;
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">确认</button>
                    </div>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // 保存文件引用
            window.currentFileForPath = file;
            window.currentPathModal = modal;

            // 聚焦输入框并添加键盘事件
            setTimeout(() => {
                const input = document.getElementById('file-path-input');
                if (input) {
                    input.focus();
                    // 添加回车键确认
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            confirmPathInput();
                        } else if (e.key === 'Escape') {
                            cancelPathInput();
                        }
                    });
                }
            }, 100);
        }

        // 选择建议的路径
        function selectSuggestedPath(path) {
            const input = document.getElementById('file-path-input');
            if (input) {
                input.value = path;
            }
        }

        // 确认路径输入
        function confirmPathInput() {
            const input = document.getElementById('file-path-input');
            const path = input ? input.value.trim() : '';

            if (!path) {
                alert('请输入文件路径');
                return;
            }

            const file = window.currentFileForPath;
            if (file) {
                // 清理
                cancelPathInput();
                // 处理文件
                processImageWithPath(file, path);
            }
        }

        // 取消路径输入
        function cancelPathInput() {
            if (window.currentPathModal) {
                window.currentPathModal.remove();
                window.currentPathModal = null;
            }
            window.currentFileForPath = null;
        }

        // 使用路径处理图片
        function processImageWithPath(file, absolutePath) {
            console.log('处理图片，使用路径:', absolutePath);

            const reader = new FileReader();
            reader.onload = function(e) {
                // 创建图片对象验证文件
                const img = new Image();
                img.onload = function() {
                    console.log('图片验证成功:', file.name, `${img.width}x${img.height}`);

                    const imageData = {
                        id: Date.now(),
                        title: file.name,
                        data: {
                            image_url: e.target.result, // 使用data URL显示
                            file_name: file.name,
                            file_size: formatFileSize(file.size),
                            file_path: absolutePath, // 使用获取到的绝对路径
                            width: img.width,
                            height: img.height,
                            is_local_file: true // 标记有原始路径
                        }
                    };
                    createImageCard(imageData);

                    // 显示成功提示
                    showNotification('图片添加成功！', 'success', {
                        details: [
                            `文件名: ${file.name}`,
                            `尺寸: ${img.width} × ${img.height}`,
                            `大小: ${formatFileSize(file.size)}`,
                            '✅ 支持刷新和监控功能',
                            `绝对路径: ${absolutePath}`
                        ]
                    });
                };
                img.onerror = function() {
                    console.error('图片验证失败:', file.name);
                    showNotification('图片格式不支持或已损坏', 'error', {
                        details: [`文件名: ${file.name}`]
                    });
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                console.error('文件读取失败:', file.name);
                showNotification('文件读取失败', 'error', {
                    details: [`文件名: ${file.name}`]
                });
            };
            reader.readAsDataURL(file);
        }

        // 删除卡片函数
        function removeCard(button) {
            const card = button.closest('.card');
            if (!card) return;

            // 添加确认对话框
            if (confirm('确定要删除这个卡片吗？')) {
                card.classList.add('fade-out');
                setTimeout(() => {
                    card.remove();
                    updateCardCount();
                    showNotification('卡片已删除', 'success', {
                        autoHide: true,
                        duration: 2000
                    });
                }, 300);
            }
        }


        // 处理其他类型文件
        function handleOtherFile(file) {
            console.log('处理其他文件:', file.name, file.type);

            if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
                handleTextFile(file);
            } else {
                // 创建通用文件卡片
                const fileData = {
                    id: Date.now(),
                    title: file.name,
                    data: {
                        file_name: file.name,
                        file_size: formatFileSize(file.size),
                        file_path: file.webkitRelativePath || file.name,
                        file_type: file.type || 'unknown',
                        type: 'file'
                    }
                };
                createFileCard(fileData);
            }
        }

        // 处理文本文件
        function handleTextFile(file) {
            console.log('处理文本文件:', file.name);

            const reader = new FileReader();
            reader.onload = function(e) {
                const textData = {
                    id: Date.now(),
                    title: file.name,
                    data: {
                        content: e.target.result,
                        file_name: file.name,
                        file_size: formatFileSize(file.size),
                        file_path: file.webkitRelativePath || file.name,
                        type: 'text'
                    }
                };
                createTextCard(textData);
            };
            reader.onerror = function() {
                console.error('文本文件读取失败:', file.name);
                alert(`读取文本文件 ${file.name} 失败`);
            };
            reader.readAsText(file);
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 创建图表卡片
        function createChartCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');
            const cardId = `chart-${cardData.id}`;
            
            const card = document.createElement('div');
            card.className = 'card card-enter';
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- 卡片移除功能 - 已恢复 -->
                        <button class="delete-card" onclick="removeCard(this)" title="删除卡片"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="${cardId}"></canvas>
                    </div>
                </div>
            `;
            
            // 设置卡片默认尺寸为更大的尺寸
            card.style.width = '450px';
            card.style.height = '400px';

            cardsContainer.appendChild(card);

            // 确保新卡片不会重叠
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);

            // 创建图表
            setTimeout(() => {
                const ctx = document.getElementById(cardId).getContext('2d');
                const chartData = cardData.data;
                
                new Chart(ctx, {
                    type: chartData.type,
                    data: {
                        labels: chartData.data.labels,
                        datasets: chartData.data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e0f2fe',
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                grid: {
                                    color: 'rgba(45, 55, 72, 0.5)'
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            updateCardCount();
        }
        
        // 创建图片卡片 - 简化版（仅使用绝对路径）
        function createImageCard(cardData) {
            // 直接使用data URL和绝对路径
            const imageSrc = cardData.data.image_url;
            const filePath = cardData.data.file_path;
            const isLocalFile = cardData.data.is_local_file;

            console.log('创建图片卡片:', {
                title: cardData.title,
                filePath: filePath,
                isLocalFile: isLocalFile
            });

            createImageCardWithDataURL(cardData, imageSrc, filePath, isLocalFile);
        }

        // 使用data URL创建图片卡片
        function createImageCardWithDataURL(cardData, imageSrc, filePath, isLocalFile) {
            console.log('使用data URL创建图片卡片，文件路径用于监控:', filePath);

            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-image"></i></div>
                    <div class="card-actions">
                        <!-- 卡片移除功能 - 已恢复 -->
                        <button class="delete-card" onclick="removeCard(this)" title="删除卡片"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="image-container">
                        <div class="image-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                        <img src="${imageSrc}"
                             alt="${cardData.title}"
                             class="image-preview"
                             data-file-path="${filePath || ''}"
                             data-is-local-file="${isLocalFile || false}"
                             style="display: none; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; margin: 0; padding: 0; border: none; border-radius: 4px;"
                             onclick="openImageModal('${imageSrc}', '${cardData.title}')">
                        <div class="image-error" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>图片加载失败</p>
                            <button onclick="retryLoadImage(this)">重试</button>
                        </div>
                    </div>
                    <div class="image-controls">
                        <!-- 图片缩放控制按钮 - 已注释，不需要显示 -->
                        <!-- <button onclick="scaleImage(this, 0.8)"><i class="fas fa-search-minus"></i> 缩小</button> -->
                        <!-- <button onclick="scaleImage(this, 1.2)"><i class="fas fa-search-plus"></i> 放大</button> -->
                        <!-- <button onclick="resetImageScale(this)"><i class="fas fa-undo"></i> 重置</button> -->
                        <button onclick="refreshImage(this)"><i class="fas fa-sync-alt"></i> 刷新</button>
                        <button onclick="toggleImageMonitoring(this)"><i class="fas fa-eye"></i> 监控</button>
                    </div>
                    <!-- 图片信息 - 已注释，不在卡片中显示 -->
                    <!-- <div class="image-info">
                        <div><strong>文件名:</strong> ${cardData.data.file_name}</div>
                        <div><strong>大小:</strong> ${cardData.data.file_size}</div>
                        <div><strong>尺寸:</strong> ${cardData.data.width} × ${cardData.data.height}</div>
                        <div><strong>路径:</strong> ${filePath}</div>
                        <div class="monitoring-status">
                            <i class="fas fa-circle" style="color: ${filePath && !filePath.startsWith('http') && !filePath.startsWith('data:') ? 'var(--primary-color)' : '#ccc'}"></i>
                            <span>${filePath && !filePath.startsWith('http') && !filePath.startsWith('data:') ? '监控中' : '未监控'}</span>
                        </div>
                    </div> -->
                </div>
            `;

            // 设置卡片默认尺寸为更大的尺寸
            card.style.width = '400px';
            card.style.height = '500px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // 确保新卡片不会重叠
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);

            // 设置图片加载事件
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');

            loading.style.display = 'flex';

            img.onload = function() {
                loading.style.display = 'none';
                error.style.display = 'none';
                img.style.display = 'block';

                // 设置图片样式以显示完整的最大图片
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.width = 'auto';
                img.style.height = 'auto';
                img.style.objectFit = 'contain'; // 显示完整图片
                img.style.margin = '0';
                img.style.padding = '0';
                img.style.border = 'none';
                img.style.borderRadius = '4px';

                // 调试信息：检查容器和图片的实际尺寸
                const container = img.closest('.image-container');
                const cardContent = img.closest('.card-content');
                const card = img.closest('.card');

                console.log('图片加载成功 - 尺寸调试信息:', {
                    src: img.src,
                    filePath: filePath,
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight,
                    cardSize: { width: card.offsetWidth, height: card.offsetHeight },
                    cardContentSize: { width: cardContent.offsetWidth, height: cardContent.offsetHeight },
                    containerSize: { width: container.offsetWidth, height: container.offsetHeight },
                    imgSize: { width: img.offsetWidth, height: img.offsetHeight }
                });

                // 如果是本地文件，开始监控
                if (filePath && !filePath.startsWith('http') && !filePath.startsWith('data:')) {
                    console.log('开始监控本地图片文件:', filePath);
                }
            };

            img.onerror = function() {
                loading.style.display = 'none';
                img.style.display = 'none';
                error.style.display = 'flex';

                console.error('图片加载失败:', {
                    src: imageSrc,
                    filePath: filePath,
                    error: '图片加载错误'
                });

                // 尝试获取更详细的错误信息
                fetch(imageSrc)
                    .then(response => {
                        if (!response.ok) {
                            console.error('API响应错误:', response.status, response.statusText);
                            return response.text();
                        }
                    })
                    .then(text => {
                        if (text) {
                            console.error('API错误详情:', text);
                        }
                    })
                    .catch(fetchError => {
                        console.error('网络请求失败:', fetchError);
                    });
            };
        }

        // 图片缩放功能
        function scaleImage(button, factor) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const currentScale = parseFloat(img.dataset.scale || 1);
            const newScale = currentScale * factor;
            
            // 限制缩放范围
            if (newScale >= 0.2 && newScale <= 3) {
                img.style.transform = `scale(${newScale})`;
                img.dataset.scale = newScale;
            }
        }

        // 重置图片缩放
        function resetImageScale(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            img.style.transform = 'scale(1)';
            img.dataset.scale = 1;
        }
        
        // 图片刷新功能 - 支持原始文件刷新
        function refreshImage(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');
            const filePath = img.dataset.filePath;
            const isLocalFile = img.dataset.isLocalFile === 'true';

            console.log('刷新图片:', {
                filePath: filePath,
                currentSrc: img.src.substring(0, 50) + '...',
                isLocalFile: isLocalFile,
                hasLoading: !!loading,
                hasError: !!error
            });

            // 检查是否有文件路径
            if (!filePath || !isLocalFile) {
                showImageNotification(img, '无文件路径，无法刷新', 'warning');
                console.log('无文件路径，无法刷新');
                return;
            }

            // 显示加载状态
            if (loading) loading.style.display = 'flex';
            if (error) error.style.display = 'none';
            img.style.opacity = '0.5';

            // 尝试通过API重新读取原始文件
            console.log('通过API刷新原始文件:', filePath);

            const apiUrl = `/api/serve_image?path=${encodeURIComponent(filePath)}&t=${Date.now()}`;

            // 先测试API是否可用
            fetch(apiUrl, { method: 'HEAD' })
                .then(response => {
                    console.log('API测试响应:', response.status, response.statusText);
                    if (response.ok) {
                        // API可用，重新读取文件并转换为data URL
                        return fetch(apiUrl);
                    } else {
                        throw new Error(`API响应错误: ${response.status} ${response.statusText}`);
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    // 将blob转换为data URL
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // 验证新图片
                        const testImg = new Image();
                        testImg.onload = () => {
                            console.log('图片刷新成功，更新data URL');
                            img.src = e.target.result; // 更新为新的data URL
                            img.style.opacity = '1';
                            if (loading) loading.style.display = 'none';

                            // 显示刷新提示
                            showImageNotification(img, '文件已重新读取', 'success');
                        };

                        testImg.onerror = () => {
                            console.error('新图片验证失败');
                            img.style.opacity = '1';
                            if (loading) loading.style.display = 'none';
                            if (error) error.style.display = 'flex';

                            showImageNotification(img, '图片验证失败', 'error');
                        };

                        testImg.src = e.target.result;
                    };

                    reader.onerror = () => {
                        console.error('文件读取失败');
                        img.style.opacity = '1';
                        if (loading) loading.style.display = 'none';
                        if (error) error.style.display = 'flex';

                        showImageNotification(img, '文件读取失败', 'error');
                    };

                    reader.readAsDataURL(blob);
                })
                .catch(fetchError => {
                    console.error('API请求失败:', fetchError);
                    img.style.opacity = '1';
                    if (loading) loading.style.display = 'none';
                    if (error) error.style.display = 'flex';

                    // 显示详细错误信息
                    showImageNotification(img, `刷新失败: ${fetchError.message}`, 'error');
                });
        }

        // 显示图片通知
        function showImageNotification(imgElement, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'image-notification';
            notification.textContent = message;

            let bgColor = 'var(--primary-color)';
            if (type === 'success') bgColor = 'var(--accent-color)';
            if (type === 'error') bgColor = '#e74c3c';

            notification.style.cssText = `
                position: absolute;
                top: 10px;
                left: 10px;
                background: ${bgColor};
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;

            const container = imgElement.closest('.image-container') || imgElement.parentElement;
            if (container) {
                // 移除之前的通知
                const existingNotification = container.querySelector('.image-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                container.style.position = 'relative';
                container.appendChild(notification);

                setTimeout(() => notification.style.opacity = '1', 10);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }
        }

        // 切换图片监控状态
        function toggleImageMonitoring(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const statusElement = card.querySelector('.monitoring-status');
            const filePath = img.dataset.filePath;
            const isLocalFile = img.dataset.isLocalFile === 'true';

            console.log('切换图片监控:', {
                filePath: filePath,
                isLocalFile: isLocalFile,
                src: img.src.substring(0, 50) + '...'
            });

            // 检查是否支持监控
            if (!filePath || !isLocalFile) {
                showImageNotification(img, '无文件路径，不支持监控', 'warning');
                console.log('无文件路径，不支持监控');
                return;
            }

            if (filePath.startsWith('http')) {
                showImageNotification(img, '网络图片不支持监控功能', 'warning');
                console.log('网络图片不支持监控');
                return;
            }

            const isMonitoring = statusElement.querySelector('i').style.color.includes('var(--primary-color)');

            if (isMonitoring) {
                // 停止监控
                statusElement.querySelector('i').style.color = '#ccc';
                statusElement.querySelector('span').textContent = '已停止';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> 停止';
                console.log('停止监控图片:', filePath);
            } else {
                // 开始监控
                statusElement.querySelector('i').style.color = 'var(--primary-color)';
                statusElement.querySelector('span').textContent = '监控中';
                button.innerHTML = '<i class="fas fa-eye"></i> 监控';
                console.log('开始监控图片:', filePath);
            }
        }

        // 重试加载图片
        function retryLoadImage(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');

            // 显示加载状态
            error.style.display = 'none';
            loading.style.display = 'flex';

            // 重新设置图片源，添加时间戳避免缓存
            const originalSrc = img.src.split('?')[0];
            img.src = originalSrc + '?retry=' + Date.now();
        }

        // 创建文本卡片
        function createTextCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            // 截取文本内容预览
            const preview = cardData.data.content.length > 200 ?
                cardData.data.content.substring(0, 200) + '...' :
                cardData.data.content;

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-file-text"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- 卡片移除功能 - 已恢复 -->
                        <button class="delete-card" onclick="removeCard(this)" title="删除卡片"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="text-preview">
                        <pre>${preview}</pre>
                    </div>
                    <div class="text-controls">
                        <button onclick="viewFullText(this)"><i class="fas fa-expand"></i> 查看全文</button>
                        <button onclick="copyText(this)"><i class="fas fa-copy"></i> 复制</button>
                    </div>
                    <div class="file-info">
                        <div><strong>文件名:</strong> ${cardData.data.file_name}</div>
                        <div><strong>大小:</strong> ${cardData.data.file_size}</div>
                        <div><strong>路径:</strong> ${cardData.data.file_path}</div>
                        <div><strong>字符数:</strong> ${cardData.data.content.length}</div>
                    </div>
                </div>
            `;

            // 设置卡片默认尺寸为更大的尺寸
            card.style.width = '400px';
            card.style.height = '350px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // 确保新卡片不会重叠
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);
        }

        // 创建通用文件卡片
        function createFileCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            // 根据文件类型选择图标
            let icon = 'fas fa-file';
            if (cardData.data.file_type.includes('pdf')) icon = 'fas fa-file-pdf';
            else if (cardData.data.file_type.includes('word')) icon = 'fas fa-file-word';
            else if (cardData.data.file_type.includes('excel')) icon = 'fas fa-file-excel';
            else if (cardData.data.file_type.includes('zip')) icon = 'fas fa-file-archive';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="${icon}"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- 卡片移除功能 - 已恢复 -->
                        <button class="delete-card" onclick="removeCard(this)" title="删除卡片"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="file-preview">
                        <div class="file-icon">
                            <i class="${icon}" style="font-size: 4rem; color: var(--primary-color);"></i>
                        </div>
                        <p>文件类型: ${cardData.data.file_type || '未知'}</p>
                    </div>
                    <div class="file-info">
                        <div><strong>文件名:</strong> ${cardData.data.file_name}</div>
                        <div><strong>大小:</strong> ${cardData.data.file_size}</div>
                        <div><strong>路径:</strong> ${cardData.data.file_path}</div>
                        <div><strong>类型:</strong> ${cardData.data.file_type}</div>
                    </div>
                </div>
            `;

            // 设置卡片默认尺寸为更大的尺寸
            card.style.width = '350px';
            card.style.height = '300px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // 确保新卡片不会重叠
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);
        }

        // 查看全文
        function viewFullText(button) {
            const card = button.closest('.card');
            const textPreview = card.querySelector('.text-preview pre');
            const fullText = textPreview.dataset.fullText || textPreview.textContent;

            // 创建模态框显示全文
            const modal = document.createElement('div');
            modal.className = 'text-modal';
            modal.innerHTML = `
                <div class="text-modal-content">
                    <div class="text-modal-header">
                        <h3>文本内容</h3>
                        <button onclick="this.closest('.text-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-modal-body">
                        <pre>${fullText}</pre>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // 复制文本
        function copyText(button) {
            const card = button.closest('.card');
            const textPreview = card.querySelector('.text-preview pre');
            const fullText = textPreview.dataset.fullText || textPreview.textContent;

            navigator.clipboard.writeText(fullText).then(() => {
                // 显示复制成功提示
                const notification = document.createElement('div');
                notification.textContent = '文本已复制到剪贴板';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--primary-color);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;

                document.body.appendChild(notification);
                setTimeout(() => notification.style.opacity = '1', 10);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }).catch(() => {
                alert('复制失败，请手动复制');
            });
        }

        // 打开图片模态框
        function openImageModal(imageSrc, title) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <span class="modal-close">&times;</span>
                <div class="modal-content">
                    <img src="${imageSrc}" alt="${title}">
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // 关闭模态框事件
            const closeBtn = modal.querySelector('.modal-close');
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 清空所有卡片
        function clearCards() {
            const cardsContainer = document.getElementById('cards-container');
            if (cardsContainer.children.length > 0) {
                if (confirm('确定要清空所有卡片吗？')) {
                    while (cardsContainer.firstChild) {
                        cardsContainer.removeChild(cardsContainer.firstChild);
                    }
                    updateCardCount();
                }
            } else {
                alert('仪表盘中没有卡片可清除');
            }
        }
        
        // 更新卡片计数
        function updateCardCount() {
            const count = document.getElementById('cards-container').children.length;
            document.getElementById('card-count').textContent = count;
        }
        
        // 添加消息到聊天区域
        function addMessage(content, sender, isLoading = false) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender === 'user') {
                avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
            } else {
                avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loader"></div> ${content}`;
            } else {
                // 使用markdown渲染
                if (typeof marked !== 'undefined' && sender === 'system') {
                    contentDiv.innerHTML = marked.parse(content);
                } else {
                    contentDiv.textContent = content;
                }
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatArea.appendChild(messageDiv);
            
            // 滚动到底部
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageDiv;
        }

        // 面板拖拽调整大小功能
        function setupPanelResize() {
            const resizeHandle = document.getElementById('resize-handle');
            const panelLeft = document.getElementById('panel-left');
            const panelRight = document.getElementById('panel-right');
            const container = document.querySelector('.container');

            if (!resizeHandle || !panelLeft || !panelRight || !container) {
                console.warn('面板拖拽元素未找到');
                return;
            }

            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;

                // 获取当前宽度
                const containerRect = container.getBoundingClientRect();
                const leftRect = panelLeft.getBoundingClientRect();
                const rightRect = panelRight.getBoundingClientRect();

                startLeftWidth = leftRect.width;
                startRightWidth = rightRect.width;

                resizeHandle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                e.preventDefault();
            });

            let lastMoveTime = 0;
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                // 节流处理，提高响应性能
                const now = performance.now();
                if (now - lastMoveTime < 8) return; // 约120fps，更流畅
                lastMoveTime = now;

                const deltaX = e.clientX - startX;
                const containerWidth = container.offsetWidth; // 使用offsetWidth更快

                // 直接计算百分比，避免复杂的像素计算
                const startLeftPercent = (startLeftWidth / containerWidth) * 100;
                const deltaPercent = (deltaX / containerWidth) * 100;

                let leftPercent = startLeftPercent + deltaPercent;

                // 简单的边界限制
                leftPercent = Math.max(15, Math.min(85, leftPercent));
                const rightPercent = 100 - leftPercent;

                // 直接应用，减少DOM操作
                panelLeft.style.width = leftPercent + '%';
                panelLeft.style.flex = 'none';
                panelRight.style.width = rightPercent + '%';
                panelRight.style.flex = 'none';

                e.preventDefault();
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // 双击重置为默认比例
            resizeHandle.addEventListener('dblclick', function() {
                panelLeft.style.width = '';
                panelLeft.style.flex = '1';
                panelRight.style.width = '45%';
                panelRight.style.flex = 'none';

                showNotification('面板宽度已重置', 'success');
            });
        }

        // 页面高度调整功能
        function setupPageHeightAdjustment() {
            const container = document.querySelector('.container');
            const heightIndicator = document.getElementById('height-indicator');
            const heightValue = document.getElementById('height-value');

            if (!container || !heightIndicator || !heightValue) {
                console.warn('页面高度调整元素未找到');
                return;
            }

            let currentHeight = 100; // 当前高度百分比
            let isAdjusting = false;
            let hideTimeout;

            // 显示指示器
            function showIndicator() {
                heightIndicator.classList.add('show');
                isAdjusting = true;

                // 清除之前的隐藏定时器
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                }
            }

            // 隐藏指示器
            function hideIndicator() {
                hideTimeout = setTimeout(() => {
                    heightIndicator.classList.remove('show');
                    isAdjusting = false;
                }, 1500);
            }

            // 更新高度
            function updateHeight(newHeight) {
                currentHeight = Math.max(50, Math.min(300, newHeight)); // 限制在50%-300%之间

                const heightPx = (window.innerHeight - 120) * (currentHeight / 100);
                container.style.height = heightPx + 'px';

                heightValue.textContent = `高度: ${Math.round(currentHeight)}%`;

                console.log('页面高度已调整:', currentHeight + '%', heightPx + 'px');
            }

            // 监听滚轮事件
            document.addEventListener('wheel', function(e) {
                // 只有按住Ctrl键时才调整高度
                if (!e.ctrlKey) return;

                e.preventDefault();

                showIndicator();

                // 根据滚轮方向调整高度
                const delta = e.deltaY > 0 ? -5 : 5; // 向下滚动减小高度，向上滚动增大高度
                updateHeight(currentHeight + delta);

                hideIndicator();
            }, { passive: false });

            // 监听键盘事件，显示提示
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && !isAdjusting) {
                    showIndicator();
                }
            });

            document.addEventListener('keyup', function(e) {
                if (!e.ctrlKey && isAdjusting) {
                    hideIndicator();
                }
            });

            // 添加快捷键重置功能 (Ctrl + 0)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === '0') {
                    e.preventDefault();
                    updateHeight(100);
                    showIndicator();
                    hideIndicator();

                    showNotification('页面高度已重置为100%', 'success', {
                        autoHide: true,
                        duration: 2000
                    });
                }
            });

            console.log('页面高度调整功能已初始化');
            console.log('使用方法: 按住Ctrl键 + 滚轮调整高度');
            console.log('快捷键: Ctrl + 0 重置高度');
        }

        // 响应式布局功能
        function setupResponsiveLayout() {
            function adjustLayout() {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const container = document.querySelector('.container');
                const panelLeft = document.getElementById('panel-left');
                const panelRight = document.getElementById('panel-right');
                const cards = document.querySelectorAll('.card');

                console.log('调整响应式布局:', { screenWidth, screenHeight });

                // 根据屏幕宽度调整面板比例
                if (screenWidth < 1200) {
                    // 小屏幕：减小右侧面板比例
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '35%';
                        panelLeft.style.width = '65%';
                    }
                } else if (screenWidth < 1600) {
                    // 中等屏幕：标准比例
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '42%';
                        panelLeft.style.width = '58%';
                    }
                } else {
                    // 大屏幕：增大右侧面板比例
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '45%';
                        panelLeft.style.width = '55%';
                    }
                }

                // 动态调整卡片最大尺寸
                cards.forEach(card => {
                    const maxWidth = Math.min(1600, screenWidth * 0.95); // 大幅增大最大宽度
                    const maxHeight = Math.min(1200, screenHeight * 0.9); // 大幅增大最大高度

                    card.style.maxWidth = maxWidth + 'px';
                    card.style.maxHeight = maxHeight + 'px';

                    // 如果当前尺寸超出限制，自动调整
                    const rect = card.getBoundingClientRect();
                    if (rect.width > maxWidth) {
                        card.style.width = maxWidth + 'px';
                    }
                    if (rect.height > maxHeight) {
                        card.style.height = maxHeight + 'px';
                    }
                });
            }

            // 初始调整
            adjustLayout();

            // 监听窗口大小变化
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(adjustLayout, 150);
            });
        }

        // 卡片尺寸监控功能
        function setupCardSizeMonitoring() {
            const cardsContainer = document.getElementById('cards-container');
            if (!cardsContainer) return;

            // 监控卡片尺寸变化
            const resizeObserver = new ResizeObserver(entries => {
                entries.forEach(entry => {
                    const card = entry.target;
                    if (!card.classList.contains('card')) return;

                    const containerRect = cardsContainer.getBoundingClientRect();
                    const cardRect = card.getBoundingClientRect();

                    // 检查是否超出容器边界
                    let needsAdjustment = false;
                    let newWidth = cardRect.width;
                    let newHeight = cardRect.height;

                    // 检查右边界
                    if (cardRect.right > containerRect.right) {
                        newWidth = containerRect.right - cardRect.left - 20; // 增加边距
                        needsAdjustment = true;
                    }

                    // 检查底边界
                    if (cardRect.bottom > containerRect.bottom) {
                        newHeight = containerRect.bottom - cardRect.top - 20; // 增加边距
                        needsAdjustment = true;
                    }

                    // 检查与其他卡片的重叠
                    const allCards = cardsContainer.querySelectorAll('.card');
                    allCards.forEach(otherCard => {
                        if (otherCard === card) return;

                        const otherRect = otherCard.getBoundingClientRect();

                        // 检查是否重叠
                        if (!(cardRect.right < otherRect.left ||
                              cardRect.left > otherRect.right ||
                              cardRect.bottom < otherRect.top ||
                              cardRect.top > otherRect.bottom)) {

                            // 发现重叠，调整当前卡片尺寸
                            if (cardRect.right > otherRect.left && cardRect.left < otherRect.left) {
                                newWidth = otherRect.left - cardRect.left - 10;
                                needsAdjustment = true;
                            }
                            if (cardRect.bottom > otherRect.top && cardRect.top < otherRect.top) {
                                newHeight = otherRect.top - cardRect.top - 10;
                                needsAdjustment = true;
                            }
                        }
                    });

                    // 应用调整
                    if (needsAdjustment) {
                        card.style.width = Math.max(140, newWidth) + 'px';
                        card.style.height = Math.max(150, newHeight) + 'px';

                        // 显示提示
                        showNotification('卡片尺寸已自动调整以防止重叠', 'info', {
                            autoHide: true,
                            duration: 2000
                        });
                    }
                });
            });

            // 监控现有卡片
            const existingCards = cardsContainer.querySelectorAll('.card');
            existingCards.forEach(card => {
                resizeObserver.observe(card);
            });

            // 监控新添加的卡片
            const mutationObserver = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1 && node.classList.contains('card')) {
                            resizeObserver.observe(node);

                            // 为新卡片设置初始位置，避免重叠
                            setTimeout(() => {
                                adjustCardPosition(node);
                            }, 100);
                        }
                    });
                });
            });

            mutationObserver.observe(cardsContainer, {
                childList: true,
                subtree: true
            });
        }

        // 调整卡片位置避免重叠
        function adjustCardPosition(card) {
            const cardsContainer = document.getElementById('cards-container');
            const allCards = cardsContainer.querySelectorAll('.card');
            const cardRect = card.getBoundingClientRect();

            let hasOverlap = false;
            allCards.forEach(otherCard => {
                if (otherCard === card) return;

                const otherRect = otherCard.getBoundingClientRect();

                // 检查是否重叠
                if (!(cardRect.right < otherRect.left ||
                      cardRect.left > otherRect.right ||
                      cardRect.bottom < otherRect.top ||
                      cardRect.top > otherRect.bottom)) {
                    hasOverlap = true;
                }
            });

            if (hasOverlap) {
                // 强制重新布局网格
                cardsContainer.style.gridAutoFlow = 'row';
                cardsContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(160px, 1fr))';

                console.log('检测到卡片重叠，已调整布局');
            }
        }

        // 确保卡片不重叠
        function ensureNoOverlap(targetCard) {
            const cardsContainer = document.getElementById('cards-container');
            if (!cardsContainer || !targetCard) return;

            const containerRect = cardsContainer.getBoundingClientRect();
            const targetRect = targetCard.getBoundingClientRect();
            const allCards = cardsContainer.querySelectorAll('.card');

            let hasOverlap = false;

            // 检查与其他卡片的重叠
            allCards.forEach(otherCard => {
                if (otherCard === targetCard) return;

                const otherRect = otherCard.getBoundingClientRect();

                // 检查是否重叠
                if (!(targetRect.right <= otherRect.left ||
                      targetRect.left >= otherRect.right ||
                      targetRect.bottom <= otherRect.top ||
                      targetRect.top >= otherRect.bottom)) {
                    hasOverlap = true;
                    console.log('检测到卡片重叠:', targetCard, otherCard);
                }
            });

            if (hasOverlap) {
                // 重新计算网格布局
                const cardWidth = 160; // 最小卡片宽度
                const gap = 10; // 网格间距
                const containerWidth = containerRect.width - 16; // 减去padding
                const columnsCount = Math.floor(containerWidth / (cardWidth + gap));

                // 更新网格布局
                cardsContainer.style.gridTemplateColumns = `repeat(${Math.max(1, columnsCount)}, 1fr)`;
                cardsContainer.style.gap = gap + 'px';

                // 强制重新布局
                cardsContainer.style.display = 'none';
                cardsContainer.offsetHeight; // 触发重排
                cardsContainer.style.display = 'grid';

                console.log('已调整网格布局防止重叠，列数:', columnsCount);

                showNotification('已自动调整布局防止卡片重叠', 'info', {
                    autoHide: true,
                    duration: 2000
                });
            }
        }

        // 聊天框拖拽功能
        function setupChatAreaResize() {
            const chatArea = document.getElementById('chat-area');
            
            // 创建自定义拖拽手柄
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'chat-resize-handle';
            resizeHandle.title = '拖拽调整聊天框大小';
            chatArea.appendChild(resizeHandle);

            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = parseInt(document.defaultView.getComputedStyle(chatArea).height, 10);
                document.documentElement.style.cursor = 'nw-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const height = startHeight + e.clientY - startY;
                
                // 限制最小和最大高度
                if (height > 200 && height < window.innerHeight * 0.8) {
                    chatArea.style.height = height + 'px';
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.documentElement.style.cursor = '';
                }
            });

            // 防止文本选择
            resizeHandle.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });
        }

        // 面板拖拽移动功能 - 修复右侧面板位置问题
        function setupPanelDrag() {
            const panelLeft = document.querySelector('.panel-left');
            const panelRight = document.querySelector('.panel-right');
            const panelTitle = panelLeft.querySelector('.panel-title');
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            let xOffset = 0;
            let yOffset = 0;

            panelTitle.addEventListener('mousedown', function(e) {
                // 只有点击标题栏才能拖拽，避免与其他按钮冲突
                if (e.target.closest('.settings-btn') || e.target.closest('.model-info') || e.target.closest('.chat-mode-switch')) {
                    return;
                }
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === panelTitle || panelTitle.contains(e.target)) {
                    isDragging = true;
                    panelLeft.style.position = 'absolute';
                    panelLeft.style.zIndex = '1000';
                    // 确保右侧面板保持在正确位置
                    panelRight.style.position = 'sticky';
                    panelRight.style.top = '20px';
                    panelRight.style.right = '0';
                    panelRight.style.zIndex = '100';
                    document.body.style.userSelect = 'none';
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    // 限制拖拽范围，防止拖出视窗和与右侧面板重叠
                    const maxX = window.innerWidth - panelLeft.offsetWidth - panelRight.offsetWidth - 50;
                    const maxY = window.innerHeight - panelLeft.offsetHeight;
                    
                    xOffset = Math.max(0, Math.min(xOffset, maxX));
                    yOffset = Math.max(0, Math.min(yOffset, maxY));

                    panelLeft.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = '';
                    // 重置面板位置到原始布局
                    setTimeout(() => {
                        panelLeft.style.position = '';
                        panelLeft.style.transform = '';
                        panelLeft.style.zIndex = '';
                        panelRight.style.position = 'sticky';
                        panelRight.style.top = '20px';
                        panelRight.style.zIndex = '100';
                    }, 100);
                }
            });
        }

        // 全局变量存储附件
        let attachments = [];

        // 处理附件上传
        function handleAttachments(files) {
            const attachmentPreview = document.getElementById('attachment-preview');
            
            Array.from(files).forEach(file => {
                // 检查文件大小（限制100MB）
                if (file.size > 100 * 1024 * 1024) {
                    alert(`文件 ${file.name} 超过100MB限制`);
                    return;
                }

                // 添加到附件列表
                const attachmentId = Date.now() + Math.random();
                attachments.push({
                    id: attachmentId,
                    file: file,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type
                });
                
                // 创建附件预览项
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML = `
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                    <button class="remove-attachment" onclick="removeAttachment(${attachmentId})">&times;</button>
                `;
                attachmentPreview.appendChild(attachmentItem);
            });
        }

        // 移除附件
        function removeAttachment(id) {
            const index = attachments.findIndex(a => a.id === id);
            if (index !== -1) {
                attachments.splice(index, 1);
                const attachmentItem = document.querySelector(`.attachment-item[data-id="${id}"]`);
                if (attachmentItem) {
                    attachmentItem.remove();
                }
            }
        }

        // 图片文件监控功能 - 改进版
        function setupImageMonitoring() {
            let fileWatchers = new Map();
            let lastModifiedTimes = new Map();

            // 监控本地文件变化
            function watchLocalFile(filePath, imgElement) {
                if (fileWatchers.has(filePath)) {
                    clearInterval(fileWatchers.get(filePath));
                }

                const interval = setInterval(async () => {
                    try {
                        // 检查图片是否还在DOM中
                        if (!document.body.contains(imgElement)) {
                            clearInterval(interval);
                            fileWatchers.delete(filePath);
                            lastModifiedTimes.delete(filePath);
                            return;
                        }

                        // 发送请求检查文件是否更新
                        const response = await fetch('/api/check_file_update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_path: filePath })
                        });

                        const data = await response.json();
                        if (data.updated) {
                            // 文件已更新，重新读取原始文件并更新data URL
                            console.log('检测到文件更新:', filePath);

                            // 添加更新动画
                            imgElement.style.transition = 'opacity 0.3s ease';
                            imgElement.style.opacity = '0.5';

                            // 通过API重新读取文件
                            const apiUrl = `/api/serve_image?path=${encodeURIComponent(filePath)}&t=${Date.now()}`;

                            fetch(apiUrl)
                                .then(response => response.blob())
                                .then(blob => {
                                    // 将blob转换为data URL
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        // 验证新图片
                                        const testImg = new Image();
                                        testImg.onload = () => {
                                            console.log('图片自动更新成功:', filePath);
                                            imgElement.src = e.target.result; // 更新为新的data URL
                                            imgElement.style.opacity = '1';

                                            // 显示更新提示
                                            showUpdateNotification(imgElement, '图片已自动更新');
                                        };

                                        testImg.onerror = () => {
                                            console.warn('新图片验证失败:', filePath);
                                            imgElement.style.opacity = '1';
                                        };

                                        testImg.src = e.target.result;
                                    };

                                    reader.onerror = () => {
                                        console.warn('文件读取失败:', filePath);
                                        imgElement.style.opacity = '1';
                                    };

                                    reader.readAsDataURL(blob);
                                })
                                .catch(error => {
                                    console.warn('图片更新失败:', filePath, error);
                                    imgElement.style.opacity = '1';
                                });
                        }
                    } catch (error) {
                        console.warn('文件监控检查失败:', filePath, error);
                    }
                }, 1500); // 每1.5秒检查一次，更频繁的检查

                fileWatchers.set(filePath, interval);
            }

            // 显示更新通知
            function showUpdateNotification(imgElement, message) {
                // 移除之前的通知
                const existingNotification = imgElement.parentElement.querySelector('.image-update-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = 'image-update-notification';
                notification.textContent = message;
                notification.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: var(--primary-color);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;

                const container = imgElement.closest('.image-container') || imgElement.parentElement;
                if (container) {
                    container.style.position = 'relative';
                    container.appendChild(notification);

                    // 动画显示
                    setTimeout(() => notification.style.opacity = '1', 10);
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                }
            }

            // 监控所有图片
            function monitorAllImages() {
                const images = document.querySelectorAll('.image-preview');
                console.log('扫描图片进行监控，找到', images.length, '个图片');

                images.forEach(img => {
                    const originalSrc = img.src.split('?')[0];
                    let filePath = img.dataset.filePath || img.getAttribute('data-file-path');
                    const isLocalFile = img.dataset.isLocalFile === 'true';

                    console.log('图片分析:', {
                        src: originalSrc.startsWith('data:') ? 'data URL' : originalSrc,
                        filePath: filePath,
                        isLocalFile: isLocalFile,
                        canMonitor: filePath && isLocalFile && !filePath.startsWith('http')
                    });

                    // 只监控有原始文件路径的本地图片
                    if (filePath && isLocalFile && !filePath.startsWith('http://') && !filePath.startsWith('https://')) {
                        // 设置文件路径属性以便后续使用
                        img.dataset.filePath = filePath;

                        // 检查是否已经在监控
                        if (!fileWatchers.has(filePath)) {
                            watchLocalFile(filePath, img);
                            console.log('开始监控图片:', filePath);
                        } else {
                            console.log('图片已在监控中:', filePath);
                        }
                    } else {
                        console.log('跳过图片:', filePath ? '无原始路径' : '网络图片');
                    }
                });
            }

            // 初始监控
            monitorAllImages();

            // 监听新图片添加
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) {
                                const newImages = node.querySelectorAll ? node.querySelectorAll('.image-preview') : [];
                                if (newImages.length > 0 || node.classList?.contains('image-preview')) {
                                    setTimeout(monitorAllImages, 100);
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // 页面卸载时清理
            window.addEventListener('beforeunload', () => {
                fileWatchers.forEach(interval => clearInterval(interval));
                fileWatchers.clear();
                lastModifiedTimes.clear();
            });

            // 添加手动刷新功能
            window.refreshAllImages = function() {
                const images = document.querySelectorAll('.image-preview');
                images.forEach(img => {
                    const filePath = img.dataset.filePath;
                    if (filePath) {
                        const timestamp = Date.now();
                        const newSrc = '/api/serve_image?path=' + encodeURIComponent(filePath) + '&t=' + timestamp;
                        img.src = newSrc;
                        showUpdateNotification(img, '手动刷新');
                    }
                });
            };
        }

        // 聊天区域滚动控制功能 - 改进版
        function setupChatScrollControl() {
            const chatArea = document.getElementById('chat-area');
            const inputArea = document.querySelector('.input-area');
            const panelLeft = document.querySelector('.panel-left');

            let isScrolling = false;
            let scrollTimeout;
            let autoScrollEnabled = true;

            // 确保输入框始终可见
            function ensureInputVisible() {
                if (!inputArea) return;

                const inputRect = inputArea.getBoundingClientRect();
                const panelRect = panelLeft.getBoundingClientRect();

                // 检查输入框是否在面板可视区域内
                if (inputRect.bottom > panelRect.bottom || inputRect.top < panelRect.top) {
                    inputArea.scrollIntoView({
                        behavior: 'smooth',
                        block: 'end',
                        inline: 'nearest'
                    });
                }
            }

            // 鼠标滚轮控制 - 改进版（提升灵敏度）
            chatArea.addEventListener('wheel', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const delta = e.deltaY;
                // 大幅提升滚动量，让滚动更灵敏
                let scrollAmount;

                // 根据滚动强度和类型调整滚动量
                if (Math.abs(delta) > 100) {
                    // 快速滚动
                    scrollAmount = 120;
                } else if (Math.abs(delta) > 50) {
                    // 中等滚动
                    scrollAmount = 80;
                } else {
                    // 慢速滚动
                    scrollAmount = 60;
                }

                // 设置滚动状态
                isScrolling = true;
                clearTimeout(scrollTimeout);

                // 使用即时滚动而不是平滑滚动，提升响应速度
                if (delta > 0) {
                    // 向下滚动
                    chatArea.scrollTop += scrollAmount;
                } else {
                    // 向上滚动
                    chatArea.scrollTop -= scrollAmount;
                }

                // 显示滚动指示器
                showScrollIndicator(delta > 0 ? 'down' : 'up');

                // 检查是否接近底部，决定是否启用自动滚动
                const isNearBottom = chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 50;
                autoScrollEnabled = isNearBottom;

                // 重置滚动状态
                scrollTimeout = setTimeout(() => {
                    isScrolling = false;
                    hideScrollIndicator();

                    // 如果滚动到底部，确保输入框可见
                    if (autoScrollEnabled) {
                        setTimeout(ensureInputVisible, 100);
                    }
                }, 150);
            });

            // 键盘导航支持 - 改进版
            document.addEventListener('keydown', function(e) {
                // 只在聊天面板获得焦点时响应
                if (!e.target.closest('.panel-left')) return;

                let handled = false;

                switch(e.key) {
                    case 'PageUp':
                        e.preventDefault();
                        chatArea.scrollBy({ top: -chatArea.clientHeight * 0.8, behavior: 'smooth' });
                        handled = true;
                        break;
                    case 'PageDown':
                        e.preventDefault();
                        chatArea.scrollBy({ top: chatArea.clientHeight * 0.8, behavior: 'smooth' });
                        handled = true;
                        break;
                    case 'Home':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollTo({ top: 0, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                    case 'End':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
                            setTimeout(ensureInputVisible, 200);
                            handled = true;
                        }
                        break;
                    case 'ArrowUp':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollBy({ top: -30, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                    case 'ArrowDown':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollBy({ top: 30, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                }

                if (handled) {
                    // 更新自动滚动状态
                    const isNearBottom = chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 50;
                    autoScrollEnabled = isNearBottom;
                }
            });

            // 滚动指示器
            function showScrollIndicator(direction) {
                let indicator = document.getElementById('chat-scroll-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'chat-scroll-indicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 50%;
                        right: 30px;
                        background: var(--secondary-color);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 20px;
                        z-index: 1000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                        pointer-events: none;
                        font-size: 14px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    `;
                    document.body.appendChild(indicator);
                }

                indicator.innerHTML = direction === 'down' ?
                    '<i class="fas fa-arrow-down"></i> 向下滚动' :
                    '<i class="fas fa-arrow-up"></i> 向上滚动';
                indicator.style.opacity = '0.8';
            }

            function hideScrollIndicator() {
                const indicator = document.getElementById('chat-scroll-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                }
            }

            // 确保聊天区域可以获得焦点
            chatArea.setAttribute('tabindex', '0');

            // 点击聊天区域时获得焦点
            chatArea.addEventListener('click', function() {
                chatArea.focus();
            });

            // 新消息添加时的智能滚动
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // 检查是否添加了新消息
                        const addedMessage = Array.from(mutation.addedNodes).find(node =>
                            node.nodeType === 1 && node.classList.contains('message')
                        );

                        if (addedMessage && autoScrollEnabled && !isScrolling) {
                            setTimeout(() => {
                                chatArea.scrollTo({
                                    top: chatArea.scrollHeight,
                                    behavior: 'smooth'
                                });
                                setTimeout(ensureInputVisible, 200);
                            }, 100);
                        }
                    }
                });
            });

            observer.observe(chatArea, { childList: true });

            // 窗口大小变化时确保输入框可见
            window.addEventListener('resize', () => {
                setTimeout(ensureInputVisible, 100);
            });

            // 初始化时确保输入框可见
            setTimeout(ensureInputVisible, 500);
        }

        // 通用通知函数
        function showNotification(message, type = 'info', options = {}) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            // 根据类型设置图标和颜色
            let icon = 'fas fa-info-circle';
            let bgColor = 'var(--primary-color)';

            switch(type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    bgColor = 'var(--accent-color)';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    bgColor = '#e74c3c';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    bgColor = '#f39c12';
                    break;
            }

            let detailsHtml = '';
            if (options.details && options.details.length > 0) {
                detailsHtml = `
                    <div class="notification-details">
                        ${options.details.map(detail => `<div>• ${detail}</div>`).join('')}
                    </div>
                `;
            }

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-header">
                        <i class="${icon}"></i>
                        <span>${message}</span>
                        <button class="notification-close" onclick="this.closest('.notification').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${detailsHtml}
                </div>
            `;

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            `;

            document.body.appendChild(notification);

            // 动画显示
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // 自动隐藏
            const autoHideDelay = options.autoHide !== false ? (options.duration || 5000) : 0;
            if (autoHideDelay > 0) {
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, autoHideDelay);
            }

            // 返回通知元素，以便外部控制
            return notification;
        }

        // 测试图片加载功能
        function testImageLoad() {
            console.log('开始测试图片加载功能');

            // 创建测试图片数据
            const testImageData = {
                id: Date.now(),
                title: '测试图片 (test.png)',
                data: {
                    image_url: '/api/serve_image?path=test_images/test.png',
                    file_name: 'test.png',
                    file_size: '584 B',
                    file_path: 'test_images/test.png',
                    width: 200,
                    height: 200
                }
            };

            console.log('创建测试图片卡片:', testImageData);
            createImageCard(testImageData);

            // 显示测试信息
            const notification = document.createElement('div');
            notification.textContent = '已添加测试图片，请查看加载状态';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.style.opacity = '1', 10);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 测试图片监控功能
        function testImageMonitor() {
            console.log('开始测试图片监控功能');

            // 创建监控测试图片数据
            const testImageData = {
                id: Date.now(),
                title: '监控测试图片 (monitor_test.png)',
                data: {
                    image_url: '/api/serve_image?path=test_images/monitor_test.png',
                    file_name: 'monitor_test.png',
                    file_size: '584 B',
                    file_path: 'test_images/monitor_test.png',
                    width: 200,
                    height: 200
                }
            };

            console.log('创建监控测试图片卡片:', testImageData);
            createImageCard(testImageData);

            // 显示测试信息
            showNotification('已添加监控测试图片', 'info', {
                details: [
                    '图片路径: test_images/monitor_test.png',
                    '监控间隔: 1.5秒',
                    '请修改该图片文件来测试自动更新功能'
                ],
                duration: 8000
            });

            // 5秒后自动更新图片来演示监控功能
            setTimeout(() => {
                fetch('/api/update_test_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: 'test_images/monitor_test.png',
                        color: 'red'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('测试图片已自动更新', 'success', {
                            details: ['图片颜色已改为红色', '请观察图片是否自动刷新']
                        });
                    }
                })
                .catch(error => {
                    console.error('更新测试图片失败:', error);
                });
            }, 5000);
        }

        // 测试图片上传功能
        function testImageUpload() {
            console.log('开始测试图片上传功能');

            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log('选择的文件:', file.name, file.size, 'bytes');
                    handleImageFile(file);
                }
                // 清理临时元素
                document.body.removeChild(fileInput);
            };

            // 添加到页面并触发点击
            document.body.appendChild(fileInput);
            fileInput.click();

            // 显示提示信息
            showNotification('请选择图片文件进行上传测试', 'info', {
                details: [
                    '支持格式: PNG, JPG, JPEG, GIF, BMP, WEBP',
                    '最大大小: 100MB',
                    '上传后支持刷新和监控功能'
                ]
            });
        }
    </script>
    
    <script>
    window.difyChatbotConfig = {
    token: '40RIQ28SQ21P3Ync',
    baseUrl: 'http://localhost',
    systemVariables: {
        // user_id: 'YOU CAN DEFINE USER ID HERE',
        // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
    },
    userVariables: {
        // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
        // name: 'YOU CAN DEFINE USER NAME HERE',
    },
    }
    </script>
    <script
    src="http://localhost/embed.min.js"
    id="40RIQ28SQ21P3Ync"
    defer>
    </script>
    <style>
    #dify-chatbot-bubble-button {
        background-color: #1C64F2 !important;
    }
    #dify-chatbot-bubble-window {
        width: 24rem !important;
        height: 40rem !important;
    }
    </style>
</body>
</html>

