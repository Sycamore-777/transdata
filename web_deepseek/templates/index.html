<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›®æ ‡æ£€æµ‹ä¸æ„å›¾è¯†åˆ«æ¼”ç¤ºç³»ç»Ÿ</title>
    <!-- ç¦»çº¿æ¨¡å¼ï¼šä½¿ç”¨æœ¬åœ°èµ„æº -->
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <script src="/static/js/chart.min.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <style>


        :root {
            --primary-color: #0f9d58; /* ç§‘æŠ€ç»¿ */
            --secondary-color: #4285f4; /* ç§‘æŠ€è“ */
            --accent-color: #f4b400; /* ç§‘æŠ€é»„ */
            --dark-bg: #0a1929; /* æ·±è‰²èƒŒæ™¯ */
            --card-bg: #1a2a3a; /* å¡ç‰‡èƒŒæ™¯ */
            --text-light: #e0f2fe; /* æµ…è‰²æ–‡æœ¬ */
            --text-gray: #a0aec0; /* ç°è‰²æ–‡æœ¬ */
            --border-color: #2d3748; /* è¾¹æ¡†é¢œè‰² */
        }

        /* æ‹–æ‹½åˆ†éš”æ¡æ ·å¼ */
        .resize-handle {
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            transition: background-color 0.2s ease;
            width: 4px;
            min-width: 4px;
            max-width: 4px;
        }

        .resize-handle:hover {
            background: var(--primary-color);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: currentColor;
            border-radius: 1px;
            opacity: 0.6;
        }

        .resize-handle.resizing {
            background: var(--primary-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #0c1a29 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            margin: 0;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 15px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(15, 157, 88, 0.3);
            letter-spacing: 1px;
        }
        
        .header p {
            color: var(--text-gray);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            display: flex;
            gap: 0; /* ç§»é™¤gapï¼Œä½¿ç”¨åˆ†éš”æ¡ */
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
            height: calc(100vh - 120px);
            min-height: 400px; /* æœ€å°é«˜åº¦ */
            max-height: 200vh; /* æœ€å¤§é«˜åº¦ */
            overflow: auto; /* è¶…å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            transition: height 0.1s ease; /* å¹³æ»‘è¿‡æ¸¡ */
            position: relative;
        }
        
        /* å·¦ä¾§é¢æ¿ - é—®ç­”åŒºåŸŸ */
        .panel-left {
            flex: 1;
            min-width: 500px;
            background: rgba(26, 42, 58, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(66, 133, 244, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
            min-height: 500px;
        }
        
        /* å³ä¾§é¢æ¿ - åŠ¨æ€å±•ç¤ºåŒº */
        .panel-right {
            width: 45%;
            min-width: min(300px, 30vw); /* æ ¹æ®è§†å£åŠ¨æ€è°ƒæ•´æœ€å°å®½åº¦ */
            max-width: calc(100vw - 320px); /* ç¡®ä¿ä¸è¶…å‡ºè§†å£ */
            background: rgba(26, 42, 58, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(66, 133, 244, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: min(500px, 60vh); /* æ ¹æ®è§†å£åŠ¨æ€è°ƒæ•´æœ€å°é«˜åº¦ */
            z-index: 10;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        /* é¢æ¿æ ‡é¢˜ */
        .panel-title {
            padding: 6px 8px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* æ‹–æ‹½æŒ‡é’ˆ */
            user-select: none; /* é˜²æ­¢æ–‡æœ¬é€‰æ‹© */
            flex-wrap: wrap;
            gap: 4px; /* å¤§å¹…å‡å°é—´è· */
            position: sticky; /* æ”¹ä¸ºç²˜æ€§å®šä½ */
            top: 0; /* ç²˜åœ¨é¡¶éƒ¨ */
            z-index: 100; /* ç¡®ä¿æ ‡é¢˜æ åœ¨æœ€ä¸Šå±‚ */
            background: rgba(26, 42, 58, 0.95); /* å¢åŠ èƒŒæ™¯é€æ˜åº¦ç¡®ä¿å¯è§æ€§ */
            backdrop-filter: blur(10px); /* æ·»åŠ æ¨¡ç³Šæ•ˆæœ */
            flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
            font-size: 0.75rem; /* å¤§å¹…å‡å°å­—ä½“ */
            min-height: 32px; /* è®¾ç½®æœ€å°é«˜åº¦ */
        }
        
        .title-left, .title-center, .title-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ç¡®ä¿èŠå¤©æ¨¡å¼åˆ‡æ¢æŒ‰é’®å§‹ç»ˆå¯è§ */
        .chat-mode-switch {
            display: flex;
            gap: 5px;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }

        .mode-btn {
            white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
            min-width: 80px; /* è®¾ç½®æœ€å°å®½åº¦ */
        }

        .title-left {
            flex: 1;
            flex-direction: column;
            align-items: flex-start;
        }

        .title-center {
            flex: 0 0 auto;
        }

        .title-right {
            flex: 0 0 auto;
        }

        .panel-title h2 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .panel-title h2 i {
            color: var(--secondary-color);
        }

        .model-info {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 5px;
        }
        
        /* æ¨¡å‹é€‰æ‹©åŒºåŸŸ */
        .model-selector {
            padding: 15px 20px;
            background: rgba(15, 157, 88, 0.1);
            border-bottom: 1px solid var(--border-color);
        }
        
        .model-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .model-controls select {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            min-width: 200px;
        }
        
        .model-controls input {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
            min-width: 200px;
        }
        
        .model-controls button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .model-controls button:hover {
            background: #0d8a4d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(15, 157, 88, 0.3);
        }
        
        /* API é…ç½®æ¨¡æ€æ¡† */
        .api-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .api-config-modal.active {
            display: flex;
        }

        .api-config {
            background: var(--dark-bg);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .api-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .api-config-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .api-config-close {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .api-config-close:hover {
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .api-input {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .api-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .api-input label {
            width: 150px;
            font-weight: 500;
            color: var(--text-gray);
        }
        
        .api-input input {
            flex: 1;
            padding: 10px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .api-input button {
            padding: 10px 20px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .api-input button:hover {
            background: #3b78e7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        .api-status {
            font-size: 0.9rem;
            padding: 10px 15px;
            border-radius: 8px;
            background: rgba(26, 42, 58, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .api-status i {
            color: #f44336; /* é»˜è®¤çº¢è‰² */
        }
        
        .api-status.valid i {
            color: var(--primary-color); /* éªŒè¯é€šè¿‡ç»¿è‰² */
        }
        
        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            padding: 5px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px; /* å¤§å¹…å‡å°é—´è· */
            position: relative;
            min-height: 150px; /* å¤§å¹…å‡å°æœ€å°é«˜åº¦ */
            /* æ”¹è¿›æ»šåŠ¨ä½“éªŒ */
            scroll-behavior: smooth; /* å¹³æ»‘æ»šåŠ¨ */
            scrollbar-width: thin; /* Firefox ç»†æ»šåŠ¨æ¡ */
            scrollbar-color: var(--primary-color) transparent; /* Firefox æ»šåŠ¨æ¡é¢œè‰² */
        }

        /* Webkit æµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* è‡ªå®šä¹‰æ‹–æ‹½åŒºåŸŸæ ·å¼ */
        .chat-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(-45deg, transparent 0%, transparent 30%, var(--secondary-color) 30%, var(--secondary-color) 35%, transparent 35%, transparent 65%, var(--secondary-color) 65%, var(--secondary-color) 70%, transparent 70%);
            cursor: nw-resize;
            z-index: 10;
        }

        .chat-resize-handle:hover {
            background: linear-gradient(-45deg, transparent 0%, transparent 30%, var(--primary-color) 30%, var(--primary-color) 35%, transparent 35%, transparent 65%, var(--primary-color) 65%, var(--primary-color) 70%, transparent 70%);
        }

        /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .image-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: var(--secondary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .image-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(15, 157, 88, 0.1);
        }

        /* å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .image-preview:hover {
            transform: scale(1.05);
        }

        /* å›¾ç‰‡ä¿¡æ¯æ˜¾ç¤º */
        .image-info {
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 5px;
        }

        /* å›¾ç‰‡ç¼©æ”¾æ§åˆ¶ */
        .image-controls {
            display: flex;
            gap: 2px; /* æœ€å°åŒ–æŒ‰é’®é—´è· */
            justify-content: center;
            margin: 1px 0; /* æœ€å°åŒ–ä¸Šä¸‹è¾¹è· */
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
            padding: 0; /* ç§»é™¤å†…è¾¹è· */
            position: absolute; /* ç»å¯¹å®šä½ï¼Œä¸å ç”¨å¸ƒå±€ç©ºé—´ */
            bottom: 5px; /* è·ç¦»åº•éƒ¨5px */
            left: 50%; /* æ°´å¹³å±…ä¸­ */
            transform: translateX(-50%); /* å®Œæˆå±…ä¸­ */
            z-index: 10; /* ç¡®ä¿åœ¨å›¾ç‰‡ä¸Šæ–¹ */
            background: rgba(0, 0, 0, 0.7); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 15px; /* åœ†è§’èƒŒæ™¯ */
            padding: 3px 8px; /* èƒŒæ™¯å†…è¾¹è· */
        }

        .image-controls button {
            padding: 2px 4px; /* æœ€å°åŒ–æŒ‰é’®å†…è¾¹è· */
            background: transparent; /* é€æ˜èƒŒæ™¯ */
            color: white; /* ç™½è‰²æ–‡å­— */
            border: none;
            border-radius: 2px; /* æœ€å°åŒ–åœ†è§’ */
            cursor: pointer;
            font-size: 0.6rem; /* è¿›ä¸€æ­¥å‡å°å­—ä½“ */
            min-height: 16px; /* å‡å°æœ€å°é«˜åº¦ */
            line-height: 1; /* ç´§å‡‘è¡Œé«˜ */
        }

        .image-controls button:hover {
            background: rgba(255, 255, 255, 0.2); /* æ‚¬åœæ—¶çš„èƒŒæ™¯ */
        }



        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--accent-color);
        }

        /* é™„ä»¶é¢„è§ˆæ ·å¼ */
        .attachment-preview {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attachment-item i {
            margin-right: 8px;
            color: var(--secondary-color);
        }

        .attachment-item .remove-attachment {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            padding: 2px;
        }

        .attachment-item .remove-attachment:hover {
            color: #f44336;
        }

        /* é™„ä»¶æŒ‰é’®æ ·å¼ */
        #attachment-btn {
            padding: 0 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #attachment-btn:hover {
            background: #e6a700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 180, 0, 0.3);
        }

        /* èŠå¤©æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .chat-mode-switch {
            display: flex;
            gap: 5px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            background: transparent;
            color: var(--text-gray);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: rgba(66, 133, 244, 0.2);
            color: var(--text-light);
        }

        .mode-btn.active {
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }

        /* iframeå®¹å™¨æ ·å¼ */
        .iframe-container {
            flex: 1;
            display: none;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 400px;
            /* ç§»é™¤max-heighté™åˆ¶ï¼Œè®©å®ƒè‡ªç„¶é€‚åº”å®¹å™¨ */
        }
        
        .iframe-container.active {
            display: flex;
            flex-direction: column;
        }
        
        .iframe-container iframe {
            width: 100%;
            flex: 1;
            border: none;
            background: var(--card-bg);
            border-radius: 10px;
        }



        /* æœ¬åœ°èŠå¤©åŒºåŸŸ */
        .local-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        .local-chat-container.hidden {
            display: none;
        }
        
        .message {
            display: flex;
            gap: 6px; /* å¤§å¹…å‡å°é—´è· */
            animation: fadeIn 0.3s ease;
            margin-bottom: 4px; /* å¤§å¹…å‡å°æ¶ˆæ¯é—´è· */
        }

        .message-avatar {
            width: 24px; /* å¤§å¹…å‡å°å¤´åƒå°ºå¯¸ */
            height: 24px;
            border-radius: 50%;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.65rem; /* å¤§å¹…å‡å°å¤´åƒå†…å›¾æ ‡å°ºå¯¸ */
        }
        
        .user .message-avatar {
            background: var(--accent-color);
        }
        
        .message-content {
            flex: 1;
            padding: 6px 8px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            border-radius: 6px; /* å¤§å¹…å‡å°åœ†è§’ */
            background: var(--card-bg);
            line-height: 1.3; /* å¤§å¹…å‡å°è¡Œé«˜ */
            font-size: 0.8rem; /* å¤§å¹…å‡å°å­—ä½“ */
        }
        
        .user .message-content {
            background: rgba(66, 133, 244, 0.15);
            border: 1px solid rgba(66, 133, 244, 0.3);
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 6px 8px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            border-top: 1px solid var(--border-color);
        }

        .input-container {
            display: flex;
            gap: 6px; /* å¤§å¹…å‡å°é—´è· */
            align-items: center;
        }
        
        .input-container input {
            flex: 1;
            padding: 6px 8px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px; /* å¤§å¹…å‡å°åœ†è§’ */
            color: var(--text-light);
            font-size: 0.75rem; /* å¤§å¹…å‡å°å­—ä½“ */
            height: 28px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
        }

        .input-container button {
            padding: 6px 12px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px; /* å¤§å¹…å‡å°åœ†è§’ */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.75rem; /* å¤§å¹…å‡å°å­—ä½“ */
            height: 28px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
        }
        
        .input-container button:hover {
            background: #3b78e7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }
        
        /* åŠ¨æ€å±•ç¤ºåŒºæ§åˆ¶ */
        .dashboard-controls {
            display: flex;
            gap: 6px; /* å¤§å¹…å‡å°é—´è· */
            margin-bottom: 8px; /* å¤§å¹…å‡å°å¤–è¾¹è· */
        }

        .dashboard-controls button {
            flex: 1;
            padding: 6px 4px; /* å¤§å¹…å‡å°å†…è¾¹è· */
            background: rgba(66, 133, 244, 0.2);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            border-radius: 4px; /* å‡å°åœ†è§’ */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* å‡å°é—´è· */
            font-size: 0.7rem; /* å¤§å¹…å‡å°å­—ä½“ */
            min-height: 28px; /* è®¾ç½®æœ€å°é«˜åº¦ */
        }

        .dashboard-controls button:hover {
            background: rgba(66, 133, 244, 0.4);
            transform: translateY(-1px); /* å‡å°æ‚¬åœæ•ˆæœ */
        }
        
        /* å¡ç‰‡å®¹å™¨ */
        .cards-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* å¢å¤§æœ€å°å®½åº¦ */
            grid-auto-rows: minmax(300px, auto); /* å¤§å¹…å¢å¤§æœ€å°é«˜åº¦ */
            gap: 10px; /* å¢åŠ é—´è·é˜²æ­¢é‡å  */
            overflow-y: auto;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æº¢å‡º */
            padding: 8px; /* å¢åŠ å®¹å™¨å†…è¾¹è· */
            align-content: start;
            /* é˜²æ­¢å¡ç‰‡é‡å çš„å…³é”®è®¾ç½® */
            grid-auto-flow: row; /* ç¡®ä¿å¡ç‰‡æŒ‰è¡Œæ’åˆ— */
            align-items: start; /* å¡ç‰‡é¡¶éƒ¨å¯¹é½ */
            /* å¼ºåˆ¶ç½‘æ ¼å¸ƒå±€ï¼Œé˜²æ­¢é‡å  */
            grid-template-rows: repeat(auto-fit, minmax(300px, auto));
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 6px; /* å¤§å¹…å‡å°åœ†è§’ */
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* å¤§å¹…å‡å°é˜´å½± */
            display: flex;
            flex-direction: column;
            resize: both; /* å…è®¸æ‹–æ‹½è°ƒæ•´å¤§å° */
            min-width: 200px; /* å¢å¤§æœ€å°å®½åº¦ */
            min-height: 300px; /* å¤§å¹…å¢å¤§æœ€å°é«˜åº¦ */
            /* å¤§å¹…å¢å¤§æœ€å¤§å°ºå¯¸é™åˆ¶ */
            max-width: min(1600px, 95vw); /* å¢å¤§åˆ°1600pxæˆ–95%è§†å£å®½åº¦ */
            max-height: min(1200px, 90vh); /* å¢å¤§åˆ°1200pxæˆ–90%è§†å£é«˜åº¦ */
            position: relative; /* ä¸ºæ‹–æ‹½æ‰‹æŸ„å®šä½ */
            contain: layout; /* é˜²æ­¢å†…å®¹æº¢å‡ºå½±å“å¸ƒå±€ */
            /* é˜²æ­¢é‡å çš„å…³é”®è®¾ç½® */
            z-index: 1; /* ç¡®ä¿å¡ç‰‡åœ¨æ­£ç¡®çš„å±‚çº§ */
            isolation: isolate; /* åˆ›å»ºæ–°çš„å †å ä¸Šä¸‹æ–‡ */
            /* å¼ºåˆ¶ç½‘æ ¼å¯¹é½ï¼Œé˜²æ­¢é‡å  */
            grid-column: auto;
            grid-row: auto;
            align-self: start;
            justify-self: start;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(15, 157, 88, 0.3);
            border-color: rgba(15, 157, 88, 0.5);
            z-index: 10; /* æ‚¬åœæ—¶æå‡å±‚çº§ */
        }

        /* å¡ç‰‡resizeæ—¶çš„æ ·å¼ */
        .card:active,
        .card:focus-within {
            z-index: 20; /* resizeæ—¶æå‡åˆ°æœ€é«˜å±‚çº§ */
        }

        /* é˜²æ­¢å¡ç‰‡resizeæ—¶è¶…å‡ºå®¹å™¨ */
        .cards-container .card {
            box-sizing: border-box;
            margin: 0; /* ç¡®ä¿æ²¡æœ‰é¢å¤–çš„å¤–è¾¹è· */
        }
        
        .card-header {
            padding: 2px 4px; /* æœ€å°åŒ–å†…è¾¹è· */
            background: rgba(15, 157, 88, 0.1);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 18px; /* è¿›ä¸€æ­¥å‡å°æœ€å°é«˜åº¦ */
            height: 18px; /* å›ºå®šé«˜åº¦ */
            flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
            box-sizing: border-box;
        }

        .card-title {
            font-size: 0.75rem; /* å¤§å¹…å‡å°å­—ä½“ */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px; /* å¤§å¹…å‡å°é—´è· */
            line-height: 1.2;
        }
        
        .card-actions button {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 2px; /* å‡å°æŒ‰é’®å†…è¾¹è· */
            font-size: 0.7rem; /* å‡å°æŒ‰é’®å­—ä½“ */
            width: 20px; /* è®¾ç½®å›ºå®šå®½åº¦ */
            height: 20px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
        }

        .card-actions button:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .card-content {
            flex: 1;
            height: 100%; /* ç¡®ä¿å†…å®¹åŒºåŸŸå¡«å……æ•´ä¸ªå¯ç”¨ç©ºé—´ */
            padding: 0; /* å®Œå…¨ç§»é™¤å†…è¾¹è· */
            margin: 0; /* å®Œå…¨ç§»é™¤å¤–è¾¹è· */
            display: flex;
            flex-direction: column;
            font-size: 0.7rem; /* å¤§å¹…å‡å°å­—ä½“ */
            line-height: 1.2;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .chart-container {
            width: 100%;
            height: 180px;
        }
        
        .image-container {
            width: 100%;
            height: 100%; /* ç¡®ä¿å®¹å™¨å¡«å……æ•´ä¸ªå¯ç”¨ç©ºé—´ */
            flex: 1; /* è®©å›¾ç‰‡å®¹å™¨å æ®å¡ç‰‡çš„å¤§éƒ¨åˆ†ç©ºé—´ */
            display: flex; /* ä½¿ç”¨flexå¸ƒå±€ä»¥ä¾¿å›¾ç‰‡å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            overflow: hidden;
            margin: 0; /* ç§»é™¤å¤–è¾¹è· */
            padding: 0; /* ç§»é™¤å†…è¾¹è· */
            position: relative; /* ä¸ºç»å¯¹å®šä½çš„æ§åˆ¶æŒ‰é’®æä¾›å®šä½ä¸Šä¸‹æ–‡ */
            box-sizing: border-box; /* ç¡®ä¿è¾¹æ¡†ä¸å½±å“å°ºå¯¸ */
            background: #f8f9fa; /* æ·»åŠ æµ…è‰²èƒŒæ™¯ï¼Œä¾¿äºçœ‹æ¸…å›¾ç‰‡è¾¹ç•Œ */
        }

        .image-container img {
            max-width: 100%; /* æœ€å¤§å®½åº¦ä¸è¶…è¿‡å®¹å™¨ */
            max-height: 100%; /* æœ€å¤§é«˜åº¦ä¸è¶…è¿‡å®¹å™¨ */
            width: auto; /* è‡ªåŠ¨å®½åº¦ä»¥ä¿æŒæ¯”ä¾‹ */
            height: auto; /* è‡ªåŠ¨é«˜åº¦ä»¥ä¿æŒæ¯”ä¾‹ */
            display: block; /* ç¡®ä¿å›¾ç‰‡ä¸ºå—çº§å…ƒç´  */
            margin: 0 !important; /* å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å¤–è¾¹è· */
            padding: 0 !important; /* å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å†…è¾¹è· */
            border: none !important; /* ç§»é™¤è¾¹æ¡† */
            border-radius: 4px; /* æ¢å¤è½»å¾®åœ†è§’ */
            object-fit: contain; /* æ˜¾ç¤ºå®Œæ•´å›¾ç‰‡ */
            object-position: center; /* å±…ä¸­æ˜¾ç¤º */
            transition: transform 0.3s ease;
            box-sizing: border-box; /* ç¡®ä¿è¾¹æ¡†ä¸å½±å“å°ºå¯¸ */
        }

        /* å›¾ç‰‡æ‚¬åœæ•ˆæœ */
        .image-container:hover img {
            transform: scale(1.05);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-enter {
            animation: fadeIn 0.4s ease;
        }
        
        /* å“åº”å¼è®¾è®¡ - å¢å¼ºç‰ˆ */
        @media (max-width: 1600px) {
            .panel-right {
                width: 42%;
                min-width: min(280px, 25vw);
            }

            .card {
                max-width: min(1400px, 90vw);
                max-height: min(1000px, 85vh);
            }
        }

        @media (max-width: 1400px) {
            .container {
                padding: 0 5px;
            }

            .panel-right {
                width: 40%;
                min-width: min(250px, 22vw);
            }

            .card {
                max-width: min(1200px, 88vw);
                max-height: min(900px, 80vh);
            }
        }

        @media (max-width: 1200px) {
            .panel-right {
                width: 38%;
                min-width: min(220px, 20vw);
            }

            .card {
                max-width: min(1000px, 85vw);
                max-height: min(800px, 75vh);
            }
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
                gap: 10px;
            }

            .panel-left, .panel-right {
                width: 100%;
                min-width: auto;
                height: auto;
                min-height: 400px;
            }

            .panel-left {
                order: 1;
            }

            .panel-right {
                order: 2;
                max-height: 500px;
            }

            .api-input-row {
                flex-direction: column;
                align-items: stretch;
            }

            .api-input label {
                width: auto;
                margin-bottom: 5px;
            }

            .model-controls {
                flex-direction: column;
            }

            .chat-area {
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 10px 0;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .panel-title {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .title-left, .title-center, .title-right {
                justify-content: center;
            }

            .chat-mode-switch {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(26, 42, 58, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3b78e7;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å›¾ç‰‡æ›´æ–°é€šçŸ¥åŠ¨ç”» */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* ç›‘æ§çŠ¶æ€æ ·å¼ */
        .monitoring-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .monitoring-status i {
            font-size: 8px;
        }

        /* æ»šåŠ¨æŒ‡ç¤ºå™¨æ ·å¼ */
        #chat-scroll-indicator {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        /* å›¾ç‰‡å®¹å™¨æ‚¬åœæ•ˆæœ */
        .image-container:hover .image-preview {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }

        /* å›¾ç‰‡åŠ è½½çŠ¶æ€æ ·å¼ */
        .image-loading, .image-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: var(--text-gray);
            gap: 10px;
        }

        .image-loading i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .image-error i {
            font-size: 2rem;
            color: var(--accent-color);
        }

        .image-error button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .image-error button:hover {
            background: var(--secondary-color);
        }

        /* æ–‡æœ¬é¢„è§ˆæ ·å¼ */
        .text-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .text-preview pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .text-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .text-controls button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .text-controls button:hover {
            background: var(--secondary-color);
        }

        /* æ–‡ä»¶é¢„è§ˆæ ·å¼ */
        .file-preview {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .file-icon {
            margin-bottom: 15px;
        }

        /* æ–‡æœ¬æ¨¡æ€æ¡†æ ·å¼ */
        .text-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .text-modal-content {
            background: var(--dark-bg);
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .text-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .text-modal-header h3 {
            margin: 0;
            color: var(--text-light);
        }

        .text-modal-header button {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .text-modal-header button:hover {
            color: var(--text-light);
        }

        .text-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .text-modal-body pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-light);
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            font-size: 0.9rem;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .notification-header i {
            font-size: 1.1rem;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px;
            margin-left: auto;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-details {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-details div {
            margin: 2px 0;
        }
        
        /* æ¨¡å‹çŠ¶æ€æ ‡ç­¾ */
        .model-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .model-status.connected {
            background: rgba(15, 157, 88, 0.2);
            color: var(--primary-color);
        }
        
        /* è®¾ç½®æŒ‰é’® */
        .settings-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 6px; /* å‡å°å†…è¾¹è· */
            border-radius: 50%;
            margin-left: 3px; /* æŒ‰é’®é—´è· */
            font-size: 0.9rem; /* ç¨å¾®å‡å°å›¾æ ‡å¤§å° */
        }

        .settings-btn:hover {
            color: var(--secondary-color);
            background: rgba(66, 133, 244, 0.1);
        }

        .title-right {
            display: flex;
            align-items: center;
            gap: 2px; /* æŒ‰é’®ç»„é—´è· */
        }

        /* é«˜åº¦è°ƒæ•´æŒ‡ç¤ºå™¨ */
        .height-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .height-indicator.show {
            opacity: 1;
        }
        
        /* æ¨¡å‹è¿æ¥ä¿¡æ¯ */
        .model-connection-info {
            margin-top: 10px;
            padding: 15px;
            background: rgba(26, 42, 58, 0.5);
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .model-connection-info h4 {
            margin-bottom: 10px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-model-input {
            display: none;
            margin-top: 10px;
        }
        
        .custom-model-input.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1><span class="icon">ğŸ¤–</span> ç›®æ ‡æ£€æµ‹ä¸æ„å›¾è¯†åˆ«æ¼”ç¤ºç³»ç»Ÿ</h1>
    </div>
    
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ï¼šé—®ç­”åŒºåŸŸ -->
        <div class="panel-left" id="panel-left">
            <div class="panel-title">
                <div class="title-left">
                    <h2 id="panel-title-text"><i class="fas fa-comments"></i> æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</h2>
                    <div class="model-info">å½“å‰æ¨¡å‹: <span id="current-model">æœªé…ç½®</span> <span class="model-status" id="model-status">æœªè¿æ¥</span></div>
                </div>
                <div class="title-center">
                    <div class="chat-mode-switch">
                        <button id="local-chat-btn" class="mode-btn active">æœ¬åœ°é—®ç­”</button>
                        <button id="iframe-chat-btn" class="mode-btn">å¤–éƒ¨èŠå¤©</button>
                    </div>
                </div>
                <div class="title-right">
                    <button class="settings-btn" id="clear-chat-btn" title="æ¸…ç©ºèŠå¤©è®°å½•"><i class="fas fa-broom"></i></button>
                    <button class="settings-btn" id="api-settings-btn" title="APIè®¾ç½®"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            

            
            <!-- æœ¬åœ°èŠå¤©å®¹å™¨ -->
            <div class="local-chat-container" id="local-chat-container">
                <div class="model-selector">
                    <div class="model-controls">
                        <select id="model-select">
                            <option value="default">ä½¿ç”¨é»˜è®¤æ¨¡å‹</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                        </select>
                        
                        <div class="custom-model-input" id="custom-model-input">
                            <input type="text" id="custom-model-name" placeholder="è¾“å…¥æ¨¡å‹åç§°ï¼ˆå¦‚ï¼šmy-custom-modelï¼‰">
                        </div>
                        
                        <button id="model-save"><i class="fas fa-sync-alt"></i> åº”ç”¨æ¨¡å‹</button>
                    </div>
                </div>
                
                <div class="chat-area" id="chat-area">
                    <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    <div class="message system">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <h3>æ¬¢è¿ä½¿ç”¨ç›®æ ‡æ£€æµ‹ä¸æ„å›¾è¯†åˆ«æ¼”ç¤ºç³»ç»Ÿï¼</h3>
                            <p><strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong></p>
                            <ol>
                                <li>ç‚¹å‡»å³ä¸Šè§’ <i class="fas fa-cog"></i> å›¾æ ‡é…ç½®APIæœåŠ¡</li>
                                <li>è¾“å…¥APIåŸºç¡€åœ°å€ã€å¯†é’¥å’Œé»˜è®¤æ¨¡å‹åç§°</li>
                                <li>åœ¨ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©æˆ–è¾“å…¥è¦ä½¿ç”¨çš„æ¨¡å‹</li>
                                <li>åœ¨ä¸‹æ–¹è¾“å…¥é—®é¢˜å¼€å§‹å¯¹è¯</li>
                            </ol>
                            <p>å³ä¾§ä»ªè¡¨ç›˜å¯æ·»åŠ å¯è§†åŒ–å¡ç‰‡ï¼Œå±•ç¤ºæ£€æµ‹ç»“æœå’Œåˆ†ææ•°æ®ã€‚</p>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <input type="text" id="user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå¦‚ä½•æé«˜ç›®æ ‡æ£€æµ‹çš„å‡†ç¡®ç‡ï¼Ÿ">
                        <input type="file" id="attachment-input" accept="image/*,text/*,.pdf,.doc,.docx" style="display: none;" multiple>
                        <button id="attachment-btn" title="ä¸Šä¼ é™„ä»¶"><i class="fas fa-paperclip"></i></button>
                        <button id="send-btn"><i class="fas fa-paper-plane"></i> å‘é€</button>
                    </div>
                    <div id="attachment-preview" class="attachment-preview"></div>
                </div>
            </div>

            <!-- iframeèŠå¤©å®¹å™¨ -->
            <div class="iframe-container" id="iframe-container">
                <iframe
                    src="http://localhost/chatbot/40RIQ28SQ21P3Ync"
                    frameborder="0"
                    allow="microphone">
                </iframe>
            </div>
        </div>

        <!-- æ‹–æ‹½åˆ†éš”æ¡ -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- å³ä¾§é¢æ¿ï¼šåŠ¨æ€å±•ç¤ºåŒº -->
        <div class="panel-right" id="panel-right">
            <div class="panel-title">
                <h2><i class="fas fa-chart-line"></i> åˆ†æä»ªè¡¨ç›˜</h2>
                <div class="card-count">å¡ç‰‡: <span id="card-count">3</span></div>
            </div>
            
            <div class="dashboard-controls">
                <button id="add-chart-btn"><i class="fas fa-chart-bar"></i> æ·»åŠ å›¾è¡¨</button>
                <button id="add-image-btn"><i class="fas fa-image"></i> æ·»åŠ å›¾ç‰‡</button>
                <button id="test-image-btn"><i class="fas fa-vial"></i> æµ‹è¯•å›¾ç‰‡</button>
                <button id="test-monitor-btn"><i class="fas fa-eye"></i> æµ‹è¯•ç›‘æ§</button>
                <button id="test-upload-btn"><i class="fas fa-upload"></i> æµ‹è¯•ä¸Šä¼ </button>
                <button id="clear-cards-btn"><i class="fas fa-trash-alt"></i> æ¸…ç©ºå¡ç‰‡</button>
            </div>
            
            <div class="cards-container" id="cards-container">
                <!-- å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-microchip"></i> æ¨¡å‹åˆ†å¸ƒ</div>
                        <div class="card-actions">
                            <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                            <button class="delete-card" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="modelDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-camera"></i> æ£€æµ‹ç»“æœ</div>
                        <div class="card-actions">
                            <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                            <button class="delete-card" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="image-container">
                            <img src="https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80" alt="ç›®æ ‡æ£€æµ‹ç¤ºä¾‹">
                        </div>
                    </div>
                </div>
                
                <div class="card card-enter">
                    <div class="card-header">
                        <div class="card-title"><i class="fas fa-bolt"></i> æ€§èƒ½å¯¹æ¯”</div>
                        <div class="card-actions">
                            <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                            <button class="delete-card" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API é…ç½®æ¨¡æ€æ¡† -->
    <div class="api-config-modal" id="api-config-modal">
        <div class="api-config">
            <div class="api-config-header">
                <div class="api-config-title">
                    <i class="fas fa-cog"></i> API é…ç½®
                </div>
                <button class="api-config-close" onclick="closeApiConfig()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="api-input">
                <div class="api-input-row">
                    <label for="api-base-input"><i class="fas fa-link"></i> APIåŸºç¡€åœ°å€:</label>
                    <input type="text" id="api-base-input" placeholder="https://api.openai.com/v1">
                </div>

                <div class="api-input-row">
                    <label for="api-key-input"><i class="fas fa-key"></i> APIå¯†é’¥:</label>
                    <input type="password" id="api-key-input" placeholder="sk-xxxxxxxxxxxxxxxx">
                </div>

                <div class="api-input-row">
                    <label for="api-model-input"><i class="fas fa-microchip"></i> é»˜è®¤æ¨¡å‹:</label>
                    <input type="text" id="api-model-input" placeholder="gpt-3.5-turbo">
                </div>

                <button id="save-api-btn"><i class="fas fa-save"></i> ä¿å­˜APIé…ç½®</button>
            </div>

            <div class="api-status" id="api-status">
                <i class="fas fa-circle"></i> APIé…ç½®æœªä¿å­˜
            </div>

            <div class="model-connection-info">
                <h4><i class="fas fa-info-circle"></i> é…ç½®è¯´æ˜</h4>
                <p>å®Œæ•´çš„OpenAIå…¼å®¹æ¥å£é…ç½®éœ€è¦ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
                <ul>
                    <li><strong>APIåŸºç¡€åœ°å€</strong>ï¼šæ¨¡å‹æœåŠ¡çš„ç«¯ç‚¹URLï¼ˆå¦‚ï¼šhttps://api.openai.com/v1ï¼‰</li>
                    <li><strong>APIå¯†é’¥</strong>ï¼šè®¿é—®APIçš„è®¤è¯å¯†é’¥ï¼ˆå¦‚ï¼šsk-xxxxxxxxï¼‰</li>
                    <li><strong>æ¨¡å‹åç§°</strong>ï¼šè¦ä½¿ç”¨çš„å…·ä½“æ¨¡å‹åç§°ï¼ˆå¦‚ï¼šgpt-4ã€gpt-3.5-turboç­‰ï¼‰</li>
                </ul>
                <p>ç³»ç»Ÿæ”¯æŒä»¥ä¸‹å…¼å®¹æœåŠ¡ï¼š</p>
                <ul>
                    <li>OpenAIå®˜æ–¹API</li>
                    <li>Azure OpenAIæœåŠ¡</li>
                    <li>æœ¬åœ°éƒ¨ç½²çš„OpenAIå…¼å®¹æœåŠ¡</li>
                    <li>å…¶ä»–å…¼å®¹OpenAIæ¥å£çš„APIæœåŠ¡</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- é«˜åº¦è°ƒæ•´æŒ‡ç¤ºå™¨ -->
    <div class="height-indicator" id="height-indicator">
        <div>é¡µé¢é«˜åº¦è°ƒæ•´</div>
        <div>æŒ‰ä½ Ctrl + æ»šè½®è°ƒæ•´</div>
        <div id="height-value">é«˜åº¦: 100%</div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–é¢æ¿æ‹–æ‹½åŠŸèƒ½
            setupPanelResize();

            // åˆå§‹åŒ–èŠå¤©æ¡†æ‹–æ‹½åŠŸèƒ½
            setupChatAreaResize();

            // åˆå§‹åŒ–èŠå¤©æ»šè½®æ§åˆ¶
            setupChatScrollControl();

            // åˆå§‹åŒ–å¡ç‰‡å°ºå¯¸ç›‘æ§
            setupCardSizeMonitoring();

            // åˆå§‹åŒ–å“åº”å¼å¸ƒå±€
            setupResponsiveLayout();

            // åˆå§‹åŒ–é¡µé¢é«˜åº¦è°ƒæ•´
            setupPageHeightAdjustment();

            // æ˜¾ç¤ºåŠŸèƒ½æç¤º
            setTimeout(() => {
                showNotification('ğŸ’¡ æç¤º: æŒ‰ä½ Ctrl + æ»šè½®å¯è°ƒæ•´é¡µé¢é«˜åº¦ï¼ŒCtrl + 0 é‡ç½®', 'info', {
                    autoHide: true,
                    duration: 4000
                });
            }, 2000);

            setTimeout(() => {
                showNotification('ğŸ–¼ï¸ å¡ç‰‡ç°åœ¨æ”¯æŒæ›´å¤§å°ºå¯¸ï¼æ‹–æ‹½å³ä¸‹è§’å¯æ”¾å¤§è‡³1600x1200', 'success', {
                    autoHide: true,
                    duration: 4000
                });
            }, 6000);

            // åˆå§‹åŒ–å›¾è¡¨
            initCharts();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åˆå§‹åŒ–å¡ç‰‡è®¡æ•°
            updateCardCount();
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰APIé…ç½®
            checkSavedApiConfig();
            
            // æ£€æŸ¥ä¿å­˜çš„æ¨¡å‹é…ç½®
            checkSavedModelConfig();
            
            // å¯åŠ¨å›¾ç‰‡ç›‘æ§
            setupImageMonitoring();
        });
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // æ¨¡å‹åˆ†å¸ƒå›¾è¡¨
            const distributionCtx = document.getElementById('modelDistributionChart').getContext('2d');
            new Chart(distributionCtx, {
                type: 'pie',
                data: {
                    labels: ['è§†è§‰æ¨¡å‹', 'è¯­è¨€æ¨¡å‹', 'å¤šæ¨¡æ€æ¨¡å‹'],
                    datasets: [{
                        data: [45, 35, 20],
                        backgroundColor: [
                            'rgba(66, 133, 244, 0.8)',
                            'rgba(15, 157, 88, 0.8)',
                            'rgba(244, 180, 0, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0f2fe',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            // æ€§èƒ½å¯¹æ¯”å›¾è¡¨
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['YOLOv8', 'Faster R-CNN', 'SSD', 'RetinaNet'],
                    datasets: [{
                        label: 'å‡†ç¡®ç‡ (%)',
                        data: [85, 82, 79, 81],
                        backgroundColor: 'rgba(15, 157, 88, 0.7)',
                        borderColor: 'rgba(15, 157, 88, 1)',
                        borderWidth: 1
                    }, {
                        label: 'é€Ÿåº¦ (FPS)',
                        data: [120, 45, 95, 60],
                        backgroundColor: 'rgba(66, 133, 244, 0.7)',
                        borderColor: 'rgba(66, 133, 244, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(45, 55, 72, 0.5)'
                            },
                            ticks: {
                                color: '#a0aec0'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0aec0'
                            }
                        }
                    }
                }
            });
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å‘é€æ¶ˆæ¯æŒ‰é’®
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            // è¾“å…¥æ¡†å›è½¦å‘é€
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // æ¨¡å‹ä¿å­˜æŒ‰é’®
            document.getElementById('model-save').addEventListener('click', saveModel);
            
            // æ·»åŠ å›¾è¡¨æŒ‰é’®
            document.getElementById('add-chart-btn').addEventListener('click', addChartCard);
            
            // æ·»åŠ å›¾ç‰‡æŒ‰é’®
            document.getElementById('add-image-btn').addEventListener('click', addImageCard);

            // æµ‹è¯•å›¾ç‰‡æŒ‰é’®
            document.getElementById('test-image-btn').addEventListener('click', testImageLoad);

            // æµ‹è¯•ç›‘æ§æŒ‰é’®
            document.getElementById('test-monitor-btn').addEventListener('click', testImageMonitor);

            // æµ‹è¯•ä¸Šä¼ æŒ‰é’®
            document.getElementById('test-upload-btn').addEventListener('click', testImageUpload);

            // æ¸…ç©ºå¡ç‰‡æŒ‰é’®
            document.getElementById('clear-cards-btn').addEventListener('click', clearCards);
            
            // åˆ é™¤å¡ç‰‡äº‹ä»¶å§”æ‰˜ - å·²æ¢å¤
            document.getElementById('cards-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-card') ||
                    e.target.parentElement.classList.contains('delete-card')) {
                    const card = e.target.closest('.card');

                    // æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿ')) {
                        card.classList.add('fade-out');
                        setTimeout(() => {
                            card.remove();
                            updateCardCount();
                            showNotification('å¡ç‰‡å·²åˆ é™¤', 'success');
                        }, 300);
                    }
                }
            });
            
            // APIè®¾ç½®æŒ‰é’®
            const apiSettingsBtn = document.getElementById('api-settings-btn');
            if (apiSettingsBtn) {
                console.log('APIè®¾ç½®æŒ‰é’®æ‰¾åˆ°ï¼Œç»‘å®šäº‹ä»¶ç›‘å¬å™¨');
                apiSettingsBtn.addEventListener('click', function(e) {
                    console.log('APIè®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»');
                    e.preventDefault();
                    e.stopPropagation();
                    toggleApiConfig();
                });
            } else {
                console.error('æ‰¾ä¸åˆ° APIè®¾ç½®æŒ‰é’®');
            }
            
            // ä¿å­˜APIé…ç½®æŒ‰é’®
            document.getElementById('save-api-btn').addEventListener('click', saveApiConfig);
            
            // æ¨¡å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('model-select').addEventListener('change', function() {
                const customModelInput = document.getElementById('custom-model-input');
                if (this.value === 'custom') {
                    customModelInput.classList.add('active');
                } else {
                    customModelInput.classList.remove('active');
                }
            });

            // APIæ¨¡å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('api-model-input').addEventListener('change', function() {
                const customApiModelRow = document.getElementById('custom-api-model-row');
                if (this.value === 'custom') {
                    customApiModelRow.style.display = 'flex';
                } else {
                    customApiModelRow.style.display = 'none';
                }
            });

            // é™„ä»¶ä¸Šä¼ æŒ‰é’®
            document.getElementById('attachment-btn').addEventListener('click', function() {
                document.getElementById('attachment-input').click();
            });

            // é™„ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('attachment-input').addEventListener('change', function(e) {
                handleAttachments(e.target.files);
            });
            
            // èŠå¤©æ¨¡å¼åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            document.getElementById('local-chat-btn').addEventListener('click', () => switchChatMode('local'));
            document.getElementById('iframe-chat-btn').addEventListener('click', () => switchChatMode('iframe'));

            // æ¸…ç©ºèŠå¤©è®°å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('clear-chat-btn').addEventListener('click', clearChatHistory);

            // APIé…ç½®æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
            document.getElementById('api-config-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApiConfig();
                }
            });

            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('api-config-modal');
                    if (modal && modal.classList.contains('active')) {
                        closeApiConfig();
                    }
                }
            });
            

        }
        
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰APIé…ç½®
        function checkSavedApiConfig() {
            const savedApiBase = localStorage.getItem('api_base');
            const savedApiKey = localStorage.getItem('api_key');
            const savedApiModel = localStorage.getItem('api_model');
            
            if (savedApiBase) {
                document.getElementById('api-base-input').value = savedApiBase;
            }
            
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
            
            if (savedApiModel) {
                document.getElementById('api-model-input').value = savedApiModel;
            }
            
            if (savedApiBase || savedApiKey || savedApiModel) {
                validateApiConfig(savedApiBase, savedApiKey, savedApiModel);
            }
        }
        
        // æ£€æŸ¥ä¿å­˜çš„æ¨¡å‹é…ç½®
        function checkSavedModelConfig() {
            const savedModel = localStorage.getItem('current_model');
            if (savedModel) {
                document.getElementById('current-model').textContent = savedModel;
            }
        }
        
        // æ‰“å¼€APIé…ç½®æ¨¡æ€æ¡†
        function toggleApiConfig() {
            console.log('toggleApiConfig è¢«è°ƒç”¨');
            const apiConfigModal = document.getElementById('api-config-modal');
            if (!apiConfigModal) {
                console.error('æ‰¾ä¸åˆ° api-config-modal å…ƒç´ ');
                return;
            }

            console.log('æ‰“å¼€APIé…ç½®æ¨¡æ€æ¡†');
            apiConfigModal.classList.add('active');

            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            setTimeout(() => {
                const firstInput = apiConfigModal.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        // å…³é—­APIé…ç½®æ¨¡æ€æ¡†
        function closeApiConfig() {
            console.log('å…³é—­APIé…ç½®æ¨¡æ€æ¡†');
            const apiConfigModal = document.getElementById('api-config-modal');
            if (apiConfigModal) {
                apiConfigModal.classList.remove('active');
            }
        }

        // åˆ‡æ¢èŠå¤©æ¨¡å¼
        function switchChatMode(mode) {
            const localContainer = document.getElementById('local-chat-container');
            const iframeContainer = document.getElementById('iframe-container');
            const localBtn = document.getElementById('local-chat-btn');
            const iframeBtn = document.getElementById('iframe-chat-btn');
            const panelTitle = document.getElementById('panel-title-text');

            if (mode === 'local') {
                localContainer.classList.remove('hidden');
                iframeContainer.classList.remove('active');
                localBtn.classList.add('active');
                iframeBtn.classList.remove('active');
                panelTitle.innerHTML = '<i class="fas fa-comments"></i> æ™ºèƒ½é—®ç­”ç³»ç»Ÿ';
            } else if (mode === 'iframe') {
                localContainer.classList.add('hidden');
                iframeContainer.classList.add('active');
                localBtn.classList.remove('active');
                iframeBtn.classList.add('active');
                panelTitle.innerHTML = '<i class="fas fa-external-link-alt"></i> å¤–éƒ¨èŠå¤©æœºå™¨äºº';
            }
        }

        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChatHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                const chatArea = document.getElementById('chat-area');

                // ä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼Œæ¸…é™¤å…¶ä»–æ¶ˆæ¯
                const welcomeMessage = chatArea.querySelector('.message.system');
                chatArea.innerHTML = '';

                if (welcomeMessage) {
                    chatArea.appendChild(welcomeMessage);
                }

                // æ¸…ç©ºæ¶ˆæ¯å†å²
                if (window.messageHistory) {
                    window.messageHistory = [];
                }

                showNotification('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success', {
                    autoHide: true,
                    duration: 2000
                });

                console.log('èŠå¤©è®°å½•å·²æ¸…ç©º');
            }
        }

        // ä¿å­˜APIé…ç½®
        function saveApiConfig() {
            const apiBase = document.getElementById('api-base-input').value.trim();
            const apiKey = document.getElementById('api-key-input').value.trim();
            const apiModel = document.getElementById('api-model-input').value.trim();
            
            // åŸºæœ¬éªŒè¯
            if (!apiBase) {
                alert('APIåŸºç¡€åœ°å€ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!apiKey) {
                alert('APIå¯†é’¥ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!apiModel) {
                alert('é»˜è®¤æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            const apiStatus = document.getElementById('api-status');
            apiStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> ä¿å­˜é…ç½®ä¸­...';
            
            // å‘é€é…ç½®åˆ°åç«¯
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_base: apiBase,
                    api_key: apiKey,
                    default_model: apiModel
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('api_base', apiBase);
                    localStorage.setItem('api_key', apiKey);
                    localStorage.setItem('api_model', apiModel);
                    
                    // éªŒè¯é…ç½®
                    validateApiConfig(apiBase, apiKey, apiModel);
                } else {
                    apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message || 'ä¿å­˜é…ç½®å¤±è´¥'}`;
                }
            })
            .catch(error => {
                console.error('ä¿å­˜é…ç½®æ—¶å‡ºé”™:', error);
                let errorMsg = 'ä¿å­˜é…ç½®æ—¶å‡ºé”™';
                if (error.message) {
                    errorMsg += `: ${error.message}`;
                }
                if (error.traceback) {
                    console.error('è¯¦ç»†é”™è¯¯:', error.traceback);
                }
                apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
            });
        }
                
        // éªŒè¯APIé…ç½®
        function validateApiConfig(apiBase, apiKey, apiModel) {
            const apiStatus = document.getElementById('api-status');
            
            // æ˜¾ç¤ºéªŒè¯ä¸­
            apiStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> éªŒè¯APIé…ç½®ä¸­...';
            
            // è°ƒç”¨åç«¯éªŒè¯API
            fetch('/api/validate')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    apiStatus.innerHTML = '<i class="fas fa-check-circle"></i> APIé…ç½®éªŒè¯æˆåŠŸ';
                    apiStatus.classList.add('valid');
                    
                    // æ›´æ–°æ¨¡å‹çŠ¶æ€
                    document.getElementById('model-status').textContent = 'å·²è¿æ¥';
                    document.getElementById('model-status').classList.add('connected');
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤ºå¼¹çª—
                    showNotification('APIé…ç½®éªŒè¯æˆåŠŸï¼', 'success', {
                        details: [
                            `APIåŸºç¡€åœ°å€: ${apiBase || 'æœªè®¾ç½®'}`,
                            `APIå¯†é’¥: ${apiKey ? apiKey.substring(0, 6) + '******' : 'æœªè®¾ç½®'}`,
                            `é»˜è®¤æ¨¡å‹: ${apiModel || 'æœªè®¾ç½®'}`,
                            `å¯ç”¨æ¨¡å‹: ${data.models.join(', ')}`
                        ]
                    });

                    // å…³é—­é…ç½®æ¨¡æ€æ¡†
                    closeApiConfig();
                } else {
                    apiStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.message}`;
                    apiStatus.classList.remove('valid');
                }
            })
            .catch(error => {
                console.error('éªŒè¯é…ç½®æ—¶å‡ºé”™:', error);
                apiStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> éªŒè¯é…ç½®æ—¶å‡ºé”™';
                apiStatus.classList.remove('valid');
            });
        }
        
        // ä¿å­˜æ¨¡å‹è®¾ç½®
        function saveModel() {
            const modelSelect = document.getElementById('model-select');
            const selectedValue = modelSelect.value;
            let modelName = '';
            
            if (selectedValue === 'custom') {
                modelName = document.getElementById('custom-model-name').value.trim();
                if (!modelName) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°');
                    return;
                }
            } else if (selectedValue === 'default') {
                const defaultModel = localStorage.getItem('api_model');
                if (!defaultModel) {
                    alert('è¯·å…ˆé…ç½®é»˜è®¤æ¨¡å‹');
                    toggleApiConfig();
                    return;
                }
                modelName = defaultModel;
            } else {
                modelName = selectedValue;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('current_model', modelName);
            document.getElementById('current-model').textContent = modelName;
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="message-content">
                    æ¨¡å‹å·²åˆ‡æ¢ä¸º: <strong>${modelName}</strong>
                </div>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // å‘é€æ¶ˆæ¯å‡½æ•°
        function sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message === '') return;
            
            // æ£€æŸ¥APIé…ç½®
            const apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½®APIæœåŠ¡');
                toggleApiConfig();
                return;
            }
            
            // è·å–å½“å‰æ¨¡å‹
            const currentModel = localStorage.getItem('current_model') || 
                                localStorage.getItem('api_model');
            
            if (!currentModel) {
                alert('è¯·å…ˆé€‰æ‹©æˆ–é…ç½®æ¨¡å‹');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            userInput.value = '';
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const loadingMessage = addMessage('è¿æ¥æ¨¡å‹ä¸­...', 'system', true);
            
            // å‘é€è¯·æ±‚åˆ°åç«¯
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    model: currentModel
                })
            })
            .then(response => {
                // é¦–å…ˆæ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${text.substring(0, 100)}...`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                loadingMessage.remove();
                
                if (data.status === 'success') {
                    // æ·»åŠ AIå“åº”
                    addMessage(data.response, 'system');
                } else {
                    addMessage(`è¯·æ±‚å¤±è´¥: ${data.message}`, 'system');
                }
            })
            .catch(error => {
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                loadingMessage.remove();
                addMessage(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'system');
                
                // åœ¨æ§åˆ¶å°æ‰“å°å®Œæ•´é”™è¯¯
                console.error('APIè¯·æ±‚é”™è¯¯è¯¦æƒ…:', error);
            });
        }
        
        // æ·»åŠ å›¾è¡¨å¡ç‰‡
        function addChartCard() {
            // è°ƒç”¨åç«¯APIæ·»åŠ å¡ç‰‡
            fetch('/api/dashboard/card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'chart'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    createChartCard(data.card);
                }
            });
        }
        
        // æ·»åŠ å›¾ç‰‡å¡ç‰‡
        function addImageCard() {
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶ - å¼ºåˆ¶è·å–ç»å¯¹è·¯å¾„
        function handleImageFile(file) {
            console.log('å¼€å§‹å¤„ç†å›¾ç‰‡æ–‡ä»¶:', file.name);

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶100MBï¼‰
            if (file.size > 100 * 1024 * 1024) {
                alert(`å›¾ç‰‡æ–‡ä»¶ ${file.name} è¶…è¿‡100MBé™åˆ¶`);
                return;
            }

            // å°è¯•å¤šç§æ–¹æ³•è·å–æ–‡ä»¶ç»å¯¹è·¯å¾„
            let absolutePath = null;

            // æ–¹æ³•1: ç›´æ¥è·å–pathå±æ€§ï¼ˆElectron/Node.jsç¯å¢ƒï¼‰
            if (file.path) {
                absolutePath = file.path;
                console.log('æ–¹æ³•1æˆåŠŸ - ç›´æ¥è·å–path:', absolutePath);
            }
            // æ–¹æ³•2: webkitRelativePathï¼ˆæ–‡ä»¶å¤¹æ‹–æ‹½ï¼‰
            else if (file.webkitRelativePath) {
                absolutePath = file.webkitRelativePath;
                console.log('æ–¹æ³•2æˆåŠŸ - webkitRelativePath:', absolutePath);
            }
            // æ–¹æ³•3: å°è¯•é€šè¿‡File APIè·å–æ›´å¤šä¿¡æ¯
            else if (file.mozFullPath) {
                absolutePath = file.mozFullPath;
                console.log('æ–¹æ³•3æˆåŠŸ - mozFullPath:', absolutePath);
            }
            // æ–¹æ³•4: å°è¯•é€šè¿‡FileSystemEntry API
            else if (file.webkitGetAsEntry && file.webkitGetAsEntry()) {
                const entry = file.webkitGetAsEntry();
                if (entry && entry.fullPath) {
                    absolutePath = entry.fullPath;
                    console.log('æ–¹æ³•4æˆåŠŸ - webkitGetAsEntry:', absolutePath);
                }
            }
            // æ–¹æ³•5: åˆ›å»ºä¸´æ—¶URLå¹¶å°è¯•è§£æ
            else {
                // å°è¯•ä»æ–‡ä»¶çš„ä¸´æ—¶URLä¸­è·å–ä¿¡æ¯
                const tempUrl = URL.createObjectURL(file);
                console.log('ä¸´æ—¶URL:', tempUrl);

                // å°è¯•ä½¿ç”¨æ–‡ä»¶åä½œä¸ºè·¯å¾„ï¼ˆæœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼‰
                if (file.name && file.name.includes('.')) {
                    // å‡è®¾ç”¨æˆ·ä¼šå°†æ–‡ä»¶æ”¾åœ¨å¸¸è§ä½ç½®
                    const possiblePaths = [
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Desktop\\${file.name}`,
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Downloads\\${file.name}`,
                        `C:\\Users\\${navigator.userAgent.includes('Windows') ? 'User' : 'user'}\\Pictures\\${file.name}`,
                        `/Users/user/Desktop/${file.name}`,
                        `/Users/user/Downloads/${file.name}`,
                        `/Users/user/Pictures/${file.name}`,
                        `/home/user/Desktop/${file.name}`,
                        `/home/user/Downloads/${file.name}`,
                        `/home/user/Pictures/${file.name}`
                    ];

                    // è®©ç”¨æˆ·é€‰æ‹©æˆ–è¾“å…¥æ­£ç¡®çš„è·¯å¾„
                    showPathInputDialog(file, possiblePaths);
                    return;
                }
            }

            console.log('æœ€ç»ˆè·å–çš„è·¯å¾„:', absolutePath);

            if (!absolutePath) {
                // å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼Œè¦æ±‚ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥è·¯å¾„
                showPathInputDialog(file, []);
                return;
            }

            // ç»§ç»­å¤„ç†æ–‡ä»¶
            processImageWithPath(file, absolutePath);
        }

        // æ™ºèƒ½æ£€æµ‹æ–‡ä»¶è·¯å¾„
        function detectFilePath(file) {
            const detectedPaths = [];

            // å°è¯•ä»æ–‡ä»¶å¯¹è±¡è·å–è·¯å¾„ä¿¡æ¯
            if (file.path) {
                detectedPaths.push(file.path);
            }

            if (file.webkitRelativePath) {
                detectedPaths.push(file.webkitRelativePath);
            }

            // å°è¯•ä»æ–‡ä»¶åæ¨æµ‹å¸¸è§è·¯å¾„
            const fileName = file.name;
            const userProfile = navigator.userAgent.includes('Windows') ? 'User' : 'user';

            // Windowsè·¯å¾„
            if (navigator.platform.includes('Win')) {
                detectedPaths.push(`C:\\Users\\${userProfile}\\Desktop\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Downloads\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Pictures\\${fileName}`);
                detectedPaths.push(`C:\\Users\\${userProfile}\\Documents\\${fileName}`);
            }
            // Linux/Macè·¯å¾„
            else {
                detectedPaths.push(`/home/${userProfile}/Desktop/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Downloads/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Pictures/${fileName}`);
                detectedPaths.push(`/home/${userProfile}/Documents/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Desktop/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Downloads/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Pictures/${fileName}`);
                detectedPaths.push(`/Users/${userProfile}/Documents/${fileName}`);
            }

            // å»é‡
            return [...new Set(detectedPaths)];
        }

        // æ˜¾ç¤ºè·¯å¾„è¾“å…¥å¯¹è¯æ¡†
        function showPathInputDialog(file, suggestedPaths) {
            // æ™ºèƒ½æ£€æµ‹è·¯å¾„
            const detectedPaths = detectFilePath(file);
            // åˆå¹¶å»ºè®®è·¯å¾„å’Œæ£€æµ‹è·¯å¾„
            const allPaths = [...new Set([...detectedPaths, ...suggestedPaths])];
            const modal = document.createElement('div');
            modal.className = 'path-input-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--dark-bg);
                border-radius: 12px;
                padding: 25px;
                width: 90%;
                max-width: 600px;
                max-height: 80%;
                overflow-y: auto;
                border: 1px solid var(--border-color);
            `;

            let suggestedPathsHtml = '';
            if (allPaths.length > 0) {
                // åˆ†ç±»æ˜¾ç¤ºè·¯å¾„
                const detectedPathsOnly = detectedPaths.slice(0, 3); // åªæ˜¾ç¤ºå‰3ä¸ªæ£€æµ‹è·¯å¾„
                const otherPaths = allPaths.slice(detectedPathsOnly.length);

                suggestedPathsHtml = `
                    <div style="margin: 15px 0;">
                        ${detectedPathsOnly.length > 0 ? `
                            <h4 style="color: var(--success-color); margin-bottom: 10px;">
                                <i class="fas fa-search"></i> æ™ºèƒ½æ£€æµ‹åˆ°çš„è·¯å¾„ï¼š
                            </h4>
                            ${detectedPathsOnly.map((path, index) => `
                                <button onclick="selectSuggestedPath('${path}')" style="
                                    display: block;
                                    width: 100%;
                                    margin: 5px 0;
                                    padding: 8px 12px;
                                    background: rgba(72, 187, 120, 0.2);
                                    border: 1px solid var(--success-color);
                                    border-radius: 6px;
                                    color: var(--text-light);
                                    cursor: pointer;
                                    text-align: left;
                                    font-size: 0.9rem;
                                    ${index === 0 ? 'font-weight: bold;' : ''}
                                ">
                                    ${index === 0 ? 'ğŸ¯ ' : ''}${path}
                                    ${index === 0 ? ' (æ¨è)' : ''}
                                </button>
                            `).join('')}
                        ` : ''}

                        ${otherPaths.length > 0 ? `
                            <h4 style="color: var(--text-light); margin-bottom: 10px; margin-top: 15px;">
                                <i class="fas fa-folder"></i> å…¶ä»–å¯èƒ½çš„è·¯å¾„ï¼š
                            </h4>
                            ${otherPaths.slice(0, 5).map(path => `
                                <button onclick="selectSuggestedPath('${path}')" style="
                                    display: block;
                                    width: 100%;
                                    margin: 5px 0;
                                    padding: 8px 12px;
                                    background: rgba(66, 133, 244, 0.2);
                                    border: 1px solid var(--border-color);
                                    border-radius: 6px;
                                    color: var(--text-light);
                                    cursor: pointer;
                                    text-align: left;
                                    font-size: 0.9rem;
                                ">${path}</button>
                            `).join('')}
                        ` : ''}
                    </div>
                `;
            }

            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-light); margin-bottom: 15px;">
                        <i class="fas fa-search"></i> æ™ºèƒ½è·¯å¾„æ£€æµ‹
                    </h3>
                    <p style="color: var(--text-gray); margin-bottom: 15px;">
                        æ–‡ä»¶å: <strong>${file.name}</strong><br>
                        ç³»ç»Ÿå·²æ™ºèƒ½æ£€æµ‹å¯èƒ½çš„æ–‡ä»¶è·¯å¾„ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„è·¯å¾„æˆ–æ‰‹åŠ¨è¾“å…¥ã€‚
                    </p>
                    ${suggestedPathsHtml}
                    <div style="margin: 15px 0;">
                        <label style="color: var(--text-light); display: block; margin-bottom: 8px;">
                            æ‰‹åŠ¨è¾“å…¥å®Œæ•´è·¯å¾„ï¼š
                        </label>
                        <input type="text" id="file-path-input"
                               value="${detectedPaths.length > 0 ? detectedPaths[0] : ''}"
                               placeholder="ä¾‹å¦‚: C:\\Users\\ç”¨æˆ·å\\Desktop\\${file.name}" style="
                            width: 100%;
                            padding: 10px;
                            background: var(--card-bg);
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            color: var(--text-light);
                            font-size: 0.9rem;
                        ">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button onclick="cancelPathInput()" style="
                            padding: 8px 16px;
                            background: var(--text-gray);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">å–æ¶ˆ</button>
                        <button onclick="confirmPathInput()" style="
                            padding: 8px 16px;
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                        ">ç¡®è®¤</button>
                    </div>
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // ä¿å­˜æ–‡ä»¶å¼•ç”¨
            window.currentFileForPath = file;
            window.currentPathModal = modal;

            // èšç„¦è¾“å…¥æ¡†å¹¶æ·»åŠ é”®ç›˜äº‹ä»¶
            setTimeout(() => {
                const input = document.getElementById('file-path-input');
                if (input) {
                    input.focus();
                    // æ·»åŠ å›è½¦é”®ç¡®è®¤
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            confirmPathInput();
                        } else if (e.key === 'Escape') {
                            cancelPathInput();
                        }
                    });
                }
            }, 100);
        }

        // é€‰æ‹©å»ºè®®çš„è·¯å¾„
        function selectSuggestedPath(path) {
            const input = document.getElementById('file-path-input');
            if (input) {
                input.value = path;
            }
        }

        // ç¡®è®¤è·¯å¾„è¾“å…¥
        function confirmPathInput() {
            const input = document.getElementById('file-path-input');
            const path = input ? input.value.trim() : '';

            if (!path) {
                alert('è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„');
                return;
            }

            const file = window.currentFileForPath;
            if (file) {
                // æ¸…ç†
                cancelPathInput();
                // å¤„ç†æ–‡ä»¶
                processImageWithPath(file, path);
            }
        }

        // å–æ¶ˆè·¯å¾„è¾“å…¥
        function cancelPathInput() {
            if (window.currentPathModal) {
                window.currentPathModal.remove();
                window.currentPathModal = null;
            }
            window.currentFileForPath = null;
        }

        // ä½¿ç”¨è·¯å¾„å¤„ç†å›¾ç‰‡
        function processImageWithPath(file, absolutePath) {
            console.log('å¤„ç†å›¾ç‰‡ï¼Œä½¿ç”¨è·¯å¾„:', absolutePath);

            const reader = new FileReader();
            reader.onload = function(e) {
                // åˆ›å»ºå›¾ç‰‡å¯¹è±¡éªŒè¯æ–‡ä»¶
                const img = new Image();
                img.onload = function() {
                    console.log('å›¾ç‰‡éªŒè¯æˆåŠŸ:', file.name, `${img.width}x${img.height}`);

                    const imageData = {
                        id: Date.now(),
                        title: file.name,
                        data: {
                            image_url: e.target.result, // ä½¿ç”¨data URLæ˜¾ç¤º
                            file_name: file.name,
                            file_size: formatFileSize(file.size),
                            file_path: absolutePath, // ä½¿ç”¨è·å–åˆ°çš„ç»å¯¹è·¯å¾„
                            width: img.width,
                            height: img.height,
                            is_local_file: true // æ ‡è®°æœ‰åŸå§‹è·¯å¾„
                        }
                    };
                    createImageCard(imageData);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification('å›¾ç‰‡æ·»åŠ æˆåŠŸï¼', 'success', {
                        details: [
                            `æ–‡ä»¶å: ${file.name}`,
                            `å°ºå¯¸: ${img.width} Ã— ${img.height}`,
                            `å¤§å°: ${formatFileSize(file.size)}`,
                            'âœ… æ”¯æŒåˆ·æ–°å’Œç›‘æ§åŠŸèƒ½',
                            `ç»å¯¹è·¯å¾„: ${absolutePath}`
                        ]
                    });
                };
                img.onerror = function() {
                    console.error('å›¾ç‰‡éªŒè¯å¤±è´¥:', file.name);
                    showNotification('å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒæˆ–å·²æŸå', 'error', {
                        details: [`æ–‡ä»¶å: ${file.name}`]
                    });
                };
                img.src = e.target.result;
            };
            reader.onerror = function() {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', file.name);
                showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error', {
                    details: [`æ–‡ä»¶å: ${file.name}`]
                });
            };
            reader.readAsDataURL(file);
        }

        // åˆ é™¤å¡ç‰‡å‡½æ•°
        function removeCard(button) {
            const card = button.closest('.card');
            if (!card) return;

            // æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿ')) {
                card.classList.add('fade-out');
                setTimeout(() => {
                    card.remove();
                    updateCardCount();
                    showNotification('å¡ç‰‡å·²åˆ é™¤', 'success', {
                        autoHide: true,
                        duration: 2000
                    });
                }, 300);
            }
        }


        // å¤„ç†å…¶ä»–ç±»å‹æ–‡ä»¶
        function handleOtherFile(file) {
            console.log('å¤„ç†å…¶ä»–æ–‡ä»¶:', file.name, file.type);

            if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
                handleTextFile(file);
            } else {
                // åˆ›å»ºé€šç”¨æ–‡ä»¶å¡ç‰‡
                const fileData = {
                    id: Date.now(),
                    title: file.name,
                    data: {
                        file_name: file.name,
                        file_size: formatFileSize(file.size),
                        file_path: file.webkitRelativePath || file.name,
                        file_type: file.type || 'unknown',
                        type: 'file'
                    }
                };
                createFileCard(fileData);
            }
        }

        // å¤„ç†æ–‡æœ¬æ–‡ä»¶
        function handleTextFile(file) {
            console.log('å¤„ç†æ–‡æœ¬æ–‡ä»¶:', file.name);

            const reader = new FileReader();
            reader.onload = function(e) {
                const textData = {
                    id: Date.now(),
                    title: file.name,
                    data: {
                        content: e.target.result,
                        file_name: file.name,
                        file_size: formatFileSize(file.size),
                        file_path: file.webkitRelativePath || file.name,
                        type: 'text'
                    }
                };
                createTextCard(textData);
            };
            reader.onerror = function() {
                console.error('æ–‡æœ¬æ–‡ä»¶è¯»å–å¤±è´¥:', file.name);
                alert(`è¯»å–æ–‡æœ¬æ–‡ä»¶ ${file.name} å¤±è´¥`);
            };
            reader.readAsText(file);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // åˆ›å»ºå›¾è¡¨å¡ç‰‡
        function createChartCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');
            const cardId = `chart-${cardData.id}`;
            
            const card = document.createElement('div');
            card.className = 'card card-enter';
            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                        <button class="delete-card" onclick="removeCard(this)" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="${cardId}"></canvas>
                    </div>
                </div>
            `;
            
            // è®¾ç½®å¡ç‰‡é»˜è®¤å°ºå¯¸ä¸ºæ›´å¤§çš„å°ºå¯¸
            card.style.width = '450px';
            card.style.height = '400px';

            cardsContainer.appendChild(card);

            // ç¡®ä¿æ–°å¡ç‰‡ä¸ä¼šé‡å 
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);

            // åˆ›å»ºå›¾è¡¨
            setTimeout(() => {
                const ctx = document.getElementById(cardId).getContext('2d');
                const chartData = cardData.data;
                
                new Chart(ctx, {
                    type: chartData.type,
                    data: {
                        labels: chartData.data.labels,
                        datasets: chartData.data.datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e0f2fe',
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                grid: {
                                    color: 'rgba(45, 55, 72, 0.5)'
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#a0aec0'
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            updateCardCount();
        }
        
        // åˆ›å»ºå›¾ç‰‡å¡ç‰‡ - ç®€åŒ–ç‰ˆï¼ˆä»…ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
        function createImageCard(cardData) {
            // ç›´æ¥ä½¿ç”¨data URLå’Œç»å¯¹è·¯å¾„
            const imageSrc = cardData.data.image_url;
            const filePath = cardData.data.file_path;
            const isLocalFile = cardData.data.is_local_file;

            console.log('åˆ›å»ºå›¾ç‰‡å¡ç‰‡:', {
                title: cardData.title,
                filePath: filePath,
                isLocalFile: isLocalFile
            });

            createImageCardWithDataURL(cardData, imageSrc, filePath, isLocalFile);
        }

        // ä½¿ç”¨data URLåˆ›å»ºå›¾ç‰‡å¡ç‰‡
        function createImageCardWithDataURL(cardData, imageSrc, filePath, isLocalFile) {
            console.log('ä½¿ç”¨data URLåˆ›å»ºå›¾ç‰‡å¡ç‰‡ï¼Œæ–‡ä»¶è·¯å¾„ç”¨äºç›‘æ§:', filePath);

            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-image"></i></div>
                    <div class="card-actions">
                        <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                        <button class="delete-card" onclick="removeCard(this)" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="image-container">
                        <div class="image-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                        <img src="${imageSrc}"
                             alt="${cardData.title}"
                             class="image-preview"
                             data-file-path="${filePath || ''}"
                             data-is-local-file="${isLocalFile || false}"
                             style="display: none; max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; margin: 0; padding: 0; border: none; border-radius: 4px;"
                             onclick="openImageModal('${imageSrc}', '${cardData.title}')">
                        <div class="image-error" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>å›¾ç‰‡åŠ è½½å¤±è´¥</p>
                            <button onclick="retryLoadImage(this)">é‡è¯•</button>
                        </div>
                    </div>
                    <div class="image-controls">
                        <!-- å›¾ç‰‡ç¼©æ”¾æ§åˆ¶æŒ‰é’® - å·²æ³¨é‡Šï¼Œä¸éœ€è¦æ˜¾ç¤º -->
                        <!-- <button onclick="scaleImage(this, 0.8)"><i class="fas fa-search-minus"></i> ç¼©å°</button> -->
                        <!-- <button onclick="scaleImage(this, 1.2)"><i class="fas fa-search-plus"></i> æ”¾å¤§</button> -->
                        <!-- <button onclick="resetImageScale(this)"><i class="fas fa-undo"></i> é‡ç½®</button> -->
                        <button onclick="refreshImage(this)"><i class="fas fa-sync-alt"></i> åˆ·æ–°</button>
                        <button onclick="toggleImageMonitoring(this)"><i class="fas fa-eye"></i> ç›‘æ§</button>
                    </div>
                    <!-- å›¾ç‰‡ä¿¡æ¯ - å·²æ³¨é‡Šï¼Œä¸åœ¨å¡ç‰‡ä¸­æ˜¾ç¤º -->
                    <!-- <div class="image-info">
                        <div><strong>æ–‡ä»¶å:</strong> ${cardData.data.file_name}</div>
                        <div><strong>å¤§å°:</strong> ${cardData.data.file_size}</div>
                        <div><strong>å°ºå¯¸:</strong> ${cardData.data.width} Ã— ${cardData.data.height}</div>
                        <div><strong>è·¯å¾„:</strong> ${filePath}</div>
                        <div class="monitoring-status">
                            <i class="fas fa-circle" style="color: ${filePath && !filePath.startsWith('http') && !filePath.startsWith('data:') ? 'var(--primary-color)' : '#ccc'}"></i>
                            <span>${filePath && !filePath.startsWith('http') && !filePath.startsWith('data:') ? 'ç›‘æ§ä¸­' : 'æœªç›‘æ§'}</span>
                        </div>
                    </div> -->
                </div>
            `;

            // è®¾ç½®å¡ç‰‡é»˜è®¤å°ºå¯¸ä¸ºæ›´å¤§çš„å°ºå¯¸
            card.style.width = '400px';
            card.style.height = '500px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // ç¡®ä¿æ–°å¡ç‰‡ä¸ä¼šé‡å 
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);

            // è®¾ç½®å›¾ç‰‡åŠ è½½äº‹ä»¶
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');

            loading.style.display = 'flex';

            img.onload = function() {
                loading.style.display = 'none';
                error.style.display = 'none';
                img.style.display = 'block';

                // è®¾ç½®å›¾ç‰‡æ ·å¼ä»¥æ˜¾ç¤ºå®Œæ•´çš„æœ€å¤§å›¾ç‰‡
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.width = 'auto';
                img.style.height = 'auto';
                img.style.objectFit = 'contain'; // æ˜¾ç¤ºå®Œæ•´å›¾ç‰‡
                img.style.margin = '0';
                img.style.padding = '0';
                img.style.border = 'none';
                img.style.borderRadius = '4px';

                // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥å®¹å™¨å’Œå›¾ç‰‡çš„å®é™…å°ºå¯¸
                const container = img.closest('.image-container');
                const cardContent = img.closest('.card-content');
                const card = img.closest('.card');

                console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ - å°ºå¯¸è°ƒè¯•ä¿¡æ¯:', {
                    src: img.src,
                    filePath: filePath,
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight,
                    cardSize: { width: card.offsetWidth, height: card.offsetHeight },
                    cardContentSize: { width: cardContent.offsetWidth, height: cardContent.offsetHeight },
                    containerSize: { width: container.offsetWidth, height: container.offsetHeight },
                    imgSize: { width: img.offsetWidth, height: img.offsetHeight }
                });

                // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œå¼€å§‹ç›‘æ§
                if (filePath && !filePath.startsWith('http') && !filePath.startsWith('data:')) {
                    console.log('å¼€å§‹ç›‘æ§æœ¬åœ°å›¾ç‰‡æ–‡ä»¶:', filePath);
                }
            };

            img.onerror = function() {
                loading.style.display = 'none';
                img.style.display = 'none';
                error.style.display = 'flex';

                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', {
                    src: imageSrc,
                    filePath: filePath,
                    error: 'å›¾ç‰‡åŠ è½½é”™è¯¯'
                });

                // å°è¯•è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                fetch(imageSrc)
                    .then(response => {
                        if (!response.ok) {
                            console.error('APIå“åº”é”™è¯¯:', response.status, response.statusText);
                            return response.text();
                        }
                    })
                    .then(text => {
                        if (text) {
                            console.error('APIé”™è¯¯è¯¦æƒ…:', text);
                        }
                    })
                    .catch(fetchError => {
                        console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥:', fetchError);
                    });
            };
        }

        // å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½
        function scaleImage(button, factor) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const currentScale = parseFloat(img.dataset.scale || 1);
            const newScale = currentScale * factor;
            
            // é™åˆ¶ç¼©æ”¾èŒƒå›´
            if (newScale >= 0.2 && newScale <= 3) {
                img.style.transform = `scale(${newScale})`;
                img.dataset.scale = newScale;
            }
        }

        // é‡ç½®å›¾ç‰‡ç¼©æ”¾
        function resetImageScale(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            img.style.transform = 'scale(1)';
            img.dataset.scale = 1;
        }
        
        // å›¾ç‰‡åˆ·æ–°åŠŸèƒ½ - æ”¯æŒåŸå§‹æ–‡ä»¶åˆ·æ–°
        function refreshImage(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');
            const filePath = img.dataset.filePath;
            const isLocalFile = img.dataset.isLocalFile === 'true';

            console.log('åˆ·æ–°å›¾ç‰‡:', {
                filePath: filePath,
                currentSrc: img.src.substring(0, 50) + '...',
                isLocalFile: isLocalFile,
                hasLoading: !!loading,
                hasError: !!error
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è·¯å¾„
            if (!filePath || !isLocalFile) {
                showImageNotification(img, 'æ— æ–‡ä»¶è·¯å¾„ï¼Œæ— æ³•åˆ·æ–°', 'warning');
                console.log('æ— æ–‡ä»¶è·¯å¾„ï¼Œæ— æ³•åˆ·æ–°');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (loading) loading.style.display = 'flex';
            if (error) error.style.display = 'none';
            img.style.opacity = '0.5';

            // å°è¯•é€šè¿‡APIé‡æ–°è¯»å–åŸå§‹æ–‡ä»¶
            console.log('é€šè¿‡APIåˆ·æ–°åŸå§‹æ–‡ä»¶:', filePath);

            const apiUrl = `/api/serve_image?path=${encodeURIComponent(filePath)}&t=${Date.now()}`;

            // å…ˆæµ‹è¯•APIæ˜¯å¦å¯ç”¨
            fetch(apiUrl, { method: 'HEAD' })
                .then(response => {
                    console.log('APIæµ‹è¯•å“åº”:', response.status, response.statusText);
                    if (response.ok) {
                        // APIå¯ç”¨ï¼Œé‡æ–°è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºdata URL
                        return fetch(apiUrl);
                    } else {
                        throw new Error(`APIå“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    // å°†blobè½¬æ¢ä¸ºdata URL
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // éªŒè¯æ–°å›¾ç‰‡
                        const testImg = new Image();
                        testImg.onload = () => {
                            console.log('å›¾ç‰‡åˆ·æ–°æˆåŠŸï¼Œæ›´æ–°data URL');
                            img.src = e.target.result; // æ›´æ–°ä¸ºæ–°çš„data URL
                            img.style.opacity = '1';
                            if (loading) loading.style.display = 'none';

                            // æ˜¾ç¤ºåˆ·æ–°æç¤º
                            showImageNotification(img, 'æ–‡ä»¶å·²é‡æ–°è¯»å–', 'success');
                        };

                        testImg.onerror = () => {
                            console.error('æ–°å›¾ç‰‡éªŒè¯å¤±è´¥');
                            img.style.opacity = '1';
                            if (loading) loading.style.display = 'none';
                            if (error) error.style.display = 'flex';

                            showImageNotification(img, 'å›¾ç‰‡éªŒè¯å¤±è´¥', 'error');
                        };

                        testImg.src = e.target.result;
                    };

                    reader.onerror = () => {
                        console.error('æ–‡ä»¶è¯»å–å¤±è´¥');
                        img.style.opacity = '1';
                        if (loading) loading.style.display = 'none';
                        if (error) error.style.display = 'flex';

                        showImageNotification(img, 'æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                    };

                    reader.readAsDataURL(blob);
                })
                .catch(fetchError => {
                    console.error('APIè¯·æ±‚å¤±è´¥:', fetchError);
                    img.style.opacity = '1';
                    if (loading) loading.style.display = 'none';
                    if (error) error.style.display = 'flex';

                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    showImageNotification(img, `åˆ·æ–°å¤±è´¥: ${fetchError.message}`, 'error');
                });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é€šçŸ¥
        function showImageNotification(imgElement, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'image-notification';
            notification.textContent = message;

            let bgColor = 'var(--primary-color)';
            if (type === 'success') bgColor = 'var(--accent-color)';
            if (type === 'error') bgColor = '#e74c3c';

            notification.style.cssText = `
                position: absolute;
                top: 10px;
                left: 10px;
                background: ${bgColor};
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;

            const container = imgElement.closest('.image-container') || imgElement.parentElement;
            if (container) {
                // ç§»é™¤ä¹‹å‰çš„é€šçŸ¥
                const existingNotification = container.querySelector('.image-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                container.style.position = 'relative';
                container.appendChild(notification);

                setTimeout(() => notification.style.opacity = '1', 10);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }
        }

        // åˆ‡æ¢å›¾ç‰‡ç›‘æ§çŠ¶æ€
        function toggleImageMonitoring(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const statusElement = card.querySelector('.monitoring-status');
            const filePath = img.dataset.filePath;
            const isLocalFile = img.dataset.isLocalFile === 'true';

            console.log('åˆ‡æ¢å›¾ç‰‡ç›‘æ§:', {
                filePath: filePath,
                isLocalFile: isLocalFile,
                src: img.src.substring(0, 50) + '...'
            });

            // æ£€æŸ¥æ˜¯å¦æ”¯æŒç›‘æ§
            if (!filePath || !isLocalFile) {
                showImageNotification(img, 'æ— æ–‡ä»¶è·¯å¾„ï¼Œä¸æ”¯æŒç›‘æ§', 'warning');
                console.log('æ— æ–‡ä»¶è·¯å¾„ï¼Œä¸æ”¯æŒç›‘æ§');
                return;
            }

            if (filePath.startsWith('http')) {
                showImageNotification(img, 'ç½‘ç»œå›¾ç‰‡ä¸æ”¯æŒç›‘æ§åŠŸèƒ½', 'warning');
                console.log('ç½‘ç»œå›¾ç‰‡ä¸æ”¯æŒç›‘æ§');
                return;
            }

            const isMonitoring = statusElement.querySelector('i').style.color.includes('var(--primary-color)');

            if (isMonitoring) {
                // åœæ­¢ç›‘æ§
                statusElement.querySelector('i').style.color = '#ccc';
                statusElement.querySelector('span').textContent = 'å·²åœæ­¢';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> åœæ­¢';
                console.log('åœæ­¢ç›‘æ§å›¾ç‰‡:', filePath);
            } else {
                // å¼€å§‹ç›‘æ§
                statusElement.querySelector('i').style.color = 'var(--primary-color)';
                statusElement.querySelector('span').textContent = 'ç›‘æ§ä¸­';
                button.innerHTML = '<i class="fas fa-eye"></i> ç›‘æ§';
                console.log('å¼€å§‹ç›‘æ§å›¾ç‰‡:', filePath);
            }
        }

        // é‡è¯•åŠ è½½å›¾ç‰‡
        function retryLoadImage(button) {
            const card = button.closest('.card');
            const img = card.querySelector('.image-preview');
            const loading = card.querySelector('.image-loading');
            const error = card.querySelector('.image-error');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            error.style.display = 'none';
            loading.style.display = 'flex';

            // é‡æ–°è®¾ç½®å›¾ç‰‡æºï¼Œæ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            const originalSrc = img.src.split('?')[0];
            img.src = originalSrc + '?retry=' + Date.now();
        }

        // åˆ›å»ºæ–‡æœ¬å¡ç‰‡
        function createTextCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            // æˆªå–æ–‡æœ¬å†…å®¹é¢„è§ˆ
            const preview = cardData.data.content.length > 200 ?
                cardData.data.content.substring(0, 200) + '...' :
                cardData.data.content;

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-file-text"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                        <button class="delete-card" onclick="removeCard(this)" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="text-preview">
                        <pre>${preview}</pre>
                    </div>
                    <div class="text-controls">
                        <button onclick="viewFullText(this)"><i class="fas fa-expand"></i> æŸ¥çœ‹å…¨æ–‡</button>
                        <button onclick="copyText(this)"><i class="fas fa-copy"></i> å¤åˆ¶</button>
                    </div>
                    <div class="file-info">
                        <div><strong>æ–‡ä»¶å:</strong> ${cardData.data.file_name}</div>
                        <div><strong>å¤§å°:</strong> ${cardData.data.file_size}</div>
                        <div><strong>è·¯å¾„:</strong> ${cardData.data.file_path}</div>
                        <div><strong>å­—ç¬¦æ•°:</strong> ${cardData.data.content.length}</div>
                    </div>
                </div>
            `;

            // è®¾ç½®å¡ç‰‡é»˜è®¤å°ºå¯¸ä¸ºæ›´å¤§çš„å°ºå¯¸
            card.style.width = '400px';
            card.style.height = '350px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // ç¡®ä¿æ–°å¡ç‰‡ä¸ä¼šé‡å 
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);
        }

        // åˆ›å»ºé€šç”¨æ–‡ä»¶å¡ç‰‡
        function createFileCard(cardData) {
            const cardsContainer = document.getElementById('cards-container');

            const card = document.createElement('div');
            card.className = 'card card-enter';

            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©å›¾æ ‡
            let icon = 'fas fa-file';
            if (cardData.data.file_type.includes('pdf')) icon = 'fas fa-file-pdf';
            else if (cardData.data.file_type.includes('word')) icon = 'fas fa-file-word';
            else if (cardData.data.file_type.includes('excel')) icon = 'fas fa-file-excel';
            else if (cardData.data.file_type.includes('zip')) icon = 'fas fa-file-archive';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title"><i class="${icon}"></i> ${cardData.title}</div>
                    <div class="card-actions">
                        <!-- å¡ç‰‡ç§»é™¤åŠŸèƒ½ - å·²æ¢å¤ -->
                        <button class="delete-card" onclick="removeCard(this)" title="åˆ é™¤å¡ç‰‡"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="file-preview">
                        <div class="file-icon">
                            <i class="${icon}" style="font-size: 4rem; color: var(--primary-color);"></i>
                        </div>
                        <p>æ–‡ä»¶ç±»å‹: ${cardData.data.file_type || 'æœªçŸ¥'}</p>
                    </div>
                    <div class="file-info">
                        <div><strong>æ–‡ä»¶å:</strong> ${cardData.data.file_name}</div>
                        <div><strong>å¤§å°:</strong> ${cardData.data.file_size}</div>
                        <div><strong>è·¯å¾„:</strong> ${cardData.data.file_path}</div>
                        <div><strong>ç±»å‹:</strong> ${cardData.data.file_type}</div>
                    </div>
                </div>
            `;

            // è®¾ç½®å¡ç‰‡é»˜è®¤å°ºå¯¸ä¸ºæ›´å¤§çš„å°ºå¯¸
            card.style.width = '350px';
            card.style.height = '300px';

            cardsContainer.appendChild(card);
            updateCardCount();

            // ç¡®ä¿æ–°å¡ç‰‡ä¸ä¼šé‡å 
            setTimeout(() => {
                ensureNoOverlap(card);
            }, 100);
        }

        // æŸ¥çœ‹å…¨æ–‡
        function viewFullText(button) {
            const card = button.closest('.card');
            const textPreview = card.querySelector('.text-preview pre');
            const fullText = textPreview.dataset.fullText || textPreview.textContent;

            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºå…¨æ–‡
            const modal = document.createElement('div');
            modal.className = 'text-modal';
            modal.innerHTML = `
                <div class="text-modal-content">
                    <div class="text-modal-header">
                        <h3>æ–‡æœ¬å†…å®¹</h3>
                        <button onclick="this.closest('.text-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-modal-body">
                        <pre>${fullText}</pre>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // å¤åˆ¶æ–‡æœ¬
        function copyText(button) {
            const card = button.closest('.card');
            const textPreview = card.querySelector('.text-preview pre');
            const fullText = textPreview.dataset.fullText || textPreview.textContent;

            navigator.clipboard.writeText(fullText).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const notification = document.createElement('div');
                notification.textContent = 'æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--primary-color);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;

                document.body.appendChild(notification);
                setTimeout(() => notification.style.opacity = '1', 10);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
        function openImageModal(imageSrc, title) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <span class="modal-close">&times;</span>
                <div class="modal-content">
                    <img src="${imageSrc}" alt="${title}">
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
            const closeBtn = modal.querySelector('.modal-close');
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
            };
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // æ¸…ç©ºæ‰€æœ‰å¡ç‰‡
        function clearCards() {
            const cardsContainer = document.getElementById('cards-container');
            if (cardsContainer.children.length > 0) {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¡ç‰‡å—ï¼Ÿ')) {
                    while (cardsContainer.firstChild) {
                        cardsContainer.removeChild(cardsContainer.firstChild);
                    }
                    updateCardCount();
                }
            } else {
                alert('ä»ªè¡¨ç›˜ä¸­æ²¡æœ‰å¡ç‰‡å¯æ¸…é™¤');
            }
        }
        
        // æ›´æ–°å¡ç‰‡è®¡æ•°
        function updateCardCount() {
            const count = document.getElementById('cards-container').children.length;
            document.getElementById('card-count').textContent = count;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(content, sender, isLoading = false) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender === 'user') {
                avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
            } else {
                avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loader"></div> ${content}`;
            } else {
                // ä½¿ç”¨markdownæ¸²æŸ“
                if (typeof marked !== 'undefined' && sender === 'system') {
                    contentDiv.innerHTML = marked.parse(content);
                } else {
                    contentDiv.textContent = content;
                }
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatArea.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageDiv;
        }

        // é¢æ¿æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
        function setupPanelResize() {
            const resizeHandle = document.getElementById('resize-handle');
            const panelLeft = document.getElementById('panel-left');
            const panelRight = document.getElementById('panel-right');
            const container = document.querySelector('.container');

            if (!resizeHandle || !panelLeft || !panelRight || !container) {
                console.warn('é¢æ¿æ‹–æ‹½å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;

                // è·å–å½“å‰å®½åº¦
                const containerRect = container.getBoundingClientRect();
                const leftRect = panelLeft.getBoundingClientRect();
                const rightRect = panelRight.getBoundingClientRect();

                startLeftWidth = leftRect.width;
                startRightWidth = rightRect.width;

                resizeHandle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';

                e.preventDefault();
            });

            let lastMoveTime = 0;
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                // èŠ‚æµå¤„ç†ï¼Œæé«˜å“åº”æ€§èƒ½
                const now = performance.now();
                if (now - lastMoveTime < 8) return; // çº¦120fpsï¼Œæ›´æµç•…
                lastMoveTime = now;

                const deltaX = e.clientX - startX;
                const containerWidth = container.offsetWidth; // ä½¿ç”¨offsetWidthæ›´å¿«

                // ç›´æ¥è®¡ç®—ç™¾åˆ†æ¯”ï¼Œé¿å…å¤æ‚çš„åƒç´ è®¡ç®—
                const startLeftPercent = (startLeftWidth / containerWidth) * 100;
                const deltaPercent = (deltaX / containerWidth) * 100;

                let leftPercent = startLeftPercent + deltaPercent;

                // ç®€å•çš„è¾¹ç•Œé™åˆ¶
                leftPercent = Math.max(15, Math.min(85, leftPercent));
                const rightPercent = 100 - leftPercent;

                // ç›´æ¥åº”ç”¨ï¼Œå‡å°‘DOMæ“ä½œ
                panelLeft.style.width = leftPercent + '%';
                panelLeft.style.flex = 'none';
                panelRight.style.width = rightPercent + '%';
                panelRight.style.flex = 'none';

                e.preventDefault();
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });

            // åŒå‡»é‡ç½®ä¸ºé»˜è®¤æ¯”ä¾‹
            resizeHandle.addEventListener('dblclick', function() {
                panelLeft.style.width = '';
                panelLeft.style.flex = '1';
                panelRight.style.width = '45%';
                panelRight.style.flex = 'none';

                showNotification('é¢æ¿å®½åº¦å·²é‡ç½®', 'success');
            });
        }

        // é¡µé¢é«˜åº¦è°ƒæ•´åŠŸèƒ½
        function setupPageHeightAdjustment() {
            const container = document.querySelector('.container');
            const heightIndicator = document.getElementById('height-indicator');
            const heightValue = document.getElementById('height-value');

            if (!container || !heightIndicator || !heightValue) {
                console.warn('é¡µé¢é«˜åº¦è°ƒæ•´å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            let currentHeight = 100; // å½“å‰é«˜åº¦ç™¾åˆ†æ¯”
            let isAdjusting = false;
            let hideTimeout;

            // æ˜¾ç¤ºæŒ‡ç¤ºå™¨
            function showIndicator() {
                heightIndicator.classList.add('show');
                isAdjusting = true;

                // æ¸…é™¤ä¹‹å‰çš„éšè—å®šæ—¶å™¨
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                }
            }

            // éšè—æŒ‡ç¤ºå™¨
            function hideIndicator() {
                hideTimeout = setTimeout(() => {
                    heightIndicator.classList.remove('show');
                    isAdjusting = false;
                }, 1500);
            }

            // æ›´æ–°é«˜åº¦
            function updateHeight(newHeight) {
                currentHeight = Math.max(50, Math.min(300, newHeight)); // é™åˆ¶åœ¨50%-300%ä¹‹é—´

                const heightPx = (window.innerHeight - 120) * (currentHeight / 100);
                container.style.height = heightPx + 'px';

                heightValue.textContent = `é«˜åº¦: ${Math.round(currentHeight)}%`;

                console.log('é¡µé¢é«˜åº¦å·²è°ƒæ•´:', currentHeight + '%', heightPx + 'px');
            }

            // ç›‘å¬æ»šè½®äº‹ä»¶
            document.addEventListener('wheel', function(e) {
                // åªæœ‰æŒ‰ä½Ctrlé”®æ—¶æ‰è°ƒæ•´é«˜åº¦
                if (!e.ctrlKey) return;

                e.preventDefault();

                showIndicator();

                // æ ¹æ®æ»šè½®æ–¹å‘è°ƒæ•´é«˜åº¦
                const delta = e.deltaY > 0 ? -5 : 5; // å‘ä¸‹æ»šåŠ¨å‡å°é«˜åº¦ï¼Œå‘ä¸Šæ»šåŠ¨å¢å¤§é«˜åº¦
                updateHeight(currentHeight + delta);

                hideIndicator();
            }, { passive: false });

            // ç›‘å¬é”®ç›˜äº‹ä»¶ï¼Œæ˜¾ç¤ºæç¤º
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && !isAdjusting) {
                    showIndicator();
                }
            });

            document.addEventListener('keyup', function(e) {
                if (!e.ctrlKey && isAdjusting) {
                    hideIndicator();
                }
            });

            // æ·»åŠ å¿«æ·é”®é‡ç½®åŠŸèƒ½ (Ctrl + 0)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === '0') {
                    e.preventDefault();
                    updateHeight(100);
                    showIndicator();
                    hideIndicator();

                    showNotification('é¡µé¢é«˜åº¦å·²é‡ç½®ä¸º100%', 'success', {
                        autoHide: true,
                        duration: 2000
                    });
                }
            });

            console.log('é¡µé¢é«˜åº¦è°ƒæ•´åŠŸèƒ½å·²åˆå§‹åŒ–');
            console.log('ä½¿ç”¨æ–¹æ³•: æŒ‰ä½Ctrlé”® + æ»šè½®è°ƒæ•´é«˜åº¦');
            console.log('å¿«æ·é”®: Ctrl + 0 é‡ç½®é«˜åº¦');
        }

        // å“åº”å¼å¸ƒå±€åŠŸèƒ½
        function setupResponsiveLayout() {
            function adjustLayout() {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const container = document.querySelector('.container');
                const panelLeft = document.getElementById('panel-left');
                const panelRight = document.getElementById('panel-right');
                const cards = document.querySelectorAll('.card');

                console.log('è°ƒæ•´å“åº”å¼å¸ƒå±€:', { screenWidth, screenHeight });

                // æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´é¢æ¿æ¯”ä¾‹
                if (screenWidth < 1200) {
                    // å°å±å¹•ï¼šå‡å°å³ä¾§é¢æ¿æ¯”ä¾‹
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '35%';
                        panelLeft.style.width = '65%';
                    }
                } else if (screenWidth < 1600) {
                    // ä¸­ç­‰å±å¹•ï¼šæ ‡å‡†æ¯”ä¾‹
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '42%';
                        panelLeft.style.width = '58%';
                    }
                } else {
                    // å¤§å±å¹•ï¼šå¢å¤§å³ä¾§é¢æ¿æ¯”ä¾‹
                    if (panelRight && !panelRight.style.width.includes('%')) {
                        panelRight.style.width = '45%';
                        panelLeft.style.width = '55%';
                    }
                }

                // åŠ¨æ€è°ƒæ•´å¡ç‰‡æœ€å¤§å°ºå¯¸
                cards.forEach(card => {
                    const maxWidth = Math.min(1600, screenWidth * 0.95); // å¤§å¹…å¢å¤§æœ€å¤§å®½åº¦
                    const maxHeight = Math.min(1200, screenHeight * 0.9); // å¤§å¹…å¢å¤§æœ€å¤§é«˜åº¦

                    card.style.maxWidth = maxWidth + 'px';
                    card.style.maxHeight = maxHeight + 'px';

                    // å¦‚æœå½“å‰å°ºå¯¸è¶…å‡ºé™åˆ¶ï¼Œè‡ªåŠ¨è°ƒæ•´
                    const rect = card.getBoundingClientRect();
                    if (rect.width > maxWidth) {
                        card.style.width = maxWidth + 'px';
                    }
                    if (rect.height > maxHeight) {
                        card.style.height = maxHeight + 'px';
                    }
                });
            }

            // åˆå§‹è°ƒæ•´
            adjustLayout();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(adjustLayout, 150);
            });
        }

        // å¡ç‰‡å°ºå¯¸ç›‘æ§åŠŸèƒ½
        function setupCardSizeMonitoring() {
            const cardsContainer = document.getElementById('cards-container');
            if (!cardsContainer) return;

            // ç›‘æ§å¡ç‰‡å°ºå¯¸å˜åŒ–
            const resizeObserver = new ResizeObserver(entries => {
                entries.forEach(entry => {
                    const card = entry.target;
                    if (!card.classList.contains('card')) return;

                    const containerRect = cardsContainer.getBoundingClientRect();
                    const cardRect = card.getBoundingClientRect();

                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå®¹å™¨è¾¹ç•Œ
                    let needsAdjustment = false;
                    let newWidth = cardRect.width;
                    let newHeight = cardRect.height;

                    // æ£€æŸ¥å³è¾¹ç•Œ
                    if (cardRect.right > containerRect.right) {
                        newWidth = containerRect.right - cardRect.left - 20; // å¢åŠ è¾¹è·
                        needsAdjustment = true;
                    }

                    // æ£€æŸ¥åº•è¾¹ç•Œ
                    if (cardRect.bottom > containerRect.bottom) {
                        newHeight = containerRect.bottom - cardRect.top - 20; // å¢åŠ è¾¹è·
                        needsAdjustment = true;
                    }

                    // æ£€æŸ¥ä¸å…¶ä»–å¡ç‰‡çš„é‡å 
                    const allCards = cardsContainer.querySelectorAll('.card');
                    allCards.forEach(otherCard => {
                        if (otherCard === card) return;

                        const otherRect = otherCard.getBoundingClientRect();

                        // æ£€æŸ¥æ˜¯å¦é‡å 
                        if (!(cardRect.right < otherRect.left ||
                              cardRect.left > otherRect.right ||
                              cardRect.bottom < otherRect.top ||
                              cardRect.top > otherRect.bottom)) {

                            // å‘ç°é‡å ï¼Œè°ƒæ•´å½“å‰å¡ç‰‡å°ºå¯¸
                            if (cardRect.right > otherRect.left && cardRect.left < otherRect.left) {
                                newWidth = otherRect.left - cardRect.left - 10;
                                needsAdjustment = true;
                            }
                            if (cardRect.bottom > otherRect.top && cardRect.top < otherRect.top) {
                                newHeight = otherRect.top - cardRect.top - 10;
                                needsAdjustment = true;
                            }
                        }
                    });

                    // åº”ç”¨è°ƒæ•´
                    if (needsAdjustment) {
                        card.style.width = Math.max(140, newWidth) + 'px';
                        card.style.height = Math.max(150, newHeight) + 'px';

                        // æ˜¾ç¤ºæç¤º
                        showNotification('å¡ç‰‡å°ºå¯¸å·²è‡ªåŠ¨è°ƒæ•´ä»¥é˜²æ­¢é‡å ', 'info', {
                            autoHide: true,
                            duration: 2000
                        });
                    }
                });
            });

            // ç›‘æ§ç°æœ‰å¡ç‰‡
            const existingCards = cardsContainer.querySelectorAll('.card');
            existingCards.forEach(card => {
                resizeObserver.observe(card);
            });

            // ç›‘æ§æ–°æ·»åŠ çš„å¡ç‰‡
            const mutationObserver = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1 && node.classList.contains('card')) {
                            resizeObserver.observe(node);

                            // ä¸ºæ–°å¡ç‰‡è®¾ç½®åˆå§‹ä½ç½®ï¼Œé¿å…é‡å 
                            setTimeout(() => {
                                adjustCardPosition(node);
                            }, 100);
                        }
                    });
                });
            });

            mutationObserver.observe(cardsContainer, {
                childList: true,
                subtree: true
            });
        }

        // è°ƒæ•´å¡ç‰‡ä½ç½®é¿å…é‡å 
        function adjustCardPosition(card) {
            const cardsContainer = document.getElementById('cards-container');
            const allCards = cardsContainer.querySelectorAll('.card');
            const cardRect = card.getBoundingClientRect();

            let hasOverlap = false;
            allCards.forEach(otherCard => {
                if (otherCard === card) return;

                const otherRect = otherCard.getBoundingClientRect();

                // æ£€æŸ¥æ˜¯å¦é‡å 
                if (!(cardRect.right < otherRect.left ||
                      cardRect.left > otherRect.right ||
                      cardRect.bottom < otherRect.top ||
                      cardRect.top > otherRect.bottom)) {
                    hasOverlap = true;
                }
            });

            if (hasOverlap) {
                // å¼ºåˆ¶é‡æ–°å¸ƒå±€ç½‘æ ¼
                cardsContainer.style.gridAutoFlow = 'row';
                cardsContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(160px, 1fr))';

                console.log('æ£€æµ‹åˆ°å¡ç‰‡é‡å ï¼Œå·²è°ƒæ•´å¸ƒå±€');
            }
        }

        // ç¡®ä¿å¡ç‰‡ä¸é‡å 
        function ensureNoOverlap(targetCard) {
            const cardsContainer = document.getElementById('cards-container');
            if (!cardsContainer || !targetCard) return;

            const containerRect = cardsContainer.getBoundingClientRect();
            const targetRect = targetCard.getBoundingClientRect();
            const allCards = cardsContainer.querySelectorAll('.card');

            let hasOverlap = false;

            // æ£€æŸ¥ä¸å…¶ä»–å¡ç‰‡çš„é‡å 
            allCards.forEach(otherCard => {
                if (otherCard === targetCard) return;

                const otherRect = otherCard.getBoundingClientRect();

                // æ£€æŸ¥æ˜¯å¦é‡å 
                if (!(targetRect.right <= otherRect.left ||
                      targetRect.left >= otherRect.right ||
                      targetRect.bottom <= otherRect.top ||
                      targetRect.top >= otherRect.bottom)) {
                    hasOverlap = true;
                    console.log('æ£€æµ‹åˆ°å¡ç‰‡é‡å :', targetCard, otherCard);
                }
            });

            if (hasOverlap) {
                // é‡æ–°è®¡ç®—ç½‘æ ¼å¸ƒå±€
                const cardWidth = 160; // æœ€å°å¡ç‰‡å®½åº¦
                const gap = 10; // ç½‘æ ¼é—´è·
                const containerWidth = containerRect.width - 16; // å‡å»padding
                const columnsCount = Math.floor(containerWidth / (cardWidth + gap));

                // æ›´æ–°ç½‘æ ¼å¸ƒå±€
                cardsContainer.style.gridTemplateColumns = `repeat(${Math.max(1, columnsCount)}, 1fr)`;
                cardsContainer.style.gap = gap + 'px';

                // å¼ºåˆ¶é‡æ–°å¸ƒå±€
                cardsContainer.style.display = 'none';
                cardsContainer.offsetHeight; // è§¦å‘é‡æ’
                cardsContainer.style.display = 'grid';

                console.log('å·²è°ƒæ•´ç½‘æ ¼å¸ƒå±€é˜²æ­¢é‡å ï¼Œåˆ—æ•°:', columnsCount);

                showNotification('å·²è‡ªåŠ¨è°ƒæ•´å¸ƒå±€é˜²æ­¢å¡ç‰‡é‡å ', 'info', {
                    autoHide: true,
                    duration: 2000
                });
            }
        }

        // èŠå¤©æ¡†æ‹–æ‹½åŠŸèƒ½
        function setupChatAreaResize() {
            const chatArea = document.getElementById('chat-area');
            
            // åˆ›å»ºè‡ªå®šä¹‰æ‹–æ‹½æ‰‹æŸ„
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'chat-resize-handle';
            resizeHandle.title = 'æ‹–æ‹½è°ƒæ•´èŠå¤©æ¡†å¤§å°';
            chatArea.appendChild(resizeHandle);

            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = parseInt(document.defaultView.getComputedStyle(chatArea).height, 10);
                document.documentElement.style.cursor = 'nw-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const height = startHeight + e.clientY - startY;
                
                // é™åˆ¶æœ€å°å’Œæœ€å¤§é«˜åº¦
                if (height > 200 && height < window.innerHeight * 0.8) {
                    chatArea.style.height = height + 'px';
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.documentElement.style.cursor = '';
                }
            });

            // é˜²æ­¢æ–‡æœ¬é€‰æ‹©
            resizeHandle.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });
        }

        // é¢æ¿æ‹–æ‹½ç§»åŠ¨åŠŸèƒ½ - ä¿®å¤å³ä¾§é¢æ¿ä½ç½®é—®é¢˜
        function setupPanelDrag() {
            const panelLeft = document.querySelector('.panel-left');
            const panelRight = document.querySelector('.panel-right');
            const panelTitle = panelLeft.querySelector('.panel-title');
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            let xOffset = 0;
            let yOffset = 0;

            panelTitle.addEventListener('mousedown', function(e) {
                // åªæœ‰ç‚¹å‡»æ ‡é¢˜æ æ‰èƒ½æ‹–æ‹½ï¼Œé¿å…ä¸å…¶ä»–æŒ‰é’®å†²çª
                if (e.target.closest('.settings-btn') || e.target.closest('.model-info') || e.target.closest('.chat-mode-switch')) {
                    return;
                }
                
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === panelTitle || panelTitle.contains(e.target)) {
                    isDragging = true;
                    panelLeft.style.position = 'absolute';
                    panelLeft.style.zIndex = '1000';
                    // ç¡®ä¿å³ä¾§é¢æ¿ä¿æŒåœ¨æ­£ç¡®ä½ç½®
                    panelRight.style.position = 'sticky';
                    panelRight.style.top = '20px';
                    panelRight.style.right = '0';
                    panelRight.style.zIndex = '100';
                    document.body.style.userSelect = 'none';
                }
            });

            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    // é™åˆ¶æ‹–æ‹½èŒƒå›´ï¼Œé˜²æ­¢æ‹–å‡ºè§†çª—å’Œä¸å³ä¾§é¢æ¿é‡å 
                    const maxX = window.innerWidth - panelLeft.offsetWidth - panelRight.offsetWidth - 50;
                    const maxY = window.innerHeight - panelLeft.offsetHeight;
                    
                    xOffset = Math.max(0, Math.min(xOffset, maxX));
                    yOffset = Math.max(0, Math.min(yOffset, maxY));

                    panelLeft.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = '';
                    // é‡ç½®é¢æ¿ä½ç½®åˆ°åŸå§‹å¸ƒå±€
                    setTimeout(() => {
                        panelLeft.style.position = '';
                        panelLeft.style.transform = '';
                        panelLeft.style.zIndex = '';
                        panelRight.style.position = 'sticky';
                        panelRight.style.top = '20px';
                        panelRight.style.zIndex = '100';
                    }, 100);
                }
            });
        }

        // å…¨å±€å˜é‡å­˜å‚¨é™„ä»¶
        let attachments = [];

        // å¤„ç†é™„ä»¶ä¸Šä¼ 
        function handleAttachments(files) {
            const attachmentPreview = document.getElementById('attachment-preview');
            
            Array.from(files).forEach(file => {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶100MBï¼‰
                if (file.size > 100 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ ${file.name} è¶…è¿‡100MBé™åˆ¶`);
                    return;
                }

                // æ·»åŠ åˆ°é™„ä»¶åˆ—è¡¨
                const attachmentId = Date.now() + Math.random();
                attachments.push({
                    id: attachmentId,
                    file: file,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type
                });
                
                // åˆ›å»ºé™„ä»¶é¢„è§ˆé¡¹
                const attachmentItem = document.createElement('div');
                attachmentItem.className = 'attachment-item';
                attachmentItem.innerHTML = `
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                    <button class="remove-attachment" onclick="removeAttachment(${attachmentId})">&times;</button>
                `;
                attachmentPreview.appendChild(attachmentItem);
            });
        }

        // ç§»é™¤é™„ä»¶
        function removeAttachment(id) {
            const index = attachments.findIndex(a => a.id === id);
            if (index !== -1) {
                attachments.splice(index, 1);
                const attachmentItem = document.querySelector(`.attachment-item[data-id="${id}"]`);
                if (attachmentItem) {
                    attachmentItem.remove();
                }
            }
        }

        // å›¾ç‰‡æ–‡ä»¶ç›‘æ§åŠŸèƒ½ - æ”¹è¿›ç‰ˆ
        function setupImageMonitoring() {
            let fileWatchers = new Map();
            let lastModifiedTimes = new Map();

            // ç›‘æ§æœ¬åœ°æ–‡ä»¶å˜åŒ–
            function watchLocalFile(filePath, imgElement) {
                if (fileWatchers.has(filePath)) {
                    clearInterval(fileWatchers.get(filePath));
                }

                const interval = setInterval(async () => {
                    try {
                        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦è¿˜åœ¨DOMä¸­
                        if (!document.body.contains(imgElement)) {
                            clearInterval(interval);
                            fileWatchers.delete(filePath);
                            lastModifiedTimes.delete(filePath);
                            return;
                        }

                        // å‘é€è¯·æ±‚æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ›´æ–°
                        const response = await fetch('/api/check_file_update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ file_path: filePath })
                        });

                        const data = await response.json();
                        if (data.updated) {
                            // æ–‡ä»¶å·²æ›´æ–°ï¼Œé‡æ–°è¯»å–åŸå§‹æ–‡ä»¶å¹¶æ›´æ–°data URL
                            console.log('æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ–°:', filePath);

                            // æ·»åŠ æ›´æ–°åŠ¨ç”»
                            imgElement.style.transition = 'opacity 0.3s ease';
                            imgElement.style.opacity = '0.5';

                            // é€šè¿‡APIé‡æ–°è¯»å–æ–‡ä»¶
                            const apiUrl = `/api/serve_image?path=${encodeURIComponent(filePath)}&t=${Date.now()}`;

                            fetch(apiUrl)
                                .then(response => response.blob())
                                .then(blob => {
                                    // å°†blobè½¬æ¢ä¸ºdata URL
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        // éªŒè¯æ–°å›¾ç‰‡
                                        const testImg = new Image();
                                        testImg.onload = () => {
                                            console.log('å›¾ç‰‡è‡ªåŠ¨æ›´æ–°æˆåŠŸ:', filePath);
                                            imgElement.src = e.target.result; // æ›´æ–°ä¸ºæ–°çš„data URL
                                            imgElement.style.opacity = '1';

                                            // æ˜¾ç¤ºæ›´æ–°æç¤º
                                            showUpdateNotification(imgElement, 'å›¾ç‰‡å·²è‡ªåŠ¨æ›´æ–°');
                                        };

                                        testImg.onerror = () => {
                                            console.warn('æ–°å›¾ç‰‡éªŒè¯å¤±è´¥:', filePath);
                                            imgElement.style.opacity = '1';
                                        };

                                        testImg.src = e.target.result;
                                    };

                                    reader.onerror = () => {
                                        console.warn('æ–‡ä»¶è¯»å–å¤±è´¥:', filePath);
                                        imgElement.style.opacity = '1';
                                    };

                                    reader.readAsDataURL(blob);
                                })
                                .catch(error => {
                                    console.warn('å›¾ç‰‡æ›´æ–°å¤±è´¥:', filePath, error);
                                    imgElement.style.opacity = '1';
                                });
                        }
                    } catch (error) {
                        console.warn('æ–‡ä»¶ç›‘æ§æ£€æŸ¥å¤±è´¥:', filePath, error);
                    }
                }, 1500); // æ¯1.5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæ›´é¢‘ç¹çš„æ£€æŸ¥

                fileWatchers.set(filePath, interval);
            }

            // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
            function showUpdateNotification(imgElement, message) {
                // ç§»é™¤ä¹‹å‰çš„é€šçŸ¥
                const existingNotification = imgElement.parentElement.querySelector('.image-update-notification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.className = 'image-update-notification';
                notification.textContent = message;
                notification.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: var(--primary-color);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    font-size: 12px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;

                const container = imgElement.closest('.image-container') || imgElement.parentElement;
                if (container) {
                    container.style.position = 'relative';
                    container.appendChild(notification);

                    // åŠ¨ç”»æ˜¾ç¤º
                    setTimeout(() => notification.style.opacity = '1', 10);
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                }
            }

            // ç›‘æ§æ‰€æœ‰å›¾ç‰‡
            function monitorAllImages() {
                const images = document.querySelectorAll('.image-preview');
                console.log('æ‰«æå›¾ç‰‡è¿›è¡Œç›‘æ§ï¼Œæ‰¾åˆ°', images.length, 'ä¸ªå›¾ç‰‡');

                images.forEach(img => {
                    const originalSrc = img.src.split('?')[0];
                    let filePath = img.dataset.filePath || img.getAttribute('data-file-path');
                    const isLocalFile = img.dataset.isLocalFile === 'true';

                    console.log('å›¾ç‰‡åˆ†æ:', {
                        src: originalSrc.startsWith('data:') ? 'data URL' : originalSrc,
                        filePath: filePath,
                        isLocalFile: isLocalFile,
                        canMonitor: filePath && isLocalFile && !filePath.startsWith('http')
                    });

                    // åªç›‘æ§æœ‰åŸå§‹æ–‡ä»¶è·¯å¾„çš„æœ¬åœ°å›¾ç‰‡
                    if (filePath && isLocalFile && !filePath.startsWith('http://') && !filePath.startsWith('https://')) {
                        // è®¾ç½®æ–‡ä»¶è·¯å¾„å±æ€§ä»¥ä¾¿åç»­ä½¿ç”¨
                        img.dataset.filePath = filePath;

                        // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç›‘æ§
                        if (!fileWatchers.has(filePath)) {
                            watchLocalFile(filePath, img);
                            console.log('å¼€å§‹ç›‘æ§å›¾ç‰‡:', filePath);
                        } else {
                            console.log('å›¾ç‰‡å·²åœ¨ç›‘æ§ä¸­:', filePath);
                        }
                    } else {
                        console.log('è·³è¿‡å›¾ç‰‡:', filePath ? 'æ— åŸå§‹è·¯å¾„' : 'ç½‘ç»œå›¾ç‰‡');
                    }
                });
            }

            // åˆå§‹ç›‘æ§
            monitorAllImages();

            // ç›‘å¬æ–°å›¾ç‰‡æ·»åŠ 
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) {
                                const newImages = node.querySelectorAll ? node.querySelectorAll('.image-preview') : [];
                                if (newImages.length > 0 || node.classList?.contains('image-preview')) {
                                    setTimeout(monitorAllImages, 100);
                                }
                            }
                        });
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // é¡µé¢å¸è½½æ—¶æ¸…ç†
            window.addEventListener('beforeunload', () => {
                fileWatchers.forEach(interval => clearInterval(interval));
                fileWatchers.clear();
                lastModifiedTimes.clear();
            });

            // æ·»åŠ æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
            window.refreshAllImages = function() {
                const images = document.querySelectorAll('.image-preview');
                images.forEach(img => {
                    const filePath = img.dataset.filePath;
                    if (filePath) {
                        const timestamp = Date.now();
                        const newSrc = '/api/serve_image?path=' + encodeURIComponent(filePath) + '&t=' + timestamp;
                        img.src = newSrc;
                        showUpdateNotification(img, 'æ‰‹åŠ¨åˆ·æ–°');
                    }
                });
            };
        }

        // èŠå¤©åŒºåŸŸæ»šåŠ¨æ§åˆ¶åŠŸèƒ½ - æ”¹è¿›ç‰ˆ
        function setupChatScrollControl() {
            const chatArea = document.getElementById('chat-area');
            const inputArea = document.querySelector('.input-area');
            const panelLeft = document.querySelector('.panel-left');

            let isScrolling = false;
            let scrollTimeout;
            let autoScrollEnabled = true;

            // ç¡®ä¿è¾“å…¥æ¡†å§‹ç»ˆå¯è§
            function ensureInputVisible() {
                if (!inputArea) return;

                const inputRect = inputArea.getBoundingClientRect();
                const panelRect = panelLeft.getBoundingClientRect();

                // æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦åœ¨é¢æ¿å¯è§†åŒºåŸŸå†…
                if (inputRect.bottom > panelRect.bottom || inputRect.top < panelRect.top) {
                    inputArea.scrollIntoView({
                        behavior: 'smooth',
                        block: 'end',
                        inline: 'nearest'
                    });
                }
            }

            // é¼ æ ‡æ»šè½®æ§åˆ¶ - æ”¹è¿›ç‰ˆï¼ˆæå‡çµæ•åº¦ï¼‰
            chatArea.addEventListener('wheel', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const delta = e.deltaY;
                // å¤§å¹…æå‡æ»šåŠ¨é‡ï¼Œè®©æ»šåŠ¨æ›´çµæ•
                let scrollAmount;

                // æ ¹æ®æ»šåŠ¨å¼ºåº¦å’Œç±»å‹è°ƒæ•´æ»šåŠ¨é‡
                if (Math.abs(delta) > 100) {
                    // å¿«é€Ÿæ»šåŠ¨
                    scrollAmount = 120;
                } else if (Math.abs(delta) > 50) {
                    // ä¸­ç­‰æ»šåŠ¨
                    scrollAmount = 80;
                } else {
                    // æ…¢é€Ÿæ»šåŠ¨
                    scrollAmount = 60;
                }

                // è®¾ç½®æ»šåŠ¨çŠ¶æ€
                isScrolling = true;
                clearTimeout(scrollTimeout);

                // ä½¿ç”¨å³æ—¶æ»šåŠ¨è€Œä¸æ˜¯å¹³æ»‘æ»šåŠ¨ï¼Œæå‡å“åº”é€Ÿåº¦
                if (delta > 0) {
                    // å‘ä¸‹æ»šåŠ¨
                    chatArea.scrollTop += scrollAmount;
                } else {
                    // å‘ä¸Šæ»šåŠ¨
                    chatArea.scrollTop -= scrollAmount;
                }

                // æ˜¾ç¤ºæ»šåŠ¨æŒ‡ç¤ºå™¨
                showScrollIndicator(delta > 0 ? 'down' : 'up');

                // æ£€æŸ¥æ˜¯å¦æ¥è¿‘åº•éƒ¨ï¼Œå†³å®šæ˜¯å¦å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                const isNearBottom = chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 50;
                autoScrollEnabled = isNearBottom;

                // é‡ç½®æ»šåŠ¨çŠ¶æ€
                scrollTimeout = setTimeout(() => {
                    isScrolling = false;
                    hideScrollIndicator();

                    // å¦‚æœæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
                    if (autoScrollEnabled) {
                        setTimeout(ensureInputVisible, 100);
                    }
                }, 150);
            });

            // é”®ç›˜å¯¼èˆªæ”¯æŒ - æ”¹è¿›ç‰ˆ
            document.addEventListener('keydown', function(e) {
                // åªåœ¨èŠå¤©é¢æ¿è·å¾—ç„¦ç‚¹æ—¶å“åº”
                if (!e.target.closest('.panel-left')) return;

                let handled = false;

                switch(e.key) {
                    case 'PageUp':
                        e.preventDefault();
                        chatArea.scrollBy({ top: -chatArea.clientHeight * 0.8, behavior: 'smooth' });
                        handled = true;
                        break;
                    case 'PageDown':
                        e.preventDefault();
                        chatArea.scrollBy({ top: chatArea.clientHeight * 0.8, behavior: 'smooth' });
                        handled = true;
                        break;
                    case 'Home':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollTo({ top: 0, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                    case 'End':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
                            setTimeout(ensureInputVisible, 200);
                            handled = true;
                        }
                        break;
                    case 'ArrowUp':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollBy({ top: -30, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                    case 'ArrowDown':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            chatArea.scrollBy({ top: 30, behavior: 'smooth' });
                            handled = true;
                        }
                        break;
                }

                if (handled) {
                    // æ›´æ–°è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€
                    const isNearBottom = chatArea.scrollTop + chatArea.clientHeight >= chatArea.scrollHeight - 50;
                    autoScrollEnabled = isNearBottom;
                }
            });

            // æ»šåŠ¨æŒ‡ç¤ºå™¨
            function showScrollIndicator(direction) {
                let indicator = document.getElementById('chat-scroll-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'chat-scroll-indicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 50%;
                        right: 30px;
                        background: var(--secondary-color);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 20px;
                        z-index: 1000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                        pointer-events: none;
                        font-size: 14px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    `;
                    document.body.appendChild(indicator);
                }

                indicator.innerHTML = direction === 'down' ?
                    '<i class="fas fa-arrow-down"></i> å‘ä¸‹æ»šåŠ¨' :
                    '<i class="fas fa-arrow-up"></i> å‘ä¸Šæ»šåŠ¨';
                indicator.style.opacity = '0.8';
            }

            function hideScrollIndicator() {
                const indicator = document.getElementById('chat-scroll-indicator');
                if (indicator) {
                    indicator.style.opacity = '0';
                }
            }

            // ç¡®ä¿èŠå¤©åŒºåŸŸå¯ä»¥è·å¾—ç„¦ç‚¹
            chatArea.setAttribute('tabindex', '0');

            // ç‚¹å‡»èŠå¤©åŒºåŸŸæ—¶è·å¾—ç„¦ç‚¹
            chatArea.addEventListener('click', function() {
                chatArea.focus();
            });

            // æ–°æ¶ˆæ¯æ·»åŠ æ—¶çš„æ™ºèƒ½æ»šåŠ¨
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–°æ¶ˆæ¯
                        const addedMessage = Array.from(mutation.addedNodes).find(node =>
                            node.nodeType === 1 && node.classList.contains('message')
                        );

                        if (addedMessage && autoScrollEnabled && !isScrolling) {
                            setTimeout(() => {
                                chatArea.scrollTo({
                                    top: chatArea.scrollHeight,
                                    behavior: 'smooth'
                                });
                                setTimeout(ensureInputVisible, 200);
                            }, 100);
                        }
                    }
                });
            });

            observer.observe(chatArea, { childList: true });

            // çª—å£å¤§å°å˜åŒ–æ—¶ç¡®ä¿è¾“å…¥æ¡†å¯è§
            window.addEventListener('resize', () => {
                setTimeout(ensureInputVisible, 100);
            });

            // åˆå§‹åŒ–æ—¶ç¡®ä¿è¾“å…¥æ¡†å¯è§
            setTimeout(ensureInputVisible, 500);
        }

        // é€šç”¨é€šçŸ¥å‡½æ•°
        function showNotification(message, type = 'info', options = {}) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
            let icon = 'fas fa-info-circle';
            let bgColor = 'var(--primary-color)';

            switch(type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    bgColor = 'var(--accent-color)';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    bgColor = '#e74c3c';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    bgColor = '#f39c12';
                    break;
            }

            let detailsHtml = '';
            if (options.details && options.details.length > 0) {
                detailsHtml = `
                    <div class="notification-details">
                        ${options.details.map(detail => `<div>â€¢ ${detail}</div>`).join('')}
                    </div>
                `;
            }

            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-header">
                        <i class="${icon}"></i>
                        <span>${message}</span>
                        <button class="notification-close" onclick="this.closest('.notification').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${detailsHtml}
                </div>
            `;

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            `;

            document.body.appendChild(notification);

            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // è‡ªåŠ¨éšè—
            const autoHideDelay = options.autoHide !== false ? (options.duration || 5000) : 0;
            if (autoHideDelay > 0) {
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, autoHideDelay);
            }

            // è¿”å›é€šçŸ¥å…ƒç´ ï¼Œä»¥ä¾¿å¤–éƒ¨æ§åˆ¶
            return notification;
        }

        // æµ‹è¯•å›¾ç‰‡åŠ è½½åŠŸèƒ½
        function testImageLoad() {
            console.log('å¼€å§‹æµ‹è¯•å›¾ç‰‡åŠ è½½åŠŸèƒ½');

            // åˆ›å»ºæµ‹è¯•å›¾ç‰‡æ•°æ®
            const testImageData = {
                id: Date.now(),
                title: 'æµ‹è¯•å›¾ç‰‡ (test.png)',
                data: {
                    image_url: '/api/serve_image?path=test_images/test.png',
                    file_name: 'test.png',
                    file_size: '584 B',
                    file_path: 'test_images/test.png',
                    width: 200,
                    height: 200
                }
            };

            console.log('åˆ›å»ºæµ‹è¯•å›¾ç‰‡å¡ç‰‡:', testImageData);
            createImageCard(testImageData);

            // æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
            const notification = document.createElement('div');
            notification.textContent = 'å·²æ·»åŠ æµ‹è¯•å›¾ç‰‡ï¼Œè¯·æŸ¥çœ‹åŠ è½½çŠ¶æ€';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                padding: 10px 20px;
                border-radius: 4px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.style.opacity = '1', 10);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // æµ‹è¯•å›¾ç‰‡ç›‘æ§åŠŸèƒ½
        function testImageMonitor() {
            console.log('å¼€å§‹æµ‹è¯•å›¾ç‰‡ç›‘æ§åŠŸèƒ½');

            // åˆ›å»ºç›‘æ§æµ‹è¯•å›¾ç‰‡æ•°æ®
            const testImageData = {
                id: Date.now(),
                title: 'ç›‘æ§æµ‹è¯•å›¾ç‰‡ (monitor_test.png)',
                data: {
                    image_url: '/api/serve_image?path=test_images/monitor_test.png',
                    file_name: 'monitor_test.png',
                    file_size: '584 B',
                    file_path: 'test_images/monitor_test.png',
                    width: 200,
                    height: 200
                }
            };

            console.log('åˆ›å»ºç›‘æ§æµ‹è¯•å›¾ç‰‡å¡ç‰‡:', testImageData);
            createImageCard(testImageData);

            // æ˜¾ç¤ºæµ‹è¯•ä¿¡æ¯
            showNotification('å·²æ·»åŠ ç›‘æ§æµ‹è¯•å›¾ç‰‡', 'info', {
                details: [
                    'å›¾ç‰‡è·¯å¾„: test_images/monitor_test.png',
                    'ç›‘æ§é—´éš”: 1.5ç§’',
                    'è¯·ä¿®æ”¹è¯¥å›¾ç‰‡æ–‡ä»¶æ¥æµ‹è¯•è‡ªåŠ¨æ›´æ–°åŠŸèƒ½'
                ],
                duration: 8000
            });

            // 5ç§’åè‡ªåŠ¨æ›´æ–°å›¾ç‰‡æ¥æ¼”ç¤ºç›‘æ§åŠŸèƒ½
            setTimeout(() => {
                fetch('/api/update_test_image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: 'test_images/monitor_test.png',
                        color: 'red'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('æµ‹è¯•å›¾ç‰‡å·²è‡ªåŠ¨æ›´æ–°', 'success', {
                            details: ['å›¾ç‰‡é¢œè‰²å·²æ”¹ä¸ºçº¢è‰²', 'è¯·è§‚å¯Ÿå›¾ç‰‡æ˜¯å¦è‡ªåŠ¨åˆ·æ–°']
                        });
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°æµ‹è¯•å›¾ç‰‡å¤±è´¥:', error);
                });
            }, 5000);
        }

        // æµ‹è¯•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        function testImageUpload() {
            console.log('å¼€å§‹æµ‹è¯•å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½');

            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';

            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log('é€‰æ‹©çš„æ–‡ä»¶:', file.name, file.size, 'bytes');
                    handleImageFile(file);
                }
                // æ¸…ç†ä¸´æ—¶å…ƒç´ 
                document.body.removeChild(fileInput);
            };

            // æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
            document.body.appendChild(fileInput);
            fileInput.click();

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showNotification('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•', 'info', {
                details: [
                    'æ”¯æŒæ ¼å¼: PNG, JPG, JPEG, GIF, BMP, WEBP',
                    'æœ€å¤§å¤§å°: 100MB',
                    'ä¸Šä¼ åæ”¯æŒåˆ·æ–°å’Œç›‘æ§åŠŸèƒ½'
                ]
            });
        }
    </script>
    
    <script>
    window.difyChatbotConfig = {
    token: '40RIQ28SQ21P3Ync',
    baseUrl: 'http://localhost',
    systemVariables: {
        // user_id: 'YOU CAN DEFINE USER ID HERE',
        // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
    },
    userVariables: {
        // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
        // name: 'YOU CAN DEFINE USER NAME HERE',
    },
    }
    </script>
    <script
    src="http://localhost/embed.min.js"
    id="40RIQ28SQ21P3Ync"
    defer>
    </script>
    <style>
    #dify-chatbot-bubble-button {
        background-color: #1C64F2 !important;
    }
    #dify-chatbot-bubble-window {
        width: 24rem !important;
        height: 40rem !important;
    }
    </style>
</body>
</html>

